[{"authors":[],"categories":[],"content":"\n行星與地球都是圍繞太陽運動的，而這種運動在地球上看來則是相當複雜的。上面這種圖是行星、地球、太陽之間相互位置的示意圖。中間橘色的點代表太陽，下面藍色的點代表地球；實線表示地球軌道，點線代表內行星（水星、金星）的軌道，虛線代表外行星（火星、木星、土星）的軌道。內行星水星、金星的軌道在地球與太陽之間。當內行星運行到地球與太陽的連線或連線的延長線上時，也就是內行星與地球、太陽形成一條直線時，由於內行星靠近太陽，所以在地球上看不到內行星，這就叫做伏；而從內行星、地球、太陽三者位置的相對關係來說，如果內行星在遠離地球的一側，就叫上合，而當內行星在地球和太陽中間時，就叫下合。所謂大距，指的是地球上看起來，內行星距離太陽的距離最大的時候。當內行星在太陽東邊時，就叫東大距；在太陽西邊時，就叫西大距。西大距出現在早上，而東大距出現在傍晚。三統曆叫做晨見與夕見。因此在內行星的運行中，有兩次伏。一次是內行星運行到地球和太陽之間時，即下合時；另一次則是內行星運行到地球和太陽連線的延長線上時，即上合時。而對於外行星，由於外行星的軌道在地球之外，所以外行星會有兩次運行到地球和太陽連線的延長線上，一次靠近地球，另一次靠近太陽。靠近地球的那一次稱爲“衝”（opposition）。因爲這時行星正對着太陽，就如月亮在望日正對着太陽一樣，是最適於觀測外行星的時候。而在靠近太陽的那次，外行星就會被太陽的光芒掩蓋，地球上就看不到了。這就是外行星的伏；就行星、地球、太陽的位置關係而言叫“上合”（superior conjunction）。行星的這種運行是週期性的，例如外行星由一次上合到下一次上合是一個完整的週期。行星的這種運行週期就叫做一個會合週期（synodic cycle），在三統曆中叫做“一見”，這個週期的時長就叫見數，也就是紀母中的見中法。\n紀術與統術不同。統術在推天地元統中算出入統年之後，其他計算只要用入統年就可以了，而所有的紀術計算都依賴於距太極上元年數。這是因爲太極上元是日月、五星的共同週期，要計算五星運行的時間，必須從太極上元算起。另外，紀術與統術不同，統術每個計算只要算一次，而紀術每種都可以算五次，每個行星一次（除了推晨見加夕，這一運算只有金星、水星能算）。\n紀術部分從推五星見復到推入月日數，其實都是求一個事件的時間，就是星見。紀術分別計算了星見所在年份（推五星見復）、中氣、十二次（推星所見中次）、所在月份（推星見月）、所在中氣首日（推至日）、當月朔日（推朔日）、所在中氣日數（推入中）、所在月的第幾天（推入月日數）。除了推算本次星見時間外，還可以推算下一次星見時間，這就是推後見中（推算下一次星見所在中氣）、推後見月（推算下一次星見所在月份）的內容。\n紀術部分所用的基本已知數也只有一個，就是太極上元以來年數，其他運算所用已知數都是從這個數值推算出來的。下圖展示了紀術各部分之間的關係與所用已知數。\n因爲紀術裏的用語有些與紀母不同，這裏稍加說明。紀母中的見中法，在紀術中叫做見復數，又叫做大統見復數。\n推五星見復 推五星見復，置太極上元以來，盡所求年，乘大統見復數，盈歲數得一，則定見復數也。不盈者名曰見復餘。見復餘盈其見復數，一以上見在往年，倍一以上，又在前往年，不盈者在今年也。\n所謂見復就是五星經過一個週期之後在天空中出現，而見復數就是五星出現的週期，也就是見中法，這裏叫做大統見復數。設所求年距太極上元年數爲 $x$，所求的行星歲數爲 $p$，行星見復數爲 $m$。\n$$ \\begin{align*} \\text{一見復時間}\u0026amp;=\\text{行星歲數} \\div \\text{見復數}\\\\ \u0026amp;=\\frac{p}{m}\\\\ x\\ \\text{年見復數}\u0026amp;=x \\div \\frac{p}{m}\\\\ \u0026amp;=(xm \\ \\mathbf{div}\\ p) \\frac{xm \\ \\mathbf{mod}\\ p}{p}\\\\ \u0026amp;=\\text{定見復數} \\frac{見復餘}{p}\\\\ \\text{定見復數}\u0026amp;=xm \\ \\mathbf{div}\\ p\\\\ \u0026amp;=(\\text{距上元年數} \\times \\text{見復數}) \\ \\mathbf{div}\\ \\text{歲數}\\\\ \\text{見復餘}\u0026amp;=xm \\ \\mathbf{mod}\\ p\\\\ \u0026amp;=(\\text{距上元年數} \\times \\text{見復數}) \\ \\mathbf{mod}\\ \\text{歲數} \\end{align*} $$\n行星見復可以由見復餘與見復數的關係確定。假如見復餘大於見復數，但是小於見復數的兩倍，那行星見復就出現在所求年的前一年；而如果見復餘大於見復數的兩倍，但小於見復數的三倍，那行星見復就出現在所求年的前兩年。用代碼寫出來就是：\ndef tuiJianfu(x, jianfuShu, suiShu): \u0026quot;\u0026quot;\u0026quot; 推五星見復：由距上元年數 x，求五星見復出現年數 Args: x: 距上元年數 jianfuShu: 見復數，即見中法 suiShu: 歲數 Returns: jianfu: 見復，1 在今年，2 在去年，3 在前年 jianfuYu: 見復餘 dingJianfu: 定見復數 \u0026quot;\u0026quot;\u0026quot; dingJianfu = (x * jianfuShu) // suiShu jianfuYu = (x * jianfuShu) % suiShu if jianfuShu \u0026lt; jianfuShu: jianfu = 1 # 見復在本年 elif jianfuShu \u0026gt;= jianfuShu and jianfuShu \u0026lt; 2 * jianfuShu: jianfu = -1 # 見復在去年 elif jianfuShu \u0026gt;= 2 * jianfuShu and jianfuShu \u0026lt; 3 * jianfuShu: jianfu = -2 # 見復在前年 return jianfu, jianfuYu, dingJianfu 推星所見中次 推星所(一多「在」字)見中次，以見中分乘定見復數，盈見中法得一，則積中法也。不盈者名曰中餘。以元中除積中，餘則中元餘也。以章中除之，餘則入章中數也。以十二除之，餘則星見中次也。中數從冬至起，次數從星紀起，算外，則星所見中次也。\n這一條是求行星出現時刻在當年的哪個中氣內，與出現在十二次的哪一次。具體計算步驟是：\n計算出上元以來的所有中氣數：$\\text{定見復數} \\times \\frac{\\text{見中分}}{\\text{見中法}} = \\text{積中} \\frac{中餘}{見中法}$ 計算出中元餘，也就是不足一個元中的中氣餘數：$中元餘 =\\text{積中} \\ \\mathbf{mod}\\ \\text{元中}$。這裏要用到一元的中氣數 55404，即統母中的元中。 計算出入章中數，也就是不足一個章中的中氣餘數：$\\text{入章中數}=\\text{中元餘} \\ \\mathbf{mod}\\ \\text{章中}$。章中是一章的中氣數，也見統母。 計算出星見中次，也就是五星見在十二次的哪一次：$\\text{星見中次} \\text{入章中數} \\ \\mathbf{mod}\\ 12$ 以所得星見中次，從冬至開始數，就是星所見中氣；從星紀開始數，就是星所見次。注意，仍然是以冬至/星紀爲 0 開始數。 設距上元年數爲 $x$，見復數（見中法）爲 $m$，歲數爲 $p$，定見復數爲 $d$。計算出上元以來的所有中氣數，也就是定見復數內總中氣數，將它轉換成帶分數，就可以算出積中、中餘：\n$$ \\begin{align*} \\text{定見復數}\u0026amp;=(\\text{距上元年數} \\times 見復數) \\ \\mathbf{div}\\ \\text{歲數})\\\\ \u0026amp;= xm \\ \\mathbf{mod}\\ p\\\\ \\text{一見復數年數}\u0026amp;=\\frac{歲數}{見復數}\\\\ \u0026amp;=\\frac{p}{m}\\\\ \\text{定見復數年數}\u0026amp;=\\text{定見復數} \\times \\text{一見復數年數}\\\\ \u0026amp;=\\text{定見復數}\\times \\frac{歲數}{見復數}\\\\ \u0026amp;=\\text{d} \\times \\frac{p}{m}\\\\ \\text{一年中氣數}\u0026amp;=12\\\\ \\text{歲數} \\times 12 \u0026amp;= \\text{見中分}\\\\ \\text{定見復數總中氣數}\u0026amp;=\\text{定見復數總年數} \\times \\text{一年中氣數}\\\\ \u0026amp;=\\text{d} \\times \\frac{p}{m} \\times 12\\\\ \u0026amp;=\\text{d} \\times \\frac{\\text{見中分}}{m}\\\\ \u0026amp;=(d \\times \\text{見中分} \\ \\mathbf{div}\\ m) \\frac{d \\times \\text{見中分} \\ \\mathbf{mod}\\ m}{m}\\\\ \u0026amp;=\\text{積中} \\frac{中餘}{m}\\\\ \\text{積中}\u0026amp;=d \\times \\text{見中分} \\ \\mathbf{div}\\ m\\\\ \\text{中餘}\u0026amp;=d \\times \\text{見中分} \\ \\mathbf{mod}\\ m \\end{align*} $$\n要求星見中次，只要以積中除元中、章中、十二次/氣，求得各自的餘數就可以了。也就是：\n$$\\text{星見中次} = \\text{積中} \\ \\mathbf{mod}\\ \\text{元中} \\ \\mathbf{mod}\\ \\text{章中} \\ \\mathbf{mod}\\ 12$$\n推星見月 推星見月，以閏分乘定見，以章歲乘中餘從之，盈見月法得一，并積中，則積月也。不盈者名曰月中餘。以元月除積月餘，名曰月元餘。以章月除月元餘，則入章月數也。以十二除之，至有閏之歲，除十三。1入章三歲一閏，六歲二閏，九歲三閏，十一歲四閏，十四歲五閏，十七歲六閏，十九歲七閏。不盈者數起於天正，算外，則星所見月也。\n上一段已經求得行星始見所在中氣和十二次，這一段則是求新會合週期開始時星始見的月份。三統曆用了三個步驟：\n求定見復數期間總月數 根據積月求出星見在本章的哪月 減去本章不計閏月的月數（每年十二）、閏月數（入章三年一個閏月，六年兩個，九年三個，十一年四個，十四年五個，十七年六個，十九年七個），算出星見在本年的哪個月 首先求定見復數期間所有的朔望月數目。三統曆將朔望月分爲閏月和一般的一年十二個月。所以要求定見復數期間所有的朔望月數目，只要將定見復數期間所有閏月和定見復數期間所有 12 個月（非閏月）加起來就可以了。根據紀母部分的見閏分（這裏叫做閏分），一個會合週期，也就是歲數中有 $\\text{見閏分} = \\text{歲數} \\times \\frac{7}{19}$ 個閏月，而一見的閏月數就是：$\\frac{歲數 \\times 7}{見中法 \\times 19}$。一年的非閏月數與中氣數一樣，都是 12，所以定見復數期間所有的不含閏月的朔望月數目與這期間所有的中氣數是一樣的。上一部分“推星所見中次”已經求出定見復數期間的積中和中餘了，將這個數字加上閏月數就是定見復數期間所有朔望月數目。寫成算式就是：\n$$ \\begin{align*} \\text{定見復數總閏月數}\u0026amp;=\\frac{\\text{閏分}}{\\text{見月法}} \\times \\text{定見復數}\\\\ \\text{定見復數不計閏月總月數} \u0026amp;=\\text{定見復數總中氣數}\\\\ \u0026amp;=\\text{積中} \\frac{中餘}{見中法}\\\\ \\text{定見復數總月數}\u0026amp;=\\text{定見復數總閏月數} + \\text{定見復數不計閏月總月數}\\\\ \u0026amp;=\\frac{\\text{閏分} \\times \\text{定見復數}}{\\text{見月法}} + \\text{積中} \\frac{\\text{中餘}}{\\text{見中法}}\\\\ \u0026amp;=\\frac{\\text{閏分} \\times \\text{定見復數} + \\text{中餘} \\times 19}{\\text{見月法}} + \\text{積中}\u0026amp; \\text{見月法} = 19 \\times \\text{見中法}\\\\ \u0026amp;= \\text{積月} \\frac{月餘}{見月法} \\end{align*} $$\n與上一部分“推星所見中次”一樣，先要將積月除以元月、章月，求出月元餘、入章月數。由於在一章中有些年份有閏月有些年份沒有，並不是每年都是十二個月，所以求出了入章月數，並不能立即得出該月在一章之中的哪年、哪個月，還需要從入章月中減去累積的月數，這都要按照統術部分“推閏餘”所列出的表格來。每逢一章中的第 3、6 、9、11、14、17、19 年，就要減去十三個月，再根據不足一年的月數求出星見在本年的哪月。\n$$ \\begin{align*} \\text{月元餘}\u0026amp;=\\text{積月} \\ \\mathbf{mod}\\ \\text{元月}\\\\ \u0026amp;=\\text{積月} \\ \\mathbf{mod}\\ 57105\\\\ \\text{入章月數}\u0026amp;=\\text{月元餘} \\ \\mathbf{mod}\\ \\text{章月}\\\\ \u0026amp;=\\text{積月} \\ \\mathbf{mod}\\ 57105 \\ \\mathbf{mod}\\ 235\\\\ \\end{align*} $$\n推至日 推至日，以中法乘中元餘，盈元法得一，名曰積日，不盈者名曰小餘。小餘盈二千五百九十七以上，中大。數除積日如法，算外，則冬至也。\n這一段以“推至日”爲名，從字面上看應該是求冬至日的干支日名，但是從所述算法來看，實際是求星見所在中氣的干支日名。《中國古代曆法》認爲“推至日”應該是“推中日”之誤。這裏仍用推至日的名字，但是所求未知數是星見所在中氣的干支日名。這裏要用到的已知數是“推星所見中次”中求出的中元餘。\n在“推星所見中次”中已經求出從上元到星見期間累積的中氣數，而中元餘就是星見所在元中累積的中氣數。在“三統曆基本時間單位”中已經求出一個中氣的時間長度是 $30 \\frac{2020}{4617} = \\frac{140530}{4617}=\\frac{\\text{中法}}{元法}$，那將中元餘乘以一個中氣的長度就是在當前元中到星見所在中氣時累積日數，也就是：\n$$ \\begin{align*} \\text{入元來到當前中氣日數}\u0026amp;=\\frac{\\text{中元餘} \\times \\text{中法}}{\\text{元法}}\\\\ \u0026amp;=\\text{積日}\\frac{小餘}{元法}\\\\ \\text{氣首日名}\u0026amp;=\\text{積日} \\ \\mathbf{mod}\\ 60 \\end{align*} $$\n而求當前中氣所在日期的干支日名就是求積日大餘，並在干支表中數出對應干支即可。\n推朔日 推朔日，以月法乘月元餘，盈日法得一，名曰積日，餘名曰小餘。小餘三十八以上，月大。數除積日如法，算外，則星見月朔日也。\n這一段是求星見之月的朔日干支，所用已知數是“推星見月”中求出的月元餘，也就是入元以來的月數。月元餘乘以一月日數 $\\frac{2392}{81} = \\frac{月法}{日法}$ 就是從入元以來到星見月的所有日數。再以積日求出積日大餘就知道當月朔日的干支日名了。\n$$ \\begin{align*} \u0026amp;\\ \\ \\ \\ \\ \\text{月元餘} \\times \\frac{\\text{月法}}{\\text{日法}}\\\\ \u0026amp;=\\text{月元餘} \\times \\frac{2392}{81}\\\\ \u0026amp;=\\text{積日}\\frac{小餘}{81}\\\\ \\text{朔日}\u0026amp;=\\text{積日} \\ \\mathbf{mod}\\ 60 \\end{align*} $$\n推入中、次日度數 推入中次日度數，以中法乘中餘，以見中法乘其小餘并之，盈見中日法得一，則入中日入次度數也。中次至日數，次以次初數，算外，則星所見及日所在度數也。求夕，在日後十五度。\n求星見所入中氣之後的日數，以及星見在所入十二次的度數。在推星所在中次部分，以及算出星見時刻不足一個中氣的時長是 $\\frac{\\text{中餘}}{\\text{見中法}}$。要求星見所入中氣之後的日數，只要將這個數值轉換成日數就可以了，也就是將這個數值乘以一個中氣的日數（參見表格：三統曆基本時間單位年月日時長 ）：\n$$\\frac{中餘}{見中法}\\times \\frac{中法}{元法}$$\n但是星見所在中氣並非一定在夜半，所以將這個數值轉換成日數之後，還需要加上星見所在中氣距夜半的時段。這個時段已經在推至日部分算出來了，也就是入元來日數除去積日的分數部分，即 $\\frac{小餘}{元法}$。上一個數值與這個數值相加，就是：\n$$ \\begin{align*} \u0026amp;\\frac{中餘}{見中法}\\times \\frac{中法}{元法} + \\frac{小餘}{元法}\\\\ =\u0026amp;\\frac{中餘 \\times 中法 + 小餘 \\times 見中法}{見中法 \\times 元法}\\\\ =\u0026amp;\\frac{中餘 \\times 中法 + 小餘 \\times 見中法}{見中日法} \\end{align*} $$\n其中，見中日法 $= 見中法 \\times 元法$，參見紀母表。將這個數字化爲帶分數，假如整數部分是 0，那星見就中氣首日，也就是中氣當天。\n推入月日數 推入月日數，以月法乘月餘，以見月法乘其小餘并之，盈見月日法得一，則入月日數也。并之大餘，數除如法，則見日也。\n這一段是求星見在所在月的日數，所用的已知數是“推星見月”中求出的月元餘、“推朔日”中求出的積日小餘。以月餘乘以一月日數 $\\frac{2392}{81} = \\frac{月法}{日法}$，再加上朔日小餘就是星見當日的日數。\n$$ \\begin{align*} \u0026amp;\\frac{月餘}{見月法}\\times \\frac{月法}{81} + \\frac{小餘}{81}\\\\\\ =\u0026amp;\\frac{月餘}{見月法}\\times \\frac{月法}{81} + \\frac{小餘 \\times 見月法}{81 \\times 見月法}\\\\\\ =\u0026amp;\\frac{月餘 \\times 月法 + 小餘 \\times 見月法}{81 \\times 見月法}\\\\\\ =\u0026amp;\\frac{月餘 \\times 月法 + 小餘 \\times 見月法}{見月日法} \\end{align*} $$\n將求得的數化爲帶分數，再加上朔日大餘，就是星見當天的干支日名了。如果二者加起來超過 60，求二者之和除以 60 的餘數，也就是星見日大餘，就可以求得當天的干支序數了。\n推後見中、後見月 推後見中，加積中於中元餘，加後餘於中餘，盈其法得一，從中元餘，數如法，則見也。\n這一段是計算下一次星見所在的中氣。本次星見的積中和中餘已經在推星所見中次中求得，那下一次星見所在中氣只要加上一見所含中氣的積中和中餘就可以得到了。星見一次所含中氣次數爲 $\\frac{見中分}{見中法} = 積中 \\frac{中餘}{見中法}$。爲了區分本次星見的積中和中餘與一見的積中和中餘，《中國古代曆法》中將一見的積中和中餘叫做見中和見中餘。也就是說，下次星見所在的中氣數爲：\n$$ \\begin{align*} \u0026amp;\\text{本次星見積中中餘} + \\text{一見的積中和中餘}\\\\ =\u0026amp;\\text{積中}\\frac{中餘}{見中法} + \\text{見中} \\frac{見中餘}{見中法}\\\\ \\end{align*} $$\n要求下一次星見中次，只要以求得的下一次積中除元中、章中、十二次/氣，求得各自的餘數就可以了。\n推後見月，加積月於月元餘，加後月餘於月餘，盈其法得一，從月元餘，除數如法，則後見月也。\n推下一次星見所在的月份，與推後見中一樣，以推星見月部分求出的月元餘、月餘加上一見的積月、月餘（紀母中的積月和月餘，《中國古代曆法》稱之爲見月、見月餘），以求得下一次星見的積月、月餘，按照推星見月後半部分的計算，就可以求得下一次星見所在月份了。也就是：\n$$ \\begin{align*} \u0026amp;\\text{本次星見積月月餘} + \\text{一見的積月和月餘}\\\\ =\u0026amp;\\text{月元餘}\\frac{月餘}{見月法} + \\text{見月} \\frac{見月餘}{見月法}\\\\ =\u0026amp;(月元餘 + 見月) \\frac{月餘 + 見月餘}{見月法} \\end{align*} $$\n推至日及入中次度數，如上法。\n推朔日及入月數，如上法。\n推晨見加夕，夕見加晨，皆如上法。\\\n要計算下一次星見的至日、入中次度數、朔日與入月數，只要加上五星一見的積中、中餘、積月、月餘就可以了。而計算金星、水星的晨見、夕見，也只要加上晨見或夕見的積中、中餘、積月、月餘。\n推五步 推五步，置始見以來日數，至所求日，各以其行度數乘之。其星若日有分者，分子乘全為實，分母為法。其兩有分者，分母分度數乘全，分子從之，令相乘為實，分母相乘為法，實如法得一，名曰積度。數起星初見星宿所在宿度，算外，則星所在宿度也。\n求星見之後某天星所在宿度。在紀母之後的五步部分，三統曆已經給出了五大行星的運行軌跡和運行不同階段的日數與日行度數。因此，只要知道了五星始見的位置，也就是星度，就是上面“推入中次日度數”部分所求出十二次度數，再對照五大行星在各個階段停留的日數與日行度數，就可以算出相應時間行星所在的位置。這裏所說的只是整數相乘、整數與分數相乘、分數與分數相乘的辦法，而沒有解釋推五步的具體辦法。\n參考文獻 錢大昕. 三統術衍. 自“夫曆春秋者”始。 張培瑜、陳美東、薄樹人和胡鐵珠. (2008). 中国古代历法.中国科学出版社. 劉操南. (2009). 古代天文曆法釋證. 浙江大學出版社. 劉洪濤. (2003). 古代曆法計算法. 南開大學出版社. 夏國強. (2015). 《漢書·律曆志》研究. 花木蘭文化出版社. 劉洪濤認爲應該在十三後點斷，是。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2025-12-lvlizhi5/","series":[],"tags":[],"title":"《漢書·律曆志》筆記（5）：紀術"},{"authors":[],"categories":[],"content":"統術是三統曆的基本曆法計算方法，可以用來計算一年在三統中的位置，該年天正月朔日的干支名稱（也就是日名）、冬至日和其他所有節氣的日名，以及本年是否需要置閏和在哪一個月置閏。除此之外，統術還包括計算天正月朔日日月所在星度、月食時刻等方法。三統曆以建子月，也就是夏正十一月爲曆法的起始，也是每年的第一個月，稱之爲天正。《律曆志》說：\n其於三正也，黃鐘子為天正，林鐘未之衝丑為地正，太族寅為人正。\n天正建子，以夏正十一月爲正月；地正建丑，以夏正十二月爲正月；人正建寅，以夏正正月爲正月。所以地正比天正晚一個月，人正比天正晚兩個月。但是除了在推天正、地正、人正中，一般都只以天正建子、夏正十一月爲一年的第一個月。所謂朔日，就是建子月的第一天。求閏月，也是從建子月開始。例如上一部分所舉的十九年一章中的第三年有閏九月，這個閏九月是從建子月，也就是夏正十一月開始數的。\n統術各部分其實都是以已知數推求未知數的題目；所用數據有兩項，一項是常數，也就是統母中所列的數據，另一項是已知數，也就是由統術其他部分得出的結果。最基本的已知數其實只有一個數值，就是所求年距太極上元的年數，其他已知數都可以從該數求出。下表列出統術各項計算所用常數（統母）、已知數與所求數。其中太極上元以來年數爲 $x$，入統歲數爲 $n$。\n統術 所用常數 已知數 所求數 公式 推日月元統 元法、統法 太極上元以來年數 統數，入統歲數 $x \\ \\mathbf{mod}\\ \\text{元法}\\ \\mathbf{mod}\\ \\text{統法}$ 推天正 章月、章歲 入統歲數 積月、閏餘 $\\text{積月} = n \\times \\text{章月} \\ \\mathbf{div}\\ \\text{章歲}$\\ $\\text{閏餘} = n \\times \\text{章月} \\ \\mathbf{mod}\\ \\text{章歲}$ 推正月朔 月法、日法、統首日 積月 積日、小餘、朔日干支 $\\text{積日}=\\text{積月} \\times \\text{月法} \\ \\mathbf{div}\\ \\text{日法}$\\ $\\text{積日小餘}=\\text{積月} \\times \\text{月法} \\ \\mathbf{mod}\\ \\text{日法}$\\ $\\text{積日大餘}=\\text{積日} \\ \\mathbf{mod}\\ \\text{60}$ 推閏餘 章中 閏餘 $(章中 - 12 \\times 閏餘) \\ \\mathbf{mod}\\ 7 + 1$ 推冬至 策餘、統法、統首日 入統年 冬至大餘、小餘、干支 $大餘 = (入統年 \\times 策餘) \\ \\mathbf{div}\\ 統法$\\ $小餘 = (入統年 \\times 策餘) \\ \\mathbf{mod}\\ 統法$ 推五行 統法（歲） 推合晨所在星 統法、周天 積日、積日小餘 合晨度 推其日夜半所在星 章歲、統法 月小餘（積日小餘）、合晨度 日夜半星度 推其月夜半所在星 月周、統法 月小餘（積日小餘）、合晨度 月夜半星度 推諸加時 小餘、各盈分母 加辰 推月食 下面這張圖展示了統術所用的已知數、統術所求的未知數，以及相互之間的關係。其中方框中的是統術的名稱，而橢圓中的是統術所用的已知數或所求的未知數。\n統術部分只給出最終的公式計算方法，而略過了計算原理與中間步驟，爲求明晰，下面的解釋列出所有演算步驟。\n推日月元統 推日月元統，置太極上元以來，外所求年，盈元法除之，餘不盈統者，則天統甲子以來年數也。盈統，除之，餘則地統甲辰以來年數也。又盈統，除之，餘則人統甲申以來年數也。各以其統首日為紀。\n推日月元統是通過本年距上元年數計算出本年在三統中屬於第幾元第幾統第幾年。三統曆一元 4617 年，即元法；分一元爲天統甲子、地統甲辰、人統甲申，即三統，每統 1539 年。\n假設本年距上元年數 $x$，則：\n本年所在元數：$$x\\ \\mathbf{div}\\ 4617$$ 本年所在統數：$$x\\ \\mathbf{mod}\\ 4617\\ \\mathbf{div}\\ 1539$$ 本年所在統數內年數：$$x\\ \\mathbf{mod}\\ 4617\\ \\mathbf{mod}\\ 1539$$\n用 python 寫出來就是：\nn % 4617 // 1539 # 本年所在統數，0 天統，1 地統，2 人統 n % 4617 % 1539 # 本年所在統數內年數 例如，伐紂之年距上元 142109 年，該年所在元數爲 $142109 \\ \\mathbf{div}\\ 4617 = 30$，所在統數爲 $142109 \\ \\mathbf{mod}\\ 4617 \\ \\mathbf{div}\\ 1539 = 3$，也就是人統甲申；該年在人統年數爲 $142109 \\ \\mathbf{mod}\\ 4617 \\ \\mathbf{mod}\\ 1539 = 521$，也就是本年入人統甲申第 521 年。\n推天正、地正、人正 推天正，以章月乘人[入]統歲數，盈章歲得一，名曰積月，不盈者名曰閏餘。閏餘十二以上，歲有閏。求地正，加積月一；求人正，加二。\n根據入統年數計算天正、地正、人正。其實就是計算本年有沒有閏月。如果閏餘大於 12，本年就有閏月。三統曆一章 19 歲，一章總共 $19 \\times 12 + 7 = 235$ 個月，每年 $235 \\div 19 = \\frac{235}{19} = 12 \\frac{7}{19}$ 個月。假設入統年數爲 $n$，則該年積月 $n \\times 12 \\frac{7}{19}$，將這個數化爲帶分數，帶分數的分子部分稱之爲閏餘。如果該年閏餘大於 12，則本年需要置閏。寫成算式就是：\n入統年數 $n$ 乘以一年月數，化爲帶分數：\n$$ \\begin{align*} \u0026amp;n \\times \\frac{235}{19}\\\\ =\u0026amp; (n \\times 235)\\ \\mathbf{div}\\ 239 \\frac{(n\\times235)\\ \\mathbf{mod}\\ 19}{19} \\end{align*} $$\n$$$$\n寫成代碼就是：\nn * 235 // 19 # 積月 n * 235 % 19 # 閏餘 由於天正以建子（十一月）爲一年起點，所以如果用的是地正建丑，以十二月爲一歲起點，那積月就要加一；而人正建寅，以正月爲起點，積月要加二。\n已知伐紂之年爲人統甲申第 521 年，則本年積月 $521 \\times 235 \\ \\mathbf{div}\\ = 6443$ 月，閏餘 $521 \\times 235 \\ \\mathbf{mod}\\ 19 = 18$，閏餘大於 12，所以本年是閏年。\n推正月朔、求其次月、求（正月）弦、望 推正月朔，以月法乘積月，盈日法得一，名曰積日，不盈者名曰小餘。小餘三十八以上，其月大。積日盈六十，除之，不盈者名曰大餘。數從統首日起，算外，則朔日也。\n求其次月，加大餘二十九，小餘四十三。小餘盈日法得一，從大餘，數除如法。求弦，加大餘七，小餘三十一。求望，倍弦。\n這一段分爲兩部分。第一部分推正月朔是由已知年數的總月數（積月）求該年天正月朔日（建子月初一）的干支名稱。積月已經在上一部分推天正求出了。積月乘以一月日數 $29 \\frac{43}{81}$，將這個數化爲帶分數，帶分數的整數部分就是積日，即入統以來總共有多少天。再將積日除以干支週期數 60，用所得小餘從統首日數起就是本年正月朔日所在干支。\n上一部分已經算出積月，即 $n \\times 235 \\ \\mathbf{div}\\ 19$，設積月爲 $j$，這裏用積月算出積日和積日小餘，再用積日除以干支週期，所得餘數就是積日大餘。\n$$ \\begin{align*} \\text{積月} \\times \\frac{\\text{月法}}{\\text{日法}} \u0026amp;=j \\times \\frac{2392}{81}\\\\ \u0026amp;= ((j \\times 2392)\\ \\mathbf{div}\\ 81) \\frac{j \\times 2392 \\ \\mathbf{mod}\\ 81}{81}\\\\ \u0026amp;= \\text{積日} \\frac{積日小餘}{81}\\\\ \\text{積日大餘}\u0026amp;=\\text{積日}\\ \\mathbf{mod}\\ 60 \\end{align*} $$\n寫成代碼就是：\n# 入統第 n 年的積日，tongshouri 爲統首日干支，天統甲子，地統甲辰，人統甲申 def tuiZhengyueshuo(n, tongshouri): jiri = ((n * 235 // 19) * 2392).numerator // 81 # 入統第 n 年積日 jirixiaoyu = ((n * 235)// 19 * 2392) % 81 # 積日小餘 jiridayu = jiri % 60 # 積日大餘 # 本年朔旦干支 shuoriGanzhi = ganzhi[ganzhi.index(tongshouri) + jiridayu] return jiri, jirixiaoyu, shuoriGanzhi 伐紂入人統甲申 521 年，該年積日 190267 日，天正月朔日爲辛卯日。\n第二部分，求其次月。因爲推正月朔已經求出當月的積日大餘與積日小餘，所以這裏再加上一個月的月長。如果本月的積月小餘加 43 大於 81，就說明下月大，次月大餘要加一；否則次月小。\n$$ \\begin{align*} \\text{次月大餘} \u0026amp;=\\text{積日大餘} + 29 + (\\text{積日小餘} + 43)\\ \\mathbf{div}\\ 81\\\\ \\text{次月小餘} \u0026amp;=(\\text{積日小餘} + 43)\\ \\mathbf{mod}\\ 81 \\end{align*} $$\n自本月朔日到上弦日，爲一月的四分之一，也就是 $29 \\frac{43}{81} \\div 4 = 7 \\frac{31}{81}$；而朔日到望日就是一月的一半，即 $29 \\frac{43}{81} \\div 2 = 14 \\frac{62}{81}$。要求本月的弦或望只要用本月積日大小餘分別加上相應的弦望大小餘就可以了。\n$$ \\begin{align*} \\text{弦日大餘}\u0026amp;=\\text{積日大餘} + 7\\\\ \\text{弦日小餘}\u0026amp;=\\text{積日大餘} + 31\\\\ \\text{望日大餘}\u0026amp;=\\text{積日大餘} + 14\\\\ \\text{望日小餘}\u0026amp;=\\text{積日大餘} + 62 \\end{align*} $$\n推閏餘所在 推閏餘所在，以十二乘閏餘，加(十)[七]得一。盈章中，數所得，起冬至，算外，則中至終閏盈。中氣在朔若二日，則前月閏也。\n這一段求所求年如有閏月，當置於哪月。在推天正部分已經求出本年的閏餘 $n \\times 235 \\ \\mathbf{mod}\\ 19$，閏餘如果大於 12，本年就要置閏。但是閏月置於哪個月呢？三統曆將閏月置於無中氣之月。\n一年有二十四個節氣，其中十二個中氣。一年的長度以月份來計算就是 $12 \\frac{7}{19}$ 個月，那一個中氣平均長度就是 $12 \\frac{7}{19} \\div 12 = 12 \\frac{7}{19 \\times 12}$ 個月。也就是說，每過一個月，中氣就過 $12 \\frac{7}{19 \\times 12} = \\frac{235}{228}$。一個月的長度當然是 1，那者一個月過了之後，就會餘下 $\\frac{235}{228} - 1 = \\frac{7}{228}$ 個中氣。幾個月過去，中氣比一個月長的部分不斷累積，最終就會超過一個月的長度。當中氣和月長的差距超過一月時，下個月就沒有中氣，閏月就設置在這個月。\n上面推天正已經求出閏餘，閏餘以 19 爲分母。設閏餘爲 $u$，\n$$ \\begin{align*} \\text{一月長}\u0026amp;=1\\\\ \\text{一中氣長}\u0026amp;= \\text{一年月長} \\div \\text{一年中氣數}\\\\ \u0026amp;=12 \\frac{7}{19} \\div 12\\\\ \u0026amp;= \\frac{235}{228}\\\\ \\text{中氣長}-\\text{月長}\u0026amp;=\\frac{235}{228} - 1\\\\ \u0026amp;=\\frac{7}{228}\\\\ \\text{m 月之後中氣剩餘}\u0026amp;= \\frac{7m}{228}\\\\ \\text{加上本年閏餘}\\frac{u}{19}\u0026amp;=\\frac{u}{19} + \\frac{7m}{228}\\\\ \u0026amp;=\\frac{12u + 7m}{228}\\\\ \\text{當中氣累計剩餘超過}\\ \u0026amp;228\\ \\text{時：}\\\\ 12 u + 7m \u0026amp;\\geq 228\\\\ \\text{無中氣之月}\u0026amp;=(228 - 12 u)\\ \\mathbf{div}\\ 7 + 1 \\text{, 如果 } 12u + 7m \\gt 228\\\\ \u0026amp;=(228 - 12 u)\\ \\mathbf{div}\\ 7 \\text{, 如果 } 12u + 7m = 228 \\end{align*} $$\n注意，這裏算出來的無中氣之月是自建子月數的，如果是 2，那就是建子月之後兩個月閏月，就是建寅月閏月。前面已經說過，十九年一章中設置閏月的順序和時間都是固定的。在上一部分“三統曆算法的基本思路”中，已經列出來一章閏月的順序，這裏再列一遍：\n年份 月份 第 3 年 閏九月 第 6 年 閏六月 第 9 年 閏二月 第 11 年 閏十一月 第 14 年 閏七月 第 17 年 閏四月 第 19 年 閏十二月 推冬至、八節、二十四氣 推冬至，以(算)[策]餘乘(人)[入]統歲數，盈統法得一，名曰大餘，不盈者名曰小餘。除數如法，則所求冬至日也。\n求八節，加大餘四十五，小餘千一百。求二十四氣，三其小餘，加大餘十五，小餘千一十。\n推中部二十四氣，皆以元為法。\n這一段是根據入統年數求該年冬至日的干支。三統曆一年有 $365 \\frac{385}{1539}$ 天，減去干支週期 60 的倍數 360，剩下 $5 \\frac{385}{1539}$ 天，將這個數化爲帶分數 $\\frac{8080}{1539}$，分子部分就是策餘。用策餘乘以入統歲數 $n$，以所得數除以統法，化爲帶分數，整數部分爲大餘1，分子部分爲小餘。再算出大餘除以干支週期 60 的餘數。從入統首日干支數起，就是冬至日的干支。寫成公式就是：\n策餘乘以入統歲數：\n$$ \\begin{align*} \\frac{\\text{策餘}}{\\text{統法}} \\times \\text{入統歲數}\u0026amp;= \\frac{8080}{1539} \\times n\\\\ \u0026amp;= (n \\times 8080 \\ \\mathbf{div}\\ 1539) \\frac{n \\times 8080 \\ \\mathbf{mod}\\ 1539}{1539} \\\\ \u0026amp;= \\text{大餘} \\frac{\\text{小餘}}{1539}\\\\ \\text{大餘}\\ \u0026amp;= n \\times 8080 \\ \\mathbf{div}\\ 1539\\\\ \\text{小餘}\\ \u0026amp;= n \\times 8080 \\ \\mathbf{mod}\\ 1539\\\\ \\end{align*} $$\n大餘除以干支週期的餘數：\n$$\\text{干支序數} = \\text{大餘} \\ \\mathbf{mod}\\ 60 + \\text{入統首日干支序數}$$\n寫成代碼就是：\ndef tuiDongzhi(n, tongshouri): dongzhiDayu = n * 8080 // 1539 dongzhiXiaoyu = n * 8080 % 1539 dongzhiXushu = dongzhiDayu % 60 dongzhiGanzhi = ganzhi[ganzhi.index(tongshouri) + dongzhiXushu] return dongzhiDayu, dongzhiXiaoyu, dongzhiGanzhi 伐紂之年入人統甲申 521 年，該年大餘爲 $521 \\times 8080 \\ \\mathbf{div}\\ 1539 = 2735$，大餘除以干支週期的餘數是 $2735 \\ \\mathbf{mod}\\ 60 = 35$。從入統首日干支數起，甲申在干支表中的序數是 20，伐紂之年冬至干支的序數就是 $20 + 35 = 55$，也就是己未。這一年冬至是建子夏正十一月己未。\n八節爲冬至、立春、春分、立夏、夏至、立秋、秋分、立冬。三統曆一年 $365 \\frac{385}{1539}$ 日，每節平均長度爲 $365 \\frac{385}{1539} \\div 8 = 45 \\frac{1010}{1539}$ 日。已知冬至大餘和冬至小餘，只要將它們分別加上每節長度就是八節各自的大餘和小餘。假設八節次序爲 $j$ （冬至爲 0），則第 $j$ 個八節的大餘、小餘可以用以下公式算出。\n八節大餘：$$\\text{冬至大餘} + 45 \\times j$$ 八節小餘：$$\\text{冬至小餘} + 1010 \\times j$$\n而每個節氣的長度是 $365 \\frac{385}{1539} \\div 24 = 15 \\frac{1010}{4617}$。假設二十四節氣次序爲 $i$ （冬至爲 0），則第 $i$ 個二十四節氣的大餘、小餘可以用以下公式算出。因爲小餘以 4617 爲分母，而上面算出的冬至小餘是以 1539 爲分母的，所以這裏要先將冬至小餘乘以 3。\n二十四節氣大餘：$$\\text{冬至大餘} + 15 \\times i$$ 二十四節氣小餘，以 $3 \\times 1539 = 4617$ 爲分母（法）：$$\\text{冬至小餘} \\times 3 + 1010 \\times i$$\n推五行 推五行，其四行各七十三日，統(歲)[法]分之七十七。中央各十八日，統法分之四百四。冬至後，中央二十七日六百六分。\n三統曆把一年的日子按照五行木、火、土、金、水分爲五個部分。但是五行所屬的日子並不是一個接着一個的，也就是說，並不是屬木的日子結束之後立馬跟着屬火的日子。三統曆是把木、火、金、水分別和春夏秋冬四季搭配，而四季當中各有一部分日子屬於土，這叫做“土王四季”。\n一年 $365 \\frac{385}{1539}$ 日，平均分爲五行，每行 $365 \\frac{385}{1539} \\div 5 = 73 \\frac{77}{1539}$ 日；其中屬土的日子要分爲四份，分別歸入四季，因此土日每份爲 $73 \\frac{77}{1539} \\div 4 = 18 \\frac{404}{1539}$ 日。也就是對於春夏秋冬四季，每一季的前 $73 \\frac{77}{1539}$ 日屬於各自季節相對應的五行，而每一季的後 $18 \\frac{404}{1539}$ 日屬於土。這樣加起來，正好是一年的日子。春夏秋冬分別從立春、立夏、立秋、立冬開始。畫成圖更好理解。\n圖裏面，每個季節最後一段就是屬土的日子。冬季一段還標出了冬至的位置，就是圖中藍色豎線的地方。《律曆志》說“冬至後，中央二十七日六百六分”的意思是從冬至到冬季屬中央土的日子還有 $27 \\frac{606}{1539}$ 日。這是因爲冬至距離立春還有小寒、大寒，加上冬至總共三個節氣，根據上一個部分，推八節的部分，三個節氣之間相距 $45 \\frac{1010}{1539}$ 日，再減去冬至與立春之間中央土日 $18 \\frac{404}{1539}$ 日，就是 $27 \\frac{606}{1539}$ 日。\n推合晨所在星 推合晨所在星，置積日，以統法乘之，以十九乘小餘而并之。盈周天，除去之；不盈者，令盈統法得一度。數起牽牛，算外，則合晨所入星度也。\n這一段是求入統年天正月朔日的日月合朔所在星度。《左傳·昭公七年》伯瑕說：“日月之會是謂辰”，所以合晨度（晨通辰）就是日月合朔時刻的星度。太陽每天運行一度，一年 $365 \\frac{385}{1539} = \\frac{562120}{1539}$ 日，也就是太陽運行一週的度數。562120 就是以統法爲分母的周天度數。所以只要算出自統首至入統年正月朔日總共有多少天，也就是積日和積日小餘（不足一日的部分），就可以算出日月合朔時所在星度。\n積日和積日小餘已經在推正月朔部分求出。設積日爲 $j$，積日小餘爲 $y$，周天 562120，先求不盈周天度數，這就是日月運行不足一個週期的數值。\n$$ \\begin{align*} \u0026amp;\\text{積日} \\frac{小餘}{81} \\div (365 \\frac{385}{1539})\\\\ =\u0026amp; \\frac{81 j + y}{81} \\div (\\frac{562120}{1539})\\\\ =\u0026amp; \\frac{(81j+y) \\times 1539}{81 \\times 562120}\\\\ =\u0026amp; \\frac{(81j+y) \\times 19}{562120}\\\\ =\u0026amp; \\frac{1539j+19y}{562120}\\\\ =\u0026amp; (1539j+19y) \\ \\mathbf{div}\\ 562120)\\frac{(1539j+19y) \\ \\mathbf{mod}\\ 562120}{562120}\\\\ \\text{不盈周天度數}=\u0026amp;(1539j+19y) \\ \\mathbf{mod}\\ 562120 \\end{align*} $$\n不盈周天度數是日月運行不足一個週期的數值，但是還要求這個度數相當於一年 $365 \\frac{385}{1539}$ 度數的多少度，所以要除以統法 1539。下面就是三統曆求合晨度的最終公式：\n$$ \\begin{align*} \\text{合晨度}\u0026amp;=\\text{不盈周天度數}\\div 1539\\\\ \u0026amp;=((1539j+19y) \\ \\mathbf{mod}\\ 562120)\\ \\mathbf{div}\\ 1539\\frac{((1539j+19y) \\ \\mathbf{mod}\\ 562120)\\ \\mathbf{mod}\\ 1539}{1539} \\end{align*} $$\n由於三統曆的冬至點在牽牛初度，所以合晨度從牽牛初度起算。\n寫成代碼：\ndef tuiHechen(jiri, xiaoyu): hechendu = (jiri * 1539 + xiaoyu * 19) % 562120 // 1539 + 1 hechenXiaoyu = (dayu * 1539 + xiaoyu * 19) % 562120 % 1539 return hechendu, hechenXiaoyu 推其日夜半所在星 推其日夜半所在星，以章歲乘月小餘，以減合晨度。小餘不足者，破全度。\n由於日月合朔不一定在夜半，所以求朔日夜半星度需要以合晨度（也就是日月合朔度數）減去夜半，也就是積日小餘，這裏叫做月小餘2。合晨度和合晨度小餘上一部分已經求出。設合晨度爲 $c$，合晨度小餘爲 $z$，積日小餘爲 $y$：\n$$ \\begin{align*} \u0026amp;\\text{合晨度} \\frac{合晨度小餘}{1539} - \\frac{\\text{積日小餘}}{81}\\\\ =\u0026amp;\\text{c} \\frac{z}{1539} - \\frac{\\text{y}\\times 19}{1539}\\\\ =\u0026amp;\\frac{1539c + z - 19c}{1539}\\\\ =\u0026amp;((1539c + z - 19c)\\ \\mathbf{div}\\ 1539)\\frac{(1539c + z - 19c)\\ \\mathbf{mod}\\ 1539}{1539} \\end{align*} $$\n推其月夜半所在星 推其月夜半所在星，以月周乘月小餘，盈統法得一度，以減合晨度。\n正因爲夜半並不一定是日月合朔時刻，所以日月並不一定同度，所以算了夜半太陽所在星度，還可以算夜半月亮所在星度。與上一部分求日夜半所在星一樣，只要以日月合朔星度，也就是合晨度減去夜半之後月行度數，就是夜半月亮所在的星度。\n一章十九年，月亮有 254 個恆星月。注意，這裏的恆星月與朔望月不同。朔望月是月相變化的週期，而恆星月則是月球相對於一顆遙遠恆星的自傳週期，與地球上的恆星年相當。一章有 254 個恆星月，那每個恆星月以日爲單位的長度就是：\n$$ \\begin{align*} \u0026amp;\\text{一章日數} \\div \\text{一章恆星月總數}\\\\ =\u0026amp;\\frac{562120}{81} \\div 254\\\\ =\u0026amp; \\frac{562120}{81 \\times 254} \\end{align*} $$\n周天總共 $\\frac{562120}{1539}$ 度，所以月亮每日運行的度數就是：\n$$ \\begin{align*} \u0026amp;\\text{周天度數} \\div \\text{一個恆星月日數}\\\\ =\u0026amp; \\frac{562120}{1539} \\div \\frac{562120}{81 \\times 254}\\\\ =\u0026amp; \\frac{562120}{1539} \\times \\frac{81 \\times 254}{562120}\\\\ =\u0026amp; \\frac{81 \\times 254}{1539}\\\\ =\u0026amp; \\frac{254}{19} \\end{align*} $$\n以恆星月而言，月亮一日行 $\\frac{254}{19}$ 度。所以求月亮夜半星度只要以日月合晨度數減去不足一日月行的度數，也就是積日小餘與恆星月日行度數的積，就能得到月所在星度。設積日小餘爲 $y$，夜半月亮所在星度就是：\n$$ \\begin{align*} \\text{月夜半所在星度} \u0026amp;=\\text{合晨度} \\frac{合晨度小餘}{1539} - (\\frac{\\text{積日小餘}}{81} \\times \\frac{254}{19} )\\\\ \u0026amp;=\\text{c} \\frac{z}{1539} - \\frac{\\text{y}\\times 254}{1539}\\\\ \u0026amp;=\\frac{1539c + z - 254y}{1539}\\\\ \u0026amp;=((1539c + z - 254y)\\ \\mathbf{div}\\ 1539)\\frac{(1539c + z - 254y)\\ \\mathbf{mod}\\ 1539}{1539} \\end{align*} $$\n推諸加時 推諸加時，以十二乘小餘為實，各盈分母為法，數起於子，算外，則所加辰也。\n推諸加時的意思是以小餘計算各項數值在一天中的具體時刻。積日小餘是不足一日的部分，所以可以將積日小餘轉化成十二個時辰的時刻。三統曆將一日分爲十二時，所以將小餘乘以 12，化爲帶分數，整數部分就是時，而分數部分就是分。公式是：\n$$ \\begin{align*} \\text{加時}\u0026amp;=\\frac{12 \\times 小餘}{各盈分母}\\\\ \u0026amp;=(12 \\times 小餘 \\ \\mathbf{div}\\ 各盈分母) \\frac{12 \\times 小餘 \\ \\mathbf{mod}\\ 各盈分母}{各盈分母} \\end{align*} $$\n當然分數部分也能化爲六十進制的分秒。\n推月食 推月食，置會餘歲積月，以二十三乘之，盈百三十五，除之。不盈者，加二十三得一月，盈百三十五，數所得，起其正，算外，則食月也。加時，在望日衝辰。\n三統曆以 135 爲月食週期，135 個月會出現 23 次月食。但是一年平均 $12 \\frac{7}{19} = \\frac{235}{19}$ 個月，並不是 \\frac{135}{23} 的整數倍。所以需要算出 月食週期與回歸年長度的最小公倍數。月食週期 135 月，一年平均 $\\frac{235}{19}$ 月，135 和 235 的最小公倍數是 6345。這個最小公倍數叫做會月。一個會月是 6345 月，相當於 27 章 513 年。與會月相當的年數叫做會歲。寫成算式就是：\n$$ \\begin{align*} \\text{會月} \u0026amp;= \\mathbf{lcm}(\\text{朔望之會}, \\text{章月})\\\\ \u0026amp;=\\mathbf{lcm}(135, 235)\\\\ \u0026amp;=6345\\\\ \\text{會歲}\u0026amp;=(6345 \\div \\text{章月}) \\times \\text{章歲}\\\\ \u0026amp;=6345 \\div 235 \\times 19\\\\ \u0026amp;=513 \\end{align*} $$\n下一步是求會餘歲積月。本年自統首以來的積月已經在推天正部分求出了。設積月爲 $j$，$j$ 除以會月的餘數，$j \\ \\mathbf{mod}\\ 6345$，就是會餘歲積月。因爲 135 個月有 23 次月食，所以每隔 $\\frac{135}{23}$ 就有一次月食。所以根據三統曆算法的基本思路，要先算出會餘歲積月經過了幾個月食，也就是以會餘歲積月除以一個月食的週期：\n$$ \\begin{align*} \\text{會餘歲積月} \u0026amp;=\\text{積月} \\ \\mathbf{mod}\\ \\text{會歲}\\\\ \u0026amp;=j \\ \\mathbf{mod}\\ 6345\\\\ \u0026amp;\\text{會餘歲積月} \\div \\text{一個月食週期}\\\\ =\u0026amp;(j \\ \\mathbf{mod}\\ 6345) \\div \\frac{135}{23}\\\\ =\u0026amp;(j \\ \\mathbf{mod}\\ 6345) \\times \\frac{23}{135}\\\\ \\text{食次}=\u0026amp;((j \\ \\mathbf{mod}\\ 6345) \\times 23) \\ \\mathbf{div}\\ 135\\\\ \\text{次餘}=\u0026amp;((j \\ \\mathbf{mod}\\ 6345) \\times 23) \\ \\mathbf{mod}\\ 135\\\\ \\end{align*} $$\n食次爲會餘歲期間已經發生的日食數，而次餘就是本年天正月距離下一次月食的週期。假如次餘爲 0，則本年天正月就會發生月食。 而次餘與月食週期 135 的差值再除以 23 的商加一就是月食之月：\n$$ \\begin{align*} \\text{當：次餘}+ 23 \\times \\text{月數} \u0026amp;\\ge 135 \\text{時，自天正月數相應月數就有月食}\\\\ \\text{月食之月}\u0026amp;=(135-\\text{次餘})\\ \\mathbf{div}\\ 23 + 1 \\end{align*} $$\n歲術 推歲所在，置上元以來，外所求年，盈歲數，除去之，不盈者以百四十五乘之，以百四十四為法，如法得一，名曰積次，不盈者名曰次餘。積次盈十二，除去之，不盈者名曰定次。數從星紀起，算盡之外，則所在次也。欲知太歲，以六十除餘積次，餘不盈者，數從丙子起，算盡之外，則太歲日也。\n推歲所在就是給定某年，求木星所在星次。木星的週期大約是十二年。春秋時就有用歲星所在星次來紀年的辦法。但是木星週期實際爲 11.86 年，所以三統曆發明了超辰法來計算歲星所在星次，並用來紀年。所謂超辰法，就是每過十二個木星週期，星次要往前進一個，跳過一個星次，所以叫做超辰法。設所求年距上元 $n$ 年，不盈歲數爲 $m$。\n$$ \\begin{align*} \\text{歲星歲數}\u0026amp;= 144 \\times 12\\\\ \u0026amp;=1728\\\\ \\text{超辰}\u0026amp;=12 + 1 =13 \\\\ \\text{不盈歲數}\u0026amp;=n \\ \\mathbf{mod}\\ 1728 = m\\\\ \\text{積次} \\frac{次餘}{144}\u0026amp;= m \\times \\frac{145}{144}\\\\ \u0026amp;=(145m \\ \\mathbf{div}\\ 144) \\frac{145n \\ \\mathbf{div}\\ 144}{144}\\\\ \\text{積次}\u0026amp;=145m \\ \\mathbf{div}\\ 144\\\\ \\text{次餘}\u0026amp;=145m \\ \\mathbf{mod}\\ 144\\\\ \\text{歲星所在星次}\u0026amp;=\\text{積次}\\ \\mathbf{mod}\\ 12\\\\ \u0026amp;=145m \\ \\mathbf{div}\\ 144 \\ \\mathbf{mod}\\ 12 \\end{align*} $$\n這一段還有求太歲的辦法，就是積次除以六十的餘數，再以丙子爲起點，數出對應的干支。\n$$\\text{太歲} = \\text{積次} \\ \\mathbf{mod}\\ 60$$\n這樣算出的冬至大餘並不能直接對應干支表中的序號，還需要加上統首日的干支序數。《〈漢書·律曆志〉研究》中將這樣算出來的冬至大餘再加統首日干支序數作爲冬至大餘，所以地統冬至大餘比這裏求出來的大 40 （地統甲辰干支序數 40），人統冬至大餘大 20 （人統甲申干支序數 20）。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n原因應該是這裏的積日小餘是根據積月算出來的，以 81 爲分母，而合晨度的分母是 1539，所以二者相減的時候，需要先通分：$81 \\times 19 = 1539$，而積日小餘也要乘以章歲 19。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2025-12-lvlizhi4/","series":[],"tags":[],"title":"《漢書·律曆志》筆記（4）：統術（附歲術）"},{"authors":[],"categories":[],"content":"三統曆曆法計算分爲三個部分，第一部分是年月日、節氣、月食等的計算，叫做統術；第二部分是五大行星出現的時間等的計算，叫做紀術；第三部分是推求特定年份木星所在十二次的哪一次，叫做歲術。下面先解釋三統曆算法的基本思路，之後再依次介紹統術、紀術、歲術的計算方法。\n上一個部分介紹了很多三統曆所用的週期、時間單位長度等等，這些對三統曆的曆法計算都很重要。三統曆對年月日以及月食、五星運行的計算都有一個基本的思路。\n首先，假設一個定點，在這一點冬至出現在天正月朔日夜半，五星、日月都在同一個位置，也就是之前介紹的太極上元。這個定點就是所有事件（包括年月日、日月、五星運行）的起點。所有的推算都是以太極上元爲起點來計算的。\n其次，所有的天文和曆法事件都有一個週期。在一個週期與另一個週期之內，同一個天文或曆法事件在週期內以相同的順序和時間發生。例如，前面說過，朔望月和回歸年有一個大約十九年，也就是 235 個月的週期。在十九年的週期之中，有七個閏月。十九年中的第一個閏月必定設置在第三年的九月之後，也就是閏九月。假設過了十九年之後，第二個週期開始，在第 22 年（第二個週期的第三年 $22=19 + 3$），也必然是閏九月。\n基於這種思路，假設已經知道一個特定年份距離太極上元，也就是週期開始時的距離（三統曆叫做“距上元年數”），只要先除去已經過去的年份中所有完整的週期數，餘下的數就是該年份在一個週期中的所在的位置。例如，在計算一個特定年份有沒有閏月、閏月是哪個月時，假設已經知道本年距離上元 $22$ 年，在這 22 年中，有一個朔望月和回歸年的十九年週期，那本年就處在第二個的週期的第三年（$3 = 22 - 19 \\times 1$）。\n最後，根據給定年份在一個週期中的位置，與特定天文或曆法事件進行計算，就可以知道當年是否會發生這一天文或曆法事件，以及如果該事件發生，該事件發生的時間。例如，本年距上元 $22$ 年，在一個週期中處在第三年，根據十九年七閏，以及閏月必定在沒有中氣的月份的原則（這些已經在第一部分“中國傳統曆法的特點”中解釋過了），就可以確定本年有閏月，而且是閏九月。\n總結一下，三統曆的計算大概有以下四步：\n給定一個年份距太極上元的年數 $n$ 已知某個事件的週期爲 $p$ 從太極上元到本年已經經過的週期數爲 $n \\ \\mathbf{div}\\ p$，也就是 $n$ 除以 $p$ 的商。假如這個數字的單位是日，它就叫做“積日”；如果是月，就叫做“積月”，意思是該事件累積的週期數。而本年在本週期內的位置就是 $n \\ \\mathbf{mod}\\ p$，就是 $n$ 除以 $p$ 的餘數。這個餘數叫做“小餘”。 根據本年在本週期之內的位置 $n \\ \\mathbf{mod}\\ p$，對照特定事件在一個週期內發生的順序，就可以知道本年該事件是否發生，以及如果發生，這一事件的發生時間。 還是以閏月爲例，假設一個特定年份距太極上元 $n$ 年，朔望月和回歸年的週期是 $p = 19$，計算過程就是：\n$$ \\begin{align*} n \\div p\u0026amp; = \\frac{n}{p}\\\\ \u0026amp; = n \\ \\mathbf{div}\\ p \\frac{n \\ \\mathbf{mod}\\ p}{p}\\\\ \u0026amp; = n \\ \\mathbf{div}\\ 19 \\frac{n \\ \\mathbf{mod}\\ 19}{19}\\\\ \\text{到 n 年總共有幾個 19 年的週期}\u0026amp;= n \\ \\mathbf{div}\\ 19\\\\ \\text{第 n 年在 19 年的週期中的位置}\u0026amp;= n \\ \\mathbf{mod}\\ 19\\\\ \\end{align*} $$\n知道了第 $n$ 年在 19 年的週期中的位置 $n \\ \\mathbf{mod}\\ 19$，只要對照十九年的週期中設置閏月的順序和時間，就可以知道這一年有沒有閏月，以及閏月在哪一個月了。下面的表格就是十九年的週期中有閏月的年份，和閏月的月份。\n年份 月份 第 3 年 閏九月 第 6 年 閏六月 第 9 年 閏二月 第 11 年 閏十一月 第 14 年 閏七月 第 17 年 閏四月 第 19 年 閏十二月 將第 $n$ 年在 19 年的週期中的位置 $n \\ \\mathbf{mod}\\ 19$與年份對照，如果這個數字是有閏月的年份，就知道這一年閏月的哪個月份。\n三統曆對其他事件的計算都遵循相同的思路。假如一個事件在一個週期內發生的時間間隔是一樣的，例如一年二十四個節氣，每個節氣都是 $365 \\frac{385}{1539} \\div 24 = 15 \\frac{8080}{1539 \\times 24} = 15 \\frac{1010}{4617}$。假如我們知道這一年冬至發生在 $j \\frac{x}{1539}$ 日，那只要加上一個節氣的時間，就可以算出下一個節氣發生的時間，也就是：\n$$ \\begin{align*} \u0026amp;j \\frac{x}{1539} + 15 \\frac{1010}{4617}\\\\ =\u0026amp;j \\frac{3x}{4617} + 15 \\frac{1010}{4617}\\\\ =\u0026amp;(j + 15) \\frac{3x + 1010}{4617} \\end{align*} $$\n如果 $3x + 1010 \\gt 4617$，那只要將這個數字化爲帶分數就可以知道下一個節氣發生的具體時刻了。三統曆對於節氣、中氣、五星後見的計算，都是基於這個思路的。\n所以，要求某項事件是否發生和發生時間，只要知道三項數據就可以了：\n本年距上元年數； 該事件的週期。這些週期數都已經列在統母、紀母中了； 該事件在一個週期內的發生順序。有的事件是勻速發生的（節氣、中氣等），有的事件不是（閏月）。 但是要說明的是，太極上元是日月和五星運行的共同週期，在計算五星週期時，必須要用到太極上元。因爲五星會合週期大於日月會合週期 $138240 \\gt 4617$ 。但是對於年月日的計算，只要知道特定年份在一元或一統之中的位置就可以了（元法 4617，統法 1539）。這也就是爲什麼統術第一項計算的就是距上元某年在哪一統哪一年的緣故。\n","permalink":"https://ge-chunyu.github.io/posts/2025-12-lvlizhi3/","series":[],"tags":[],"title":"《漢書·律曆志》筆記（3）：三統曆算法的基本思路"},{"authors":[],"categories":[],"content":"《漢書·律曆志》卷下的主要內容是三統曆的常數、計算法和以三統曆推算的自太皞以來到漢代的年曆。三統曆設置的常數是曆法計算的基礎。三統曆設置的常數，包括用於計算年月日的統母、計算五星運行的紀母，和最重要的太極上元。以下從太極上元開始，依次對這些常數的數值計算和意義進行解釋。三統曆對統法的解釋牽扯到很多律曆和數術的概念，導致原本十分清楚的計算過程難以理解。所以在解釋統母之前，直接將這些數字與三統曆基本基本時間單位的時間長度聯繫起來進行解釋。在統母、紀母部分之後，三統曆還有一份五星運行軌跡、日期、度數的表格，叫做五步。這裏將五步的表格放在常數後面介紹。另外，除了這些常數和五星運行數據之外，三統曆的計算還要用到六十干支表、二十四節氣表、十二次度數表，以及二十八宿距度表，這些表格解釋完常數和五步之後進行介紹。\n太極上元的設定 三統曆設立了太極上元。太極上元是日月、五星的共同會合週期，也就是在這一時刻，日月五星的在天空中位於同一經度，同時這一時刻必須恰好是天統甲子統首年天正月朔日夜半，而且冬至也正好在這一時刻。從數學上來看，太極上元就是日月、五星週期的最小公倍數。已知日月合朔的週期爲 4617 年；木星週期 1728 年，金星週期 3456 年，土星週期 4320 年，火星週期 13824 年，水星週期 9216 年，五星週期的最小公倍數爲 138240，也就是五星會合週期，或稱作五星會終。那日月週期和五星週期的最小公倍數就是 23639040。《律曆志》在卷上末尾處指出太極上元的具體數目是 23639040，正好是日月五星週期的最小公倍數；又在世經部分指出太初元年距上元 143127 年。\n設立太極上元的意義在於便利曆法計算，更確切地說是爲了方便計算五星出現的時間和度數。原因在於三統曆將天體運行看作一個個週期，要計算某年某月某日處在這些週期的哪個位置，就可以利用這些週期進行計算。而要考慮所有天體運行的情況，勢必要考慮所有天體運行的週期。這就是設立太極上元的理念。而這一個大週期對曆法計算的意義將會在三統曆算法的基本思路部分詳細討論。\n三統曆基本時間單位的時間長度 三統曆對曆法基本數據的編排不夠清楚明晰，同時又牽扯到音律、度量衡等等，使得本來可以很清楚的數據變得難以理解。所以這裏以年、月、日爲單位計算出三統曆的基本時間單位。這樣與統母中的數字對照，不僅一目瞭然，而且對於後面用這些數字來進行曆法計算，也會方便很多。這裏先列出基本時間數據，和簡明的計算公式，下面再詳細解釋這些數字。\n三統曆的基本時間單位有（時刻、）日、月（朔望月）、節氣、中氣、年（回歸年）、章、統、元等。三統曆的一個月是一個朔望月，一年是一個回歸年。注意，在實際的曆法編排中，一個月能夠精確地對應上一個朔望月，但是曆法中的一年並不能精確對應一個回歸年。\n時間單位 年 月 日 中氣 日 1 策餘 8080 $365 \\frac{385}{1539} - 360 = 5 \\frac{385}{1539} = \\frac{8080}{1539}$ 月 1 $29 \\frac{43}{81} = \\frac{2392}{81} = \\frac{月法}{日法}$ 節氣 $\\frac{1}{24}$ $365 \\frac{385}{1539} \\div 24 = \\frac{70265}{4617} = 15 \\frac{1010}{4617}$ 中氣 $\\frac{1}{12}$ $\\frac{235}{19} \\div 12 = \\frac{235}{228} = \\frac{章月}{章中}$ $365 \\frac{385}{1539} \\div 12 = \\frac{140530}{4617} = \\frac{中法}{元法} = 30 \\frac{2020}{4617}$ 1 年 1 $\\frac{235}{19} = \\frac{章月}{章歲}$ $365 \\frac{385}{1539} = \\frac{562120}{1539} = \\frac{周天}{統法}$ 歲中 12 章 閏法/章歲 19 章月 235 $365 \\frac{385}{1539} \\times 19 = \\frac{10680280}{1539} = \\frac{562120}{81}$ 章中 $12 \\times 19 = 228$ 周至 周至 $3 \\times 19 = 57$ 統 統法 $81 \\times 19 = 1539$ 統月 $81 \\times 235 = 19035$ 周天 $81 \\times \\frac{562120}{81} = 562120$ 統中 $81 \\times 228 = 18468$ 元 元法 $3 \\times 1539 = 4617$ 元月 $3 \\times 19035 = 57105$ $3 \\times 562120 = 1686360$ 元中 $3 \\times 18468 = 55404$ 一個月食週期 朔望之會 135 會月 會月 $會數 \\times 朔望之會 = 47 \\times 135 = 6345$ : 三統曆基本時間單位年月日時長\n最後兩行是月食週期。一個月食週期 135 個月，總共 23 次月食。47 個月食週期總共 6345 個月。\n統母：日月運行的基本參數 三統曆以 19 年爲一章。十九年一章的意義是月相以十九年爲週期。十九年七閏，總共 $12 \\times 19 + 7 = 235$ 月。三章爲一周至，周至 57 年。三統曆又將 81 章定爲一統，一統 $19 \\times 81 = 1539$ 年，叫做統法。一統總共有 19035 個月。三統爲一元，一元總共 $3 \\times 81 \\times 19 \\times = 4617$ 年，叫做元法。一元總共有 57105 個月。將這些寫成算式就是：\n$$ \\begin{align*} \\text{章歲} \u0026amp;=19\\\\ \\text{章月} \u0026amp;=19 \\times 12 + 7\\\\ \u0026amp;=235\\\\ \\text{周至} \u0026amp;= 3 \\times \\text{章歲}\\\\ \u0026amp;=3 \\times 19\\\\ \u0026amp;=57\\\\ \\text{統法} \u0026amp;= 81 \\times \\text{章歲}\\\\ \u0026amp;=81 \\times 19\\\\ \u0026amp;= 1539\\\\ \\text{統月} \u0026amp;=81 \\times \\text{章月}\\\\ \u0026amp;= 81 \\times 235\\\\ \u0026amp;=19035\\\\ \\text{元法} \u0026amp;= 3 \\times \\text{統歲}\\\\ \u0026amp;=3 \\times 1539\\\\ \u0026amp;= 4617\\\\ \\text{元月} \u0026amp;=3 \\times \\text{統月}\\\\ \u0026amp;= 3 \\times 19035\\\\ \u0026amp;=57105 \\end{align*} $$\n曆法最基本的常數是朔望月和回歸年的長度。三統曆將朔望月長度定爲 $29 \\frac{43}{81} = \\frac{2392}{81}$ 日，而一年長度是由朔望月算出來的。十九年一章，一章有七個閏月，總共 235 個月，十九年的總日數就是 $\\frac{562120}{81}$，一年平均日數就是 $365 \\frac{385}{1539}$。寫成算式就是：\n$$ \\begin{align*} \\text{一月日數}\u0026amp;= 29 \\frac{43}{81}\\\\ \u0026amp;=\\frac{2392}{81}\\\\ \\text{一章日數}\u0026amp;= \\text{章月} \\times \\text{一月日數}\\\\ \u0026amp;= 235 \\times \\frac{2392}{81}\\\\ \u0026amp;= \\frac{562120}{81}\\\\ \\text{一年平均日數}\u0026amp;= \\text{一章日數} \\div \\text{章歲}\\\\ \u0026amp;= \\frac{562120}{81} \\div 19 \\\\ \u0026amp;= 365 \\frac{385}{1539} \\end{align*} $$\n這裏出現的所有數字三統曆都給了它一個名字。下面的表格就是三統曆給每個數字所起的名字：\n統母 數值 日法 81 閏法/章歲 19 統法 1539 月法 2392 周天 562120 章月 235 三統曆認爲月食週期是 $5 \\frac{20}{23} = \\frac{135}{23}$ 個月，也就是 135 個月總共有 23 次月食。135 月就稱作朔望之會。47 個月食週期正好等於 27 章，47 稱作會數，也就是：\n$$ \\begin{align*} \u0026amp;\\ \\ \\ \\ \\ \\ \\text{47 個月食週期}\\\\ \u0026amp;= 47 \\times 135 \\\\ \u0026amp;= 6345\\\\ \u0026amp;=\\text{27 章}\\\\ \u0026amp;= 27 \\times 235\\\\ \\end{align*} $$\n47 個月食週期等於 6345 個月，叫做會月。\n二十四節氣依次一爲節氣、一爲中氣，一年就是十二節氣、十二中氣。一章的中氣總數就是 $19 \\times 12 = 228$，叫做章中。一統 1539 年，一統的中氣總數是 $1539 \\times 12 =18468$，叫做統中。一元三統 4617 年，一元的中氣總數就是 $4617 \\times 12 = 55404$，叫做元中。\n這些參數統稱爲統母。也就是下面統母表中列的這些。\n統母 定義 數值 律曆志定義 日法 一日分爲 81 分 81 元始黃鐘初九自乘，一龠之數，得日法。 閏法 19 歲一章，一章 7 閏 19 合天地終數，得閏法。因爲章歲 統法 一統的年數 1,539 以閏法乘日法，得統法。 元法 一元的年數 4,617 參統法，得元法。 會數 47 個月食週期等於 27 個日月運行週期 47 參天九，兩地十，得會數。 章月 日月運行合併週期 235 五位乘會數，得章月。 月法 一月日數 2,392 推大衍象，得月法。 通法 月法與中法的公約數 598 四分月法，得通法。 中法 一元中每個中氣的總日數 140,530 以章月乘通法，得中法。 周天 一統的日數 562,120 以章月乘月法，得周天。 歲中 每年的中氣數 12 以三統乘四時，得歲中。 月周 一章中月行週期數 254 以章月加閏法，得月周。 朔望之會 月食週期 135 參天數二十五，兩地數三十，得朔望之會。 會月 一會數的總月數 6,345 以會數乘朔望之會，得會月。 統月 一統的總月數 19,035 參會月，得統月。 元月 一元的總月數 57,105 參統月，得元月。 章中 每章歲的中氣數 228 以閏法乘歲中，得章中。 統中 每統歲的中氣數 18,468 以日法乘章中，得統中。 元中 每元歲的中氣數 55,404 參統中，得元中。 策餘 一年長度與每年中氣總數的差 8,080 什乘元中，以減周天，得策餘。 周至 三章的年數 57 參閏法，得周至。 紀母：五星運行的基本參數 紀母，是推算五大行星運行的基本數據。外行星木星（歲星）、土星（鎮星）、火星（熒惑）有小周、歲數、見中分、積中、中餘、見中法、見閏分、積月、月餘、見月法、見中日法、見月日法十二個參數；而內行星金星（太白）、水星（辰星）除了五星都有的參數之外，還有晨中分、夕中分與積中、中餘，和晨閏分、夕閏分與積月、月餘十二個參數。\n在紀母最後，還列出了紀母各個數值之間的關係：\n以星行率減歲數，餘則見數也。\n東九西七乘歲數，并九七爲法，得一，金、水晨夕歲數。\n以歲中乘歲數，是爲星見中分。\n星見數，是爲見中法。\n以歲閏乘歲數，是爲星見閏分。\n以章歲乘見數，是爲見月法。\n以元法乘見數，是爲見中日法。\n以統法乘見數，是爲見月日法。\n首先，小周是五大行星的小週期；歲數則是五大行星周天的最少整年數。例如，木星一個小周的粗略週期是 12 年，而一個大週期的年數，即歲數則是 1728。它的意義是木星在 1728 年中行 145 周天。\n見中分是行星歲數所含中氣數，每年十二個中氣，歲數所含中氣數就是：$\\text{見中分} = \\text{歲數} \\times 12$。而積中、中餘是見中分與見中法的商和餘數。見中法是行星早晨初見於東方，到下一次早晨初見於東方的週期，所以叫做見數（見應讀 xiàn，胡甸切），而見數的分母（法）就是見日法。從天文上來說，行星與太陽交會時，在地球上就看不到行星。但是看不到的次數和行星出現的次數是相同的。見閏分是歲數中所含的閏月數。十九年七閏，所以在歲數中的總閏月數就是：$歲數 \\times \\frac{7}{19}$，$見閏分 = 歲數 \\times 7$。\n$$ \\begin{align*} \u0026amp;\\ \\ \\ \\ \\ \\frac{\\text{見中分}}{\\text{見中法}}\\\\ \u0026amp;=積中\\frac{中餘}{見中法}\\\\ \u0026amp;=(見中分 \\ \\mathbf{div}\\ \\text{見中法})\\frac{\\text{見中分} \\ \\mathbf{mod}\\ 見中法}{\\text{見中法}}\\\\ 積中\u0026amp;=見中分 \\ \\mathbf{div}\\ 見中法\\\\ 中餘\u0026amp;=見中分 \\ \\mathbf{mod}\\ 見中法 \\end{align*} $$\n根據歲數、見數就可以算出一個見數中有多少個朔望月。將這個數化爲帶分數，分母叫做見月法，整數部分叫積月，分子叫月餘。\n$$ \\begin{align*} 歲數所含月數 \u0026amp;=歲數 \\times 一年月數\\\\ \u0026amp;=歲數 \\times \\frac{235}{19}\\\\ \u0026amp;=\\frac{歲數 \\times 235}{19}\\\\ 見數所含月數\u0026amp;=歲數所含月數 \\div 見中法\\\\ \u0026amp;=\\frac{歲數 \\times 235}{19} \\div 見中法\\\\ \u0026amp;=\\frac{歲數 \\times 235}{19 \\times 見中法}\\\\ \u0026amp;=(歲數 \\times 235 \\ \\mathbf{div}\\ (19 \\times 見中法)) \\frac{歲數 \\times 235 \\ \\mathbf{mod}\\ (19 \\times 見中法)}{19 \\times 見中法})\\\\ \u0026amp;=積月 \\frac{月餘}{見月法}\\\\ 見月法\u0026amp;=19 \\times 見中法\\\\ 積月\u0026amp;=歲數 \\times 235 \\ \\mathbf{div}\\ (19 \\times 見中法)\\\\ 月餘\u0026amp;=歲數 \\times 235 \\ \\mathbf{mod}\\ (19 \\times 見中法) \\end{align*} $$\n見月日法是見月法和日法（81）的積，即 $見月法 \\times 日法 = 81 \\times 見月法$，見中日法則是見月日法的三倍，即 $見月日法 \\times 3$。以上是所有行星都有的參數。\n除了這幾個參數之外，金星還有晨中分、夕中分與積中、中餘，和晨閏分、夕閏分與積月、月餘十二個參數。原因在於金星和水星是內行星，它們的一個會合週期中包括一次晨見和一次夕見。這就可以算出一個晨見或夕見時段中中氣、閏月、月份的數量，分別化爲帶分數，就可以得出各自的積（這是積累的積，不是乘積的積）與小餘。\n紀母 歲星 太白 鎮星 熒惑 辰星 公式 小周 12 16 30 64 64 歲數 1,728 3,456 4,320 13,824 9,216 見中分 20,736 41,472 51,840 165,888 110,592 $歲數 \\times 12$ 積中 13 19 12 25 3 $積中\\frac{中餘}{見中法}=\\frac{見中分}{見中法}$ 中餘 157 413 1,740 4,163 32,469 見中法 1,583 2,161 4,175 6,469 29,041 見閏分 12,096 24,192 30,240 96,768 64,512 $\\frac{見閏分}{章歲} = \\frac{歲數 \\times 7}{19}$ 積月 13 19 12 26 3 $積月\\frac{月餘}{見月法}=\\frac{歲數 \\times 235}{見月法}$ 月餘 15,079 32,039 63,300 52,954 510,423 見月法 30,077 41,059 79,325 122,911 551,779 $見月法 = 19 \\times 見中法$ 見中日法 7,308,711 9,977,337 19,275,975 29,867,373 134,082,297 $見中日法 = 3 \\times 見月日法 = 4617 \\times 見中法 = 元法 \\times 見中法$ 見月日法 2,436,237 3,325,779 6,425,325 9,955,791 44,694,099 $見月日法 = 見月法 \\times 日法 = 見月法 \\times 81$ 晨中分 23,328 62,208 積中 10 2 中餘 1,718 4,126 夕中分 18,144 48,384 積中 8 1 中餘 856 19,343 晨閏分 13,068 36,288 積月 11 2 月餘 5,191 114,682 夕閏分 10,584 28,224 積月 8 1 月餘 26,848 395,741 五步：五行運行軌跡表 五星雖然實際上一直不間斷地作繞日運動，但是在地球上的人看來，它們的軌跡則有時順、有時留，甚至有時逆行。五步就是記錄五星視運動軌跡的表格。外行星的運行軌跡經過六個階段：順、始留、逆、復留、復順、伏。五星運行以從西往東運動爲順行，而從東往西運動爲逆行；留是五星視位置停止不變，而伏則是行星距太陽太近，在地球上看不到。內行星的軌跡與外行星不同。內行星的視運動經過晨始見和夕始見兩個部分，每一部分經過五個階段：晨始見、逆、始留、順、順疾、伏；夕始見、順、順遲、始留、逆、伏。 外行星運動軌跡度數表\n木星 土星 火星 運行軌跡 日數 日行度數 日數 日行度數 日數 日行度數 順行 121 $\\frac{2}{11}$ 87 $\\frac{1}{15}$ 276 $\\frac{53}{92}$ 留 25 0 34 0 10 0 逆行 84 $\\frac{1}{7}$ 101 $\\frac{5}{81}$ 62 $\\frac{17}{62}$ 留 $24 \\frac{3}{7308711}$ 0 $33 \\frac{862455}{19275975}$ 0 10 0 順行 $111 \\frac{1828362}{7308711}$ $\\frac{2}{11}$ 85 $\\frac{1}{15}$ 276 $\\frac{53}{92}$ 伏 $33 \\frac{3330737}{7308711}$ $3 \\frac{1673451}{7308711}$ $37 \\frac{17170170}{19275975}$ $7 \\frac{8736570}{19275975}$ $146 \\frac{15689700}{29867373}$ $114 \\frac{8218005}{29867373}$ 一見 $398 \\frac{5163012}{7308711}$ $33 \\frac{3334737}{7308711}$ $377 \\frac{18032625}{19275975}$ $12 \\frac{13210500}{19275975}$ $780 \\frac{15689700}{29867373}$ $415 \\frac{8218005}{29867373}$ 日行 $\\frac{145}{1728}$ $\\frac{145}{4320}$ $\\frac{7355}{13824}$ 金星 水星 運行軌跡 日數 日行度數 日數 日行度數 晨始見 逆行 6 $\\frac{1}{2}$ 1 2 始留 8 0 2 0 順行 46 $\\frac{33}{46}$ 7 $\\frac{6}{7}$ 順行疾 184 $1 \\frac{15}{92}$ 18 $1 \\frac{1}{3}$ 伏 83 $1 \\frac{33}{92}$ $37 \\frac{122029605}{134082297}$ $1 \\frac{7}{9}$ 晨見伏 327 $357 \\frac{4365220}{9977337}$ $65 \\frac{122029605}{134082297}$ $96 \\frac{46610128}{134082297}$ 夕始見 順行 $181 \\frac{45}{107}$ $1 \\frac{15}{92}$ $16 \\frac{1}{2}$ $1 \\frac{1}{3}$ 順行遲 46 $\\frac{33}{46}$ 7 $\\frac{6}{7}$ 留 $7 \\frac{62}{107}$ 0 $1 \\frac{1}{2}$ 0 逆行 6 $\\frac{1}{2}$ 1 2 伏逆 $16 \\frac{1295352}{9977337}$ $14 \\frac{3069868}{9977337}$ 24 $6 \\frac{58662820}{134082297}$ 夕見伏 $257 \\frac{1295353}{9977337}$ $226 \\frac{6907649}{9977337}$ 50 $19 \\frac{15419477}{134082297}$ 一復 $584 \\frac{1295353}{9977337}$ $584 \\frac{1295352}{9977337}$ $115 \\frac{122029605}{134082297}$ $\\frac{122029605}{134082297}$ : 內行星運動軌跡度數表\n表格 十二次初中終節氣度數表\n十二次 初度數 中度數 終度數 總度數 0 星紀 初斗十二度 大雪 中牽牛初 冬至 終於婺女七度 $30\\frac{1}{4}$ 1 玄枵 初婺女八度 小寒 中危初 大寒 終於危十五度 30 2 諏訾 初危十六度 立春 中營室十四度 驚蟄 終於奎四度 31 3 降婁 初奎五度 雨水 中婁四度 春分 終於胃六度 30 4 大梁 初胃七度 穀雨 中昴八度 清明 終於畢十一度 30 5 實沈 初畢十二度 立夏 中井初 小滿 終於井十五度 31 6 鶉首 初井十六度 芒種 中井三十一度 夏至 終於柳八度 30 7 鶉火 初柳九度 小暑 中張三度 大暑 終於張十七度 31 8 鶉尾 初張十八度 立秋 中翼十五度 處暑 終於軫十一度 30 9 壽星 初軫十二度 白露 中角十度 秋分 終於氐四度 31 10 大火 初氐五度 寒露 中房五度 霜降 終於尾九度 30 11 析木 初尾十度 立冬 中箕七度 小雪 終於斗十一度 31 二十四節氣表，從冬至開始。注意，三統曆驚蟄、雨水，清明、穀雨的順序和現在的順序正好相反。\n冬 春 夏 秋 21 立冬 3 立春 9 立夏 15 立秋 22 小雪 4 驚蟄 10 小滿 16 處暑 23 大雪 5 雨水 11 芒種 17 白露 0 冬至 6 春分 12 夏至 18 秋分 1 小寒 7 穀雨 13 小暑 19 寒露 2 大寒 8 清明 14 大暑 20 霜降 二十八宿距度表\n東方七宿 距度 北方七宿 距度 西方七宿 距度 南方七宿 距度 角 十二 斗 二十六 奎 十六 井 三十三 亢 九 牛 八 婁 十二 鬼 四 氐 十五 女 十二 胃 十四 柳 十五 房 五 虛 十 昴 十一 星 七 心 五 危 十七 畢 十六 張 十八 尾 十八 營 室十六 觜 二 翼 十八 箕 十一 壁 九 參 九 軫 十七 東 七十五度 北 九十八度 西 八十度 南 百一十二度 上表周天總共 $$75 + 98 + 80 + 112 = 365$$ 度，沒有出現分數部分。按《淮南子·天文訓》，箕十一四分一，周天度數 $365 \\frac{1}{4}$；《後漢書·律曆志》斗宿 $26 \\frac{1}{4}$ 度，周天度數也是 $365 \\frac{1}{4}$ 度。錢大昕認爲斗下脫“三百八十五分”。\n曆法計算最基本的表格是六十干支表（或稱一甲數次表）。年月皆用干支來表示，六十一循環，往復無已。十天干、十二地支相互組合，可以形成週期爲六十的序列。下表是六十干支表，爲了便於計算，干支序數從 0 開始。 六十干支表（一甲數次表）\n0 甲子 10 甲戌 20 甲申 30 甲午 40 甲辰 50 甲寅 1 乙丑 11 乙亥 21 乙酉 31 乙未 41 乙巳 51 乙卯 2 丙寅 12 丙子 22 丙戌 32 丙申 42 丙午 52 丙辰 3 丁卯 13 丁丑 23 丁亥 33 丁酉 43 丁未 53 丁巳 4 戊辰 14 戊寅 24 戊子 34 戊戌 44 戊申 54 戊午 5 己巳 15 己卯 25 己丑 35 己亥 45 己酉 55 己未 6 庚午 16 庚辰 26 庚寅 36 庚子 46 庚戌 56 庚申 7 辛未 17 辛巳 27 辛卯 37 辛丑 47 辛亥 57 辛酉 8 壬申 18 壬午 28 壬辰 38 壬寅 48 壬子 58 壬戌 9 癸酉 19 癸未 29 癸巳 39 癸卯 49 癸丑 59 癸亥 數學術語與符號 古代所用的數學術語與今天不同。要想瞭解《律曆志》中的計算，要先弄清楚古代人用的數學術語的意思，也就是它們相當於今天所用的哪些數學術語。\n在《律曆志》所用的數學術語中，最重要的是法和實兩個。古人與現在的人不同，數學計算是以分數進行的，而不是用小數。所有的小數都會化成分數進行計算。分數分爲分母和分子兩部分 $\\frac{分子}{分母}$ 。古人把分母叫做法，分子叫做實，也就是：$\\frac{分子}{分母} = \\frac{實}{法}$。\n在根據序數推求干支時，從甲子開始數，但是在數字上要從 0 開始，而不是 1 開始。《律曆志》將這種做法叫做“算外”。不止是在數甲子時候需要算外，數十二次等都需要這樣做。\n在進行分數計算時，有些常用的運算，例如整數除法和餘數。整數除法用 $\\ \\mathbf{div}\\ $，例如 $5 \\ \\mathbf{div}\\ 2 = 2$；而餘數用 $\\ \\mathbf{mod}\\ $，如 $5 \\ \\mathbf{mod}\\ 2 = 1$。\ndefinition math notation least common multiple $\\mathbf{lcm}(2, 3) =6$ $\\mathbf{lcm}(2, 3)$ integer division $5\\ \\mathbf{div}\\ 2 = 2$ $\\mathbf{div}$ Modulus $5\\ \\mathbf{mod}\\ 2 = 1$ $\\mathbf{mod}$ ","permalink":"https://ge-chunyu.github.io/posts/2025-12-lvlizhi2/","series":[],"tags":[],"title":"《漢書·律曆志》筆記（2）:表格與常數"},{"authors":[],"categories":[],"content":"中國傳統曆法的特點 中國傳統曆法有以下這些主要特點：\n用干支記錄日期 以朔望月來確定月份 以朔望月與回歸年的配合來確定一年的長度，也就是在哪些年份設置閏月，閏月設置在哪個月份 除了年月日之外，還有完全由回歸年決定的二十四節氣 除了編算年月日、節氣之外，還要推算五大行星的運行 以下就對這些特點進行詳細說明。\n曆法的用處就是記錄時間。在地球上生活，最容易注意到的就是太陽的東昇西落。太陽升起一次、落下一次就是一天。月亮每隔一些天數就會由圓變缺、由缺變圓。在更長一點的時段，天氣會由寒轉暖、又由暖變冷。這些自然現象所展現的週期爲曆法提供了最基本的單位，也就是日、月、年。古人在持久的仔細觀測後，發現月亮由圓變缺的週期是大致固定的，大約是 29 天多。而天氣冷暖變遷的週期也大致是固定的，大約是 365 天。因此，將日子以月份（29 天）組織起來，過幾個月的長度就接近一年。但是問題在於，設置十二個月的日數不足一年（$12 \\times 29 = 348$），而設置十三個月的日數又超過一年（$13 \\times 29=377$）。因此，有的古代文明就設置十二個整月，而將多出來的幾天單獨處理。假設一年固定 365 天，一個月 29 天，那十二個月之後，一年還剩 $365 - 12 \\times 29 = 17$，這剩下的幾天就是單獨的一個月。例如，古埃及的曆法，每個月 30 天，一年 365 天，每十二個月之後又會增加 5 天。這五天叫做 epagomenœ，就是增加的日子1。\n另外一種辦法是不固定每年的日數，每過幾年增加一個閏月。假設將一年分爲十二個月，每個月 29 天，每過一年就多 $365 - 12 \\times 29 = 17$，兩年之後，多出來的日子就有 $17 \\times 2=34$ 天，就可以多設置一個月，來安置多出來的這些日子。在日復一日的觀測之後，古人發現月亮盈虧和冷暖交替有一個大致的週期，大約 19 個整年之中有 235 次完整的月亮週期。中國古代將之稱爲一章，而古希臘人將之稱爲 Metonic cycle，以發現這一週期的古希臘數學家 Meton of Athens 命名。以此爲基礎，就可以在十九年之中設置七個閏月，也就是 $235 - 12 * 19 = 7$。這就叫十九年七閏，中國早期的太初曆、三統曆都以這一週期爲基礎計算曆法。\n一天雖然能很好地與日出、日落對應，但是何時爲一天的開始，卻沒有一個客觀的標準，或者說，一天從任何一個時間點開始都一樣。但是在古代計時還很原始，如果隨意選擇一個時刻爲一天的開始，那如何保證每天的開始都是在同一時刻呢？與此相應，每天日出和日落的時間是大致可以確定的。有些曆法就以日出（印度教曆法）或日落（希伯來曆法）爲一天的開始2。中國傳統曆法則以午夜爲一天的開始，稱之爲“夜半”。\n同樣地，一個月的開始也可以隨意設置，既可以是月亮最圓的那天，也可以是月亮最缺的那天。而中國傳統曆法以日月合朔爲一個月的開始。在這一天，月亮與太陽在天球上處在同一經度，在地球上月亮幾乎不可見。這天叫做“朔”，這就是合朔一詞的原由。月亮最圓的時候出現在每月的第十五或第十六天，第十五天叫做“望”。所以以月相爲基礎的一個月叫做“朔望月”。\n一年的開始也沒有客觀的標準。中國古代有三正的說法。三正分別指夏正、殷正、周正。夏商周三代以不同的月份爲一年的起點，所以叫做三正。在夜晚的天空中，北斗七星很引人注意，而且在古代中國所處的地區，北斗七星一年四季都在天空。但是由於地球繞着太陽轉的週期與地球相對於遙遠恆星的旋轉週期的差距（也就是恆星年和回歸年的差距），星座在一年四季的位置是不同的。就北斗七星而言，不同季節一天相同時刻斗柄的指向就會不同3。《鶡冠子》說：“斗柄東指，天下皆春，斗柄南指，天下皆夏，斗柄西指，天下皆秋，斗柄北指，天下皆冬。”古人將斗柄的指向與地支相配合。斗柄指向東偏北方的時候就是現在的農曆正月，對應地支的寅，夏以此爲正月，叫做“建寅”；指向北偏東的時候是農曆十二月，殷以此爲正月，叫建丑；指向正北方的時候在農曆十一月，周以此爲正月，叫建子。下面的圖就展示了北斗七星的指向與夏正月份的關係。\n三正 斗柄指向 地支/斗建 農曆月份 夏正 東偏北 建寅 正月 殷正 北偏東 建丑 十二月 周正 正北 建子 十一月 中國古代是用干支來紀日的。十天干、十二地支相互組合，可以形成從甲子到癸亥、週期爲六十的天干地支序列，見下表。古人就以六十干支來紀日，每六十天一次循環。每個日子都有對應的干支名稱，叫做日名。一月 29 天、一年三百多天，都不是六十的整數倍。所以干支紀日是相對獨立於月份和年份的。現代的格里高利曆，每月第一天都是一號，而每年第一天都是一月一日。但是以干支紀日，假設第一年的第一天是甲子，一個月 29 天之後第二個月第一天的干支的序號就是 30，對應癸巳（注意，下面的干支表是以 0 爲開始的）。那過六十天之後又要開始一個週期。一年 365 天，有六個干支週期，又多出五天。所以第二年第一天是己巳。這也就是中國曆法要計算特定日期的干支日名的原因。 六十干支表\n0 甲子 10 甲戌 20 甲申 30 甲午 40 甲辰 50 甲寅 1 乙丑 11 乙亥 21 乙酉 31 乙未 41 乙巳 51 乙卯 2 丙寅 12 丙子 22 丙戌 32 丙申 42 丙午 52 丙辰 3 丁卯 13 丁丑 23 丁亥 33 丁酉 43 丁未 53 丁巳 4 戊辰 14 戊寅 24 戊子 34 戊戌 44 戊申 54 戊午 5 己巳 15 己卯 25 己丑 35 己亥 45 己酉 55 己未 6 庚午 16 庚辰 26 庚寅 36 庚子 46 庚戌 56 庚申 7 辛未 17 辛巳 27 辛卯 37 辛丑 47 辛亥 57 辛酉 8 壬申 18 壬午 28 壬辰 38 壬寅 48 壬子 58 壬戌 9 癸酉 19 癸未 29 癸巳 39 癸卯 49 癸丑 59 癸亥 光計算日期的干支日名還不夠，月份也需要計算。前面已經說過，中國傳統曆法十九年中有七個閏月，如何決定一年有沒有閏月、有閏月又應該放在哪個月，這也是需要計算的。在春秋時期，閏月是放在十二個月之後的，也就是“歸餘於終”（《左傳·文公元年》）。但是到了漢代，已經確定了閏月是設置於沒有中氣的月份的規則。但是，何謂中氣呢？ 二十四節氣，以冬至爲起始\n冬 春 夏 秋 21 立冬 3 立春 9 立夏 15 立秋 22 小雪 4 驚蟄 10 小滿 16 處暑 23 大雪 5 雨水 11 芒種 17 白露 0 冬至 6 春分 12 夏至 18 秋分 1 小寒 7 穀雨 13 小暑 19 寒露 2 大寒 8 清明 14 大暑 20 霜降 中國傳統曆法雖然以朔望月確定月份，但是另一方面又要配合太陽的週期。太陽經過春分點，季節進入春季，是春耕的關鍵時期；太陽到達冬至點，是一年夜晚最長的一天。這些時間點對於農業活動都非常重要。所以爲了安排農事，中國傳統曆法還將一年分爲二十四節氣，而二十四節氣完全是按照太陽的運行決定的，從本質上來說是一種太陽曆。這二十四個節氣，傳統曆法將它們分爲中氣和節氣，例如冬至是中氣，那下一個節氣小寒就是節氣，再下一個節氣大寒又是中氣。一年二十四節氣，其中十二個中氣、十二個節氣。對節氣的推算完全是根據太陽運行的週期來的，也就是完全根據回歸年的長度。將一個回歸年平均分爲二十四份，每一份就是一個節氣的長度；將回歸年分爲十二份，每一份就是一個節氣的長度。那麼，既然十二個朔望月的長度不到一年，而十二個中氣加起來恰好是一年，一個中氣就比一月略長。假設月份和節氣同時開始，一月結束時，中氣就會比月份多出一段。當這一段多出的時間不斷累積，達到一個月的長度的時候，就是需要設置閏月的時候。\n上面這張圖展示了三年之中中氣相對於月份的位置。圖中位置都是按照三統曆的數值計算出來的。粉紅色的點是月份的位置，藍色的點是中氣的位置。一個月的長度是 1，而一個中氣的長度是 $\\frac{235}{228} = 1.0307$，所以第一年第一個月過後中氣的位置比月份稍後。一年過後，中氣比月份顯著多出一段。也就是說，中氣的位置逐漸從月初轉向月中、月末。到了第三年九月4，中氣出現在九月底，而下一個中氣出現在十一月初，也就是本年十月沒有中氣。因此，本年需要閏九月。\n這也就是說，中國傳統曆法不僅要計算特定年份相對於曆法起點過了多少天（用以確定特定日子的干支日名），還需要確定哪些年份有閏月，如果有閏月的話，閏月在哪個月；而對閏月的計算又涉及到對節氣的推算。這些是中國傳統曆法計算的主要部分。這一部分在《律曆志》中稱作“統術”，而與這部分的推算相關的常數叫做“統母”。\n但是，除了對年月日的計算之外，中國傳統曆法還有其他的任務，就是對天體運行的計算。例如，每隔一段時間，就會發生月食。計算哪個月會發生月食，也是傳統曆法的內容。不僅如此，傳統曆法還需要推算水星、金星、火星、木星、土星五大行星的位置和出現時間等信息。五大行星中最重要的是木星。在春秋時期，古人就已經發現木星的週期大約是十二年，因此古人將天空平均分爲十二個區域。當某年木星運行到哪個區域時，就以這個天區來給當年命名。因爲古人把在一個地方停留超過兩夜叫做“次”5，所以木星停留在一個天區就叫“一次”，而十二個天區就稱爲十二次。下面的表格就是《漢書·律曆志》中給出的十二次的名稱，與每次的起始度數、終到度數、總度數，都以二十八宿爲參考。因爲先秦的人有以木星所在次來紀年的辦法，所以爲了確定所說的具體是哪一年就需要對木星的位置進行推算。劉歆已經發現了木星的週期不到十二年，大約每十二個週期就會多走一個星次。現代發現木星週期大約是 11.86 年，每十二個週期 $12 \\times 11.86 = 142.32$，比 12 年一個週期少了一次多 $12 \\times 12 = 144 - 142.32 = 1.68$。所以劉歆發明了“歲星超辰”的辦法，木星每走十二個週期，就會在十二次中跳一個，多走一次。這就是《律曆志》“歲術”部分推算的內容。\n十二次 初度數 終度數 總度數 0 星紀 初斗十二度 終於婺女七度 $30\\frac{1}{4}$ 1 玄枵 初婺女八度 終於危十五度 30 2 諏訾 初危十六度 終於奎四度 31 3 降婁 初奎五度 終於胃六度 30 4 大梁 初胃七度 終於畢十一度 30 5 實沈 初畢十二度 終於井十五度 31 6 鶉首 初井十六度 終於柳八度 30 7 鶉火 初柳九度 終於張十七度 31 8 鶉尾 初張十八度 終於軫十一度 30 9 壽星 初軫十二度 終於氐四度 31 10 大火 初氐五度 終於尾九度 30 11 析木 初尾十度 終於斗十一度 31 除了木星在特定年份出現在哪個天區，傳統曆法還要計算木星何時出現，以及出現的具體位置，也包括其他四大行星的出現時間、位置等信息。對這些內容的計算對應《律曆志》中的“紀術”部分，而與這些計算有關的常數則叫做“紀母”6。\n因爲曆法既要推算年月日，又要推算五大行星的運行，所以傳統曆法設置了上元。簡單來說，上元就是日月和五大行星週期的最小公倍數。太極上元與統母、紀母這些在曆法計算中最基本的常數都會在“基本數據與表格”部分進行介紹。\n《漢書·律曆志》主要內容 《漢書·律曆志》分爲上下兩卷，上卷分爲兩個部分，第一部分又分爲五個小部分，備數、和聲、審度、嘉量、權衡，講數和律呂、度量權衡的相生關係；第二部分講曆數自上古到太初改曆，下及劉歆作《三統曆》的歷史演變，並且說明曆書中所用的重要數字與天道人事的關係。下卷分爲統母，講三統曆所用的重要參數；紀母，推步五星的基本數據；五步，五星運行的基本軌跡與度數；統術，三統曆的基本原理；紀術，推步五星的基本原理；歲術，計算歲星位置的方法；世經，用三統曆推算出的自太昊帝以來的年曆。爲了看起來清楚，以下將《律曆志》主要內容寫成列表。\n上卷： 第一部分：以律起曆 備數 和聲 審度 嘉量 權衡 第二部分：曆法沿革 自“曆數之起上矣”至“至孝成世，劉向總六曆，列是非，作五紀論” ： 從顓頊至漢成帝的曆法沿革 自“向子歆究其微眇，作三統曆及譜以說春秋，推法密要，故述焉。”至上卷末尾： 三統曆撰作目的與基本數據 下卷： 統母：日月運行的參數 紀母：五星運行的基本數據 五步：五星運行的基本軌跡與度數 統術：如何推算三統曆日名、置閏、節氣、日月運行等 紀術：推步五星的基本算法 歲術：計算歲星位置的方法 世經：用三統曆推算出的自太昊帝以來的年曆 R. A. Parker, The Calendars of Ancient Egypt, University of Chicago Press, Chicago, 1950.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n見 Calendrical Calculations 第14 頁的各種曆法紀日對照圖。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n古人認爲北斗七星的形狀像斗，斗是一種長柄的舀水器，也寫作枓。《史記·趙世家》趙襄子請代王吃飯的時候，就暗中命令廚人用斗柄擊殺代王。由此可知，斗的柄一定相當長，不然無法用來殺人。斗的容水部分叫做“魁”，而柄叫做“杓”（biāo，甫遙切）。《史記·天官書》索隱引春秋運斗樞云“斗，第一天樞，第二旋，第三璣，第四權，第五衡，第六開陽，第七搖光。第一至第四爲魁，第五至第七爲標，合而爲斗。”\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n注意，圖中標記月份的數字都是標在月底。例如，圖中標一月的位置是一月的結束、二月的開始。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n《左傳·莊公三年》：“一宿爲舍，再宿爲信，過信爲次。”也就是說，住一夜叫舍，住兩夜叫信，住兩夜以上叫次。木星在一個天區會停留一年左右，時間比較長，所以叫次。而其他恆星則將天空分爲二十八個天區，稱之爲二十八宿，因爲日、月在每個天區停留的時間較爲短暫，所以稱之爲宿或舍。古代也有將二十八宿稱作二十八舍的叫法。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n今本誤作統母，李銳在《三統術注》中認爲應該是紀母。統母是與統術相應的常數，那與紀術相應的常數也應該是紀母，而不是統母。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2025-12-lvlizhi/","series":[],"tags":[],"title":"《漢書·律曆志》筆記（1）:中國傳統曆法的特點與《漢書·律曆志》的主要內容"},{"authors":[],"categories":[],"content":"I have not really grasped the tricky variable use and string operations in the shell, and this post is a cheatsheet of the common variable and string operations in the shell.\nVariables Assigning values to variables, note that = immediately follows the variable name and it allows no space.\nvariable='value' variable=\u0026quot;value\u0026quot; variable=value There are several ways of calling a variable, by $variable, ${variable} and \u0026quot;$variable\u0026quot;. The curly braces are useful when you need to clearly mark the boundary of the variable name. For example, $variableisvalue will not output the value of $variable since the shell interprets the name of the variable as variableisvalue. To tell the shell where the variable name ends, surround the variable name with curly braces ${variable}isvalue, which is not ambiguous to the shell.\necho $variable echo ${variable} echo \u0026quot;$variable\u0026quot; The arguments to the script can be accessed as common variables. For example, the following lists the common ways of accessing the script arguments.\nApart from the variables that you need to define yourself, the shell stores a set of environment variables, such as $HOME, $PATH, etc. The command printenv lists all these variables.\nThere are also a bunch of variables called positional parameters, including the following variables.\n$0: the basename of the program $1 .. $9: the first nine additional arguments the script was called with $@: all arguments, each as a separate string $*: all arguments as a string, without space $#: the number of arguments $?: the exit status of the last run command $$: PID (Process IDentifier) of the current shell $!: PID (Process IDentifier) of the last run background process IFS: Internal Field Separator $* vs. $@ The difference between $* and $@ is tricky. Both refers to all the arguments, and when they are used without quote, they are equivalent. But when used with double quote, \u0026quot;$*\u0026quot; stands for all the arguments as a single string, but each arguments are treated separately in \u0026quot;$@\u0026quot;. The following demonstrates the difference:\n# run ./args.sh arg1 \u0026quot;arg2 word\u0026quot; arg3 for a in $*; do echo \u0026quot;${a}\u0026quot; done # The output is: # \u0026gt; arg1 # \u0026gt; arg2 word # \u0026gt; arg3 for a in \u0026quot;$*\u0026quot;; do echo \u0026quot;${a}\u0026quot; done # The output is: # \u0026gt; arg1 arg2 word arg3 Single and double quotes Unlike in many other languages, single and double quotes are treated differently by the shell. The shell treats the characters literally surrounded by single quotes, but within double quotes, $ and certain other signs are evaluated. If $ is used in double quotes with a backslash, or an escape character \\, it will not be evaluated. It sounds very hard to understand, but its actually quite clear, as demonstrated below\nCommand output \u0026lsquo;$HOME\u0026rsquo; $HOME \u0026ldquo;$HOME\u0026rdquo; /Users/chunyu \u0026ldquo;\\$HOME\u0026rdquo; $HOME More generally, in double quotes, parameter expansion, arithmetic expansions, and command substitution can all take place, which are all suppressed in single quotes.\nString operations The following table shows the command with its meaning, and an example for each together with its output.\nCommand example output meaning $var $var stringstring output the variable $var$var1 $var$var1 stringstringanother concatenate string ${var}${var1} ${var}${var1} stringstringanother concatenate string \u0026ldquo;${var}${var1}\u0026rdquo; \u0026ldquo;${var}${var1}\u0026rdquo; stringstringanother concatenate string ${var} ${var} stringstring output the variable ${#var} ${#var} 12 length of the variable ${var:position} ${var:3} ingstring substring from position ${var:position} ${var: -3} ing negative position with leading space from right ${var:position:length} ${var:3:2} in length-long substring from position ${var:position} ${var: -3:2} in length-long substring with negative position ${var#pattern} ${var#*i} ngstring remove the first match of the pattern from left ${var##pattern} ${var##*i} ng remove the longest match of the pattern from left ${var%pattern} ${var%i*} stringstr remove the first match of the pattern from right ${var%%pattern} ${var%%i*} str remove the longest match of the pattern from right ${var/pattern/replace} ${var/string/new} newstring replace the first occurrence of the pattern ${var//pattern/replace} ${var//string/new} newnew replace all occurrences of the pattern ${var/#pattern/replace} ${var/#string/new} newstring replace the first occurrence of the pattern from right ${var/%pattern/replace} ${var/%string/new} stringnew replace all occurrences of the pattern from right $((num operation num)) $((1+1)) 2 expressions of numeric operation ${#variable}: the length of the string ${var1}{var2}{var3}: concatenate strings, with optional string in between (same below) $var1$var2$var3: concatenate strings \u0026quot;$var1\u0026quot;\u0026quot;$var2\u0026quot;\u0026quot;$var3\u0026quot;: concatenate strings ${string:position}: substring from $position till the end ${string:position:length}: a substring of $length characters from $position position can also be negative, ${string: -3} means the last three characters, note also the space before - is required ${string#pattern}: pattern is a wild card pattern, like *.txt. This one removes the first match from the beginning of the string, while the one below removes the longest match ${string##pattern} ${string%pattern}: replaces the pattern from the end of the string ${string/pattern/replace}: replace the matched pattern for the first occurrence ${string//pattern/replace}: replace the matched pattern for all occurrences ${string/#pattern/replace}: replace the matched pattern at the beginning of the string ${string/%pattern/replace}: replace the matched pattern at the end of the string $((expression)): arithmetic operations, including +, -, *, /, **, % String expressions String expressions can be useful in the if statement.\nstring: string is not null -n string: the length of string is greater than zero -z string: the length of string is zero string1 = string2: string1 and string2 are equal string1 == string2: string1 and string2 are equal. This is preferred over the previous one with single equal sign string1 != string2: string1 and string2 are not equal string1 \u0026gt; string2: string1 sorts after string2 string1 \u0026lt; string2: string1 sorts before string2 ","permalink":"https://ge-chunyu.github.io/posts/2025-11-shell-string/","series":[],"tags":[],"title":"Variables and string in the shell"},{"authors":[],"categories":[],"content":"《文選》李陵《答蘇武書》：“丁年奉使。”李善注：“丁年，謂丁壯之年也。漢書曰：武留匈奴凡十九歲。始以強壯出，及還，鬢髮並白。”黃生《字詁義府合按》卷下“丁壯”：“漢書·高帝紀：‘丁壯若軍旅’，古丁、當同音，丁壯言其年正當壯時也。後語省，遂單呼爲丁，故民年二十成丁。李陵《答蘇武書》：‘丁年奉使’，正謂年在二十左右也。”李善讀丁年爲丁壯之年，而黃生說古代丁、當同音，並且指實丁年是二十成丁之年，也就是說蘇武奉使是在二十歲。說丁、當同音不確，下面再詳細討論；而說蘇武二十歲奉使，則是錯的。\n《漢書·卷五十四·李廣蘇建傳》附蘇武傳：“天漢元年，且鞮侯單于初立，恐漢襲之，乃曰：「漢天子我丈人行也。」盡歸漢使路充國等。武帝嘉其義，乃遣武以中郎將使持節送匈奴使留在漢者，因厚賂單于，答其善意。武與副中郎將張勝及假吏常惠等募士斥候百餘人俱。”蘇武奉使在天漢元年（前 100），又據本傳，蘇武“以始元六年春至京師”，始元六年爲前 81。從天漢元年到始元六年一共十九年，與本傳所說“武留匈奴凡十九歳，始以強壯出，及還，鬚髮盡白。”相合。但是本傳說“武年八十餘，神爵二年病卒。”神爵二年爲前 60，也就是說蘇武回來之後還活了二十一年，加上奉使的十九年，往前推四十年，則蘇武奉使時四十歲左右，不是黃生說的二十歲。另外，以丁作男丁之義，起于西晉（見沈家本《丁年考》），蘇武奉使是西漢，當時還沒有這種制度，當然也不可以援成丁之年來解釋丁年。《急就篇》最後一句是“長樂無極老復丁”，顏師古說：“復丁者，家有高年則蠲其子孫免賦役也。”這裏的丁是壯的意思，是說年老返壯，這裏的復跟《老子》裏的“復歸嬰兒”是一樣的。事實上，黃生的說法一方面將丁讀作當，另一方面又將丁讀作男丁的丁，左右遷就，反而左支右絀。\n古書中的確有丁讀作當的例子。《爾雅·釋詁》：“昌、敵、彊、應、丁，當也。”疏引《詩經·大雅·蕩之什·雲漢》“耗斁下土，寧丁我躬。”鄭箋：“丁，當也。”解釋說“（天）猶以旱耗敗天下，爲害曾使當我之身有此乎？”郝懿行《義疏》：\n丁者，與彊同義。《白虎通》云：“丁者，強也。”《釋名》云：“丁，當也。”神農之教曰：“丈夫丁壯而不耕”又曰：“婦人當年而不織”丁壯即當年也。丁當雙聲，丁鼎疊韻。《漢書·匡衡傳》云：“‘無說詩，匡鼎來。”服虔注：“‘鼎猶言當也。”賈誼傳云：“天子春秋鼎盛”亦其義也。\n王引之《經義述聞·卷二十六·爾雅上》：\n當字又有盛壯之義。《晏子春秋·外篇》曰：“兼壽不能殫其敎，當年不能究其禮。”《呂氏春秋·愛類篇》曰：“士有當年而不耕者，女有當年而不績者”。丁當一聲之轉。當年者，丁年也。丁年者，壯年也。《淮南齊俗篇》曰：丈夫丁壯而不耕，婦人當年而不織。《管子》揆度篇曰：“老者譙之，當壯者遣之邉戍。”當壯卽丁壯也。輕重丁篇：“男女當壯”〈輕重戊篇〉作“丁壯”。然則昌彊丁當又皆有盛壯之義。《爾雅》直訓彊為當，而郭云彊者，好與物相當値，則非其本指。昭十年《左傳》齊欒高氏彊於陳鮑氏。惠氏補注引《爾雅》彊當也，言與陳鲍相當値亦非。\n郝懿行引“匡鼎來”和“春秋鼎盛”，說兩者意思一樣，這是顏師古注的意思。但是顏師古注引用了三種不一樣的解釋，前兩種是服虔和應劭的說法。服虔注在“鼎猶言當也”後面還說“若言匡且來也”，也就是說雖然服虔將鼎讀作當，但是他認爲這裏是“且”，也就是他認爲這句的意思是“匡衡將要來”。應劭注則說：“鼎，方也。”是說這句應該是“匡方來”，也就是“匡衡正在前來”的意思。如果說“春秋鼎盛”和“匡鼎來”兩句裏的“鼎”是一樣的意思，只能將鼎讀成方，也就是春秋方盛和匡方來，“匡且來”雖然可以讀通，但是說“春秋且盛”則不成話。這兩句的鼎和《雲漢》中的“丁”用現代漢語來翻譯，應該是“正值/正當”的意思。《雲漢》裏的“寧丁我躬”是“大旱耗敗天下，偏偏正值/正當我身”，“匡鼎來”是匡衡正在/正當前來，“春秋鼎盛”則是春秋正值/正當盛。這是“丁”的其中一個意思。至於服虔認爲鼎讀作當，意思是“且”的用法，應該是後代（東漢末魏晉以降）的用法。丁聲樹《何當解》：“「何當」一詞晉宋已降文籍所恆見……所謂「何當」者率爲問時之詞。”又《早晚與何當》：“意者「何當」之「當」寓有將擬助詞之語意，故「何當」祇可施之於未然，而不能用以言已然。”\n丁還有另一個意思，相當於“當”字的“盛壯”之義。《說文·卷十四·丁部》丁字：“夏時萬物皆丁實。象形。丁承丙，象人心。凡丁之屬皆从丁。”小徐《繫傳》：“夏時，萬物皆丁壯成實。”《史記·律書》：“丙者，言陽道著明，故曰：丙；丁者，言萬物之丁壯也，故曰：丁。”《漢書·律曆志》：“出甲於甲，奮軋於乙，明炳於丙，大盛於丁，豐楙於戊，理紀於己，斂更於庚，悉新於辛，懷任於壬，陳揆於癸。”《律曆志》是用聲訓的辦法來解釋天干，軋和乙、炳和丙、楙和戊、紀和己、更和庚、新和辛、任和壬、揆和癸都音同或音近，盛和丁也音近。《史記》用壯訓丁，聲音上並不接近，所以《漢書》改用盛來訓釋丁。盛，廣韻梗攝三等常母清韻去聲承正切，上古在耕部；丁梗攝四等青韻平聲當經切，上古也在耕部。丁和當雖然都是端母，聲母一樣，韻母卻不一樣。丁上古在耕部，當上古在陽部，這兩部在《詩經》以至於兩漢的押韻絕不相混。黃生說“古丁、當同音”是不對的。丁、當韻母不同，如果說二者的意思相似是因爲它們在語音上有關係，只能乞靈於清人的一聲之轉。可是問題在於丁有當正當/正值和盛壯兩種意思，這兩種意思單獨與當的正當、盛壯的意思發生聯繫。從語音上將這兩種意思和兩種讀音聯繫起來，是不合適的。更好的解釋是丁作正當/正值講的時候，應該與貞、鼎在語音上有關。貞、鼎都是耕部字，貞是知母字，上古也是端母，鼎也是端母字，跟丁只有聲調不同。甲骨文中假借鼎字爲貞字，這是常識。《廣雅·釋詁三》：“貞，當也。”王念孫說：“貞之言丁也。”章太炎《說文授課筆記》就說：“貞，古讀丁，無舌上音故也。堅貞亦丁之假借。”所以王力《同源字典》將丁、貞列爲一條。\n最後再講一下當年的意思。當年大致有三種意思（不算後代出現的作以前講的意思），一種是本年、這一年，例如《文始真經·二柱篇》：“五雲之變，可以卜當年之豐歉；八風之朝，可以卜當時之吉凶。”當年和當時對舉，而且說雲氣的變化可以卜收穫的豐歉，很明顯是這一年的意思。第二種是壯年，《焦氏易林·隨之第十七》：“既濟，當年早寡，獨立孤居。”《大過之第二十八》：“泰，當年少寡，獨與孤處。”這兩句都是說婦女早早成了寡婦，一個人孤獨地生活，當年只能是壯年的意思。\n第三種意思比較微妙，有時似乎與壯年接近，但是如果仔細尋味，還是能發現這種意思並不等同於壯年，而應該理解成平生。《列子·楊朱第七》：“爲欲盡一生之歡，窮當年之樂。”這種用法似乎也可以當作壯年理解，說窮盡壯年的快樂也說的通。但是一生與當年對舉，解釋成平生似乎更好。《晏子春秋·外篇》曰：“兼壽不能殫其敎，當年不能究其禮。”當年與兼壽對舉，解釋成壯年似乎有點牽強。韋曜《博弈論》：“蓋君子恥當年而功不立，疾沒世而名不稱。”陸士衡《演連珠》：“是以貞女要名於沒世，烈士赴節於當年。”都是當年和沒世對舉，難道立功、赴節一定要在壯年？當然有人會說孔子說：“四十、五十而無聞焉，斯亦不足畏也已！”但是《禮記·曲禮上》說：“三十曰壯”，四十、五十肯定不能稱之爲是壯年。傅季友《爲宋公求加贈劉前軍表》說劉穆之：“勳高當年，而茅土弗及。”李善注引沈約宋書曰：“劉穆之，字道沖，東莞人，為前將軍，卒，追贈儀同三司。高祖又表於天子，於是重贈侍中、司徒，封南昌縣侯。”按《宋書》穆之本傳，穆之卒年五十八，五十八決不能稱爲壯年。即便把傅季友表中劉裕“陳力一紀”中劉穆之左右之的時間算進去，也不過是四十多歲，跟三十也差得遠。更何況，這篇表是在劉穆之死後寫的，說“勳高當年，而茅土弗及”，一定是說劉平生功勳很高，而不可能是壯年功勳很高。如果當年有平生的意思，那前面幾個例子的意思就迎刃而解了。《晏子春秋》“兼壽不能殫其敎，當年不能究其禮”是說活幾輩子都不能窮盡（孔子的）教誨（《史記·孔子世家》就說“累世不能殫其教”），一輩子也學不完（孔子的）禮儀。《博弈論》“蓋君子恥當年而功不立，疾沒世而名不稱”就是君子以一輩子不能立功爲恥，生怕死了而名聲不能彰顯。另外，陶淵明《庚子歲五月中從都還阻風於規林二首》其二“當年詎有幾，縱心復何疑”，逯欽立引丁福保注“晉人多以壯年爲當年”，是逯欽立也認爲這裏的當年應該理解成壯年。可是《歸去來辭》說：“寓形宇內復幾時？曷不委心任去留？”這句和《庚子阻風》詩中的兩句意思是一樣的，但是《歸去來辭》裏說的是“寓形宇內”，用現在的話說就是活在世上（能有幾年呢？），很明顯不是單指壯年。\n","permalink":"https://ge-chunyu.github.io/posts/2025-10-dingnian/","series":[],"tags":[],"title":"說丁年"},{"authors":[],"categories":[],"content":"Last year, I switched from Sublime Text to Neovim and Neovim has proved to be very efficient. This post showcases my Neovim setup and some useful tips.\nI agree with Guilherme D. Garcia that multiple tools for multiple purposes (RStudio for R, Sublime Text for markdown and $LaTeX$, etc.) is far from perfect, and Neovim indeed provided an integrated way of dealing with all these purposes (markdown/$LaTeX$, R, Python, and many more). It also provides the incredible capabilities of the Vim arsenal.\nI use the LazyVim and it ships with many useful and convenient functions. One of the Plugins that I use many times a day is Telescope. It can bring you the files you want using fuzzy finder with blazing speed.\nWhat I have always been confused is why dark colorschemes are so popular, and I\u0026rsquo;m far more comfortable with bright colorschemes. A few searching gave me the github-nvim-theme, which has a bright theme, and it has been very comfortable so far. I use the Consolas font for ASCII, but for Chinese characters, there are not so many options. Two fonts, Sarasa Term SC Nerd and Maple Mono, are the two most famous monospace fonts for Chinese characters, and they both align well with ASCII characters with a perfect 2:1 ratio. I chose Sarasa-Term-SC-Nerd because I find it asthetically more appealing.\nLuaSnip is a powerful snippet manager for Neovim, and using Lua, you can define your own snippets very quickly. For example, I need to insert the head of each blog post with title, author, date, etc, so I have a snippet for it.\n{ \u0026quot;Insert front matter\u0026quot;: { \u0026quot;prefix\u0026quot;: \u0026quot;meta\u0026quot;, \u0026quot;body\u0026quot;: [\u0026quot;---\u0026quot;, \u0026quot;title: ${1:title}\u0026quot;, \u0026quot;author: ${2:Chunyu Ge 葛淳宇}\u0026quot;, \u0026quot;documentclass: tufte-handout\\ndate: $CURRENT_YEAR-$CURRENT_MONTH-$CURRENT_DATE\\nnumbersections: false\\ndraft: yes\u0026quot;, \u0026quot;---\u0026quot;] } } Note that the snippet is in the VS-Code fashion, and the reason is that I haven\u0026rsquo;t figured out how to make the Lua version work in my MBP.\nFor running code in REPL, I installed the nvim-repl, which is very easy to set up and use.\nWhen I take notes using markdown, I use bullet points a lot. The bullets.vim plugin is great in demoting and promoting bullet types with Ctrl-t (denote) and Ctrl-d (promote).\nThanks to Neovim, now I stay in the terminal almost all day long, and I use tmux to manage the buffers and windows. The default statusline of tmux in at the bottom of the terminal window, which can be quite distracting for Neovim, because it also has the statusline on the bottom, so I moved the statusline of tmux to the top, and I use a minimalist configuration for the color scheme of the statusline, as shown below. Also, the default tmux prefix combination is Ctrl+b, but it conflicts with the back-half-page hotkey in vim, so I changed it to Ctrl-f, although it conflicts with the backpage hotkey. But it is very convenient, especially for touch typing.\nunbind C-b set-option -g prefix C-f set -g status-position top set -g status-style fg=white,bg=black setw -g window-status-current-style fg=white,bg=red,bright set -g status-left \u0026quot;\u0026quot; set -g status-right \u0026quot;\u0026quot; Convert markdown files to pdf, epub, and etc using Pandoc Now I have a more efficient and fast way to convert markdown files to pdf in Neovim than my earlier approach. I have the following autocommand which can quickly be called in Neovim, and after successful convertion, the pdf reader Sioyek will open automatically, showing the pdf file. I use Sioyek to preview the pdf file, because unlike Skim, it can use the same keybinding as vim, and makes it more convenient to navigate the pdf file.\nvim.opt_local.wrap = true -- -- Pandoc \u0026lt;format\u0026gt; to compile documents quickly and easily: vim.api.nvim_create_user_command(\u0026quot;Pandoc\u0026quot;, function() vim.cmd( \u0026quot;!pandoc -F pandoc-crossref --pdf-engine=xelatex --metadata-file=/Users/chunyu/template/metadata.yaml -H /Users/chunyu/template/head.tex \u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%p\u0026quot;)) .. \u0026quot; -o /Users/chunyu/pdf/\u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%:r\u0026quot;)) .. \u0026quot;.pdf \u0026amp;\u0026amp; open -a sioyek /Users/chunyu/pdf/\u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%:r\u0026quot;)) .. \u0026quot;.pdf\u0026quot; ) end, {}) What\u0026rsquo;s more, I can have more Pandoc commands, which can convert the markdown file to different formats. For example, I have another command, which converts markdown to epub files. I use the cool epub reader Readest to preview the epub file.\nvim.api.nvim_create_user_command(\u0026quot;PandocEpub\u0026quot;, function() vim.cmd( \u0026quot;!pandoc -V lang=zh --css /Users/chunyu/template/epub.css \u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%\u0026quot;)) .. \u0026quot; -o /Users/chunyu/pdf/\u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%:r\u0026quot;)) .. \u0026quot;.epub \u0026amp;\u0026amp; open -a Readest /Users/chunyu/pdf/\u0026quot; .. vim.fn.fnameescape(vim.fn.expand(\u0026quot;%:r\u0026quot;)) .. \u0026quot;.epub\u0026quot; ) end, {}) My Ghostty setup Compared to my previous terminal emulator, iTerm2, Ghostty is light-weight, and its can be configured using a config file. This is better than iTerm2 because it can be set up more quickly. Again, I chose the github-light theme for Ghostty, and I changed the default the icon to another cute one. I also defined some keybindings so that the movements across tabs and splits are smoother and more convenient. The following is my config file.\nfont-family = \u0026quot;Consolas\u0026quot; font-family = \u0026quot;Sarasa Term SC Nerd\u0026quot; font-size = 18 theme = github-light cursor-color = #4188d0 cursor-text = ffffff cursor-style = block background = ffffff selection-background = #4188d0 selection-foreground = ffffff window-decoration = true macos-icon = custom macos-titlebar-style = tabs unfocused-split-opacity = 0.6 keybind = cmd+left=previous_tab keybind = cmd+right=next_tab keybind = cmd+shift+right=goto_split:right keybind = cmd+shift+left=goto_split:left keybind = cmd+shift+up=goto_split:up keybind = cmd+shift+down=goto_split:down keybind = cmd+ctrl+right=resize_split:right,20 keybind = cmd+ctrl+left=resize_split:left,20 keybind = cmd+ctrl+up=resize_split:up,20 keybind = cmd+ctrl+down=resize_split:down,20 ","permalink":"https://ge-chunyu.github.io/posts/2025-11-neovim-setup/","series":[],"tags":[],"title":"My neovim setup (with Ghostty)"},{"authors":[],"categories":[],"content":"漢語裏人們常常說沒飯吃是“喝西北風”，例如詞典中常舉的吳敬梓《儒林外傳》第四十一回的：“都像你這一毛不拔，我們喝西北風。”那爲什麼是喝西北風，不是喝東南風、西南風呢？網上常見的說法是這跟我國的氣候地形有關。我國冬季吹西伯利亞南下的西北風，而這時正值冬天，如果沒有儲備，就只能忍飢挨餓，所以叫喝西北風。這種說法沒有依據，更何況漢語裏很少說冬天沒有糧食吃。說到沒有糧食，一般都是青黃不接，是指的春季莊稼剛剛播種，尚未長成，而舊穀已經吃完了。\n事實上，喝西北風恐怕是有相當古老的來源的。《左傳·哀公十三年》吳王夫差黃池之會後，越人已經攻入吳國，而吳王仍在與晉國爭奪盟會的班次，甚至連吳國將士也沒有糧食。所以吳國的申叔儀就向魯國的公孫有山氏乞求糧食。公孫有山氏回覆說，精細的糧食就沒有了，粗劣的還有一些。並且讓申叔儀登上首山，大呼：“庚癸乎”，那他就會借糧食給申叔儀。\n“吳申叔儀乞糧於公孫有山氏，曰：‘佩玉繠兮，余無所繫之；旨酒一盛兮，余與褐之父睨之。’（公孫有山氏）對曰：‘粱則無矣，麤則有之。若登首山以呼曰，庚癸乎，则诺。’”\n爲什麼要讓申叔儀大呼“庚癸乎”呢？杜注說：“軍中不得出糧，故爲私隱。庚，西方，主穀。癸，北方，主水。”杜預的解釋是，在軍中不能出糧，所以要用隱祕的暗號；而之所以叫“庚癸”，則是因爲庚對應西方，代表糧食，癸對應北方，代表水。正義說：\n“庚在西方，穀以秋熟，故以庚主穀。癸在北方，居水之位，故以癸主水。言欲致飯并致飲也。”\n庚在西方，在四季中對應秋季，正是糧食成熟的季節，所以可以代表糧食；而癸在西方，在五行中對應水，所以用來代表水。大呼“庚癸乎”，就是暗示自己需要糧食和水。庚和癸分別對應西方和北方，如果把他們連起來，就是西北。現在人們在飢餓困窘的時候就會說“喝西北風”，正和申叔儀沒有糧食吃，而必須向魯國人借糧食的處境是一樣的。那爲什麼是風呢？這是因爲古人不僅將干支與五星、五行、四季對應，還跟八風、六律對應。《史記·律書》中說：\n廣莫風居北方……其於十母爲壬癸……癸之爲言揆也，言萬物可揆度……閶闔風居西方……其於十母爲庚辛。庚者，言陰氣庚萬物\n《淮南子·天文訓》也說：\n西方，金也，其帝少昊，其佐蓐收，執矩而治秋。其神為太白，其獸白虎，其音商，其日庚辛。北方，水也，其帝顓頊，其佐玄冥，執權而治冬。其神為辰星，其獸玄武，其音羽，其日壬癸。\n根據《淮南子》和《史記》中的說法，天干與五方、四季、五星、五行、八風的對應關係如下。由於季節只有四個，所以用四方來和戊己配，湊成五組；同時，戊己不跟四方對應，也就沒有與之對應的八風。\n天干 五星 五行 四方 四季 八風 甲乙 歲星 木 東方 春 明庶風 丙丁 熒惑 火 南方 夏 景風 戊己 鎮星 土 中央 四方 庚辛 太白 金 西方 秋 閶闔風 壬癸 辰星 水 北方 冬 廣莫風 所以，喝西北風應該是西風和北方，而不是西北風。古人可能很早就用與西北對應的天干來指代食物，兩漢之後干支在日常生活中的使用逐漸減少，人們就逐漸用方位來代替干支。而所謂飢者歌其食、勞者歌其事，人們在迫切需要食物的時候，更會呼喊食物，漸漸地“喝西北風”也就可以用來指沒飯吃了。\n","permalink":"https://ge-chunyu.github.io/posts/2024-12-xibeifeng/","series":[],"tags":[],"title":"爲什麼是“喝西北風”"},{"authors":[],"categories":[],"content":"Substitution in vim is very efficient, especially with the help of expressions. This is especially useful for calculations. I discovered this usage when I wanted to insert a list of numbers to the beginning of each line. But before go to the example, let’s take a look at expressions in vim substitution.\nThe expressions in vim are marked with “=”. This tells vim to treat the contents after “=” as expressions rather than literal texts. For example, vim will treat \\=1+1 as 2 rather than the text 1+1. Using \\=, I can insert numbers in the beginning of each line with expressions.\ns/^/\\=line(\u0026quot;.\u0026quot;)/ line(\u0026quot;.\u0026quot;) stands for the line number of the current line. I use ^ to capture the beginning of the line and add line numbers before each line and the output is:\n19text1 20text2 21text3 \\= can combine with printf() to achieve nicer output. To have a number before each line is good, but it looks better with a trailing dot and space . , so that it looks like a numbered list. I can do this with the following line.\ns/^/\\=printf(\u0026quot;%s. \u0026quot;, line(\u0026quot;.\u0026quot;))/ %s tells vim that there is a string, and the string is the following argument line(\u0026quot;.\u0026quot;), the line number of the current line. Also, there is a dot and a space . after the string. This gives the following output.\n33. text1 34. text2 35. text3 Vim can also do simple calculations with \\=. For example, sometimes I want to insert the relative line number rather than the absolute line number. To do that, I first enter the Visual mode with V, and select the lines I want to work with. Type the colon : in the commandline will give us :'\u0026lt;,'\u0026gt;. This shows that the operations will be done within the selected part. The line number of the first line under selection is line(\u0026quot;'\u0026lt;\u0026quot;), and the number of the last line is line(\u0026quot;'\u0026gt;\u0026quot;). Also, the line number of the current line is “line(”.\u0026quot;)\u0026quot;. Therefore, the relative line number of the current line is line(\u0026quot;.\u0026quot;)-line(\u0026quot;'\u0026lt;\u0026quot;)+1. I added 1 to the number because the first line should also be 1. The previous command is revised into:\ns/^/\\=printf(\u0026quot;%s. \u0026quot;, line(\u0026quot;.\u0026quot;)-line(\u0026quot;'\u0026lt;\u0026quot;))/ And the output is:\n1. text1 2. text2 3. text3 A tricky point in calculations in the expressions is that it cannot handle divisions, because the division sign / is the same as the separator / used in vim substitution. I can use # to surround the patterns that vim needs to findand put the substituted contents after the second #. For instance, I can divide the relative line numbers by 2, so that the line numbers would be 0, 1, 1, 2, 2, 3, 3…\ns#^#\\=printf(\u0026quot;%s. \u0026quot;, (line(\u0026quot;.\u0026quot;)-line(\u0026quot;'\u0026lt;\u0026quot;))/2) 0. text1 1. text2 1. text3 2. text4 2. text5 Now I know eough about expressions in vim substitutions, and I can go back to my original task to add numbers to the beginning of each line, and most importantly, I do not want the empty lines to interfere the numbering. So, what I have is:\ntext1 text2 text3 And what I want is:\n1. text1 2. text2 3. text3 Basic calculation can do that. I can divide the relative line numbers by 2 and add 1, and the command is:\ns#^.#\\=printf(\u0026quot;%s. \u0026quot;, (line('.')-line(\u0026quot;'\u0026lt;\u0026quot;))/2+1) Also, to capture the non-empty lines, I use ^.. That is to say, only add numbers on lines which have a character after the beginning of the line.\nHowever, the outputis like the following. Because with ^., I substituted the beginning of the line together with the first character!\n1. ext1 2. ext2 3. ext3 I have to add the first character back by submatch(0). submatch() returns matches from the pattern. With number 0, it returns the whole match, and with 1 to 9, it returns the first to the 9th submatch. So the command is:\ns#\\(^.\\)#\\=printf(\u0026quot;%s. %s\u0026quot;, (line('.')-line(\u0026quot;'\u0026lt;\u0026quot;))/2+1, submatch(0)) Ta-dah! Here is the result!\n1. text1 2. text2 3. text3 Useful links:\nVim Substitute Tricks ","permalink":"https://ge-chunyu.github.io/posts/2024-09-substitution-vim/","series":[],"tags":[],"title":"Substitution in Vim with expressions"},{"authors":[],"categories":[],"content":"I am learning vim and I want to migrate my workflow in Sublime Text to vim. One of the things I do most with Sublime Text is to write markdown files and convert them to pdf files using Pandoc. After some search, I did not find a satisfied plugin which does such a job. The vim-pandoc seems to be too powerful. I did some more search and found this post, which is very informative and I follow the instructions to create my own plugin to convert markdown files to pdf files using pandoc in vim.\nThe approach is quite straighforward. Pandoc as a commandline tool can be called within vim.\n:!pandoc '%' -o '%:r'.pdf The % represents the current file together with its path and %:r stands for the current file with the extension (i.e., .md in this case) stripped. However, type such a long command each time would be very time-consuming and annoying. To more conveniently call it, the command can be put in a vim compiler plugin.\nThe vim compiler plugin is put inside .vim/after/compiler and the compiler contains the following commands.\nlet current_compiler=\u0026quot;pandoc-md\u0026quot; CompilerSet makeprg=pandoc\\ -F\\ pandoc-crossref\\ --pdf-engine=xelatex\\ --metadata-file='~/Documents/notes/template/metadata.yaml'\\ -H\\ '~/Documents/notes/template/head.tex'\\ '%'\\ -o\\ ~/Documents/notes/pdf/'%:t:r'.pdf CompilerSet errorformat= First, I define a compiler named pandoc-md and then the command to run when calling :make in vim. The makeprg is very long and needs some explanation. All spaces in makeprg need to be escaped with a slash \\, just as in .vimrc when we define what to display on the statusline. Since my pdf files use customized layout, I also specified some metadata and a \\LaTeX template with the --metadata-file and -H flags. The paths of these files should be inside quotation marks.\nI don\u0026rsquo;t want to get pdf files with the names filename.md.pdf, so I use %:r.pdf to refer to the file name without the extension. Also, as I want to put all my pdf files in a pdf folder, I specified the folder in makeprg, but note that this path, unlike those of the metadata file and the \\LaTeX template, is not inside quotation marks.\nAnother thing is that I use :t to refer to the file name without the full path [^cmd-special]. Therefore, the resulting file would be put in the folder ~/Documents/notes/pdf.\nOne last thing is to create an autocmd to set the compiler for markdown files only. I put the following line in my .vimrc, so that each time I run :make each time within vim, the markdown file will be automatically converted to pdf files and stored in the specified folder.\nautocmd FileType markdown compiler pandoc-md A sidenote: Convert markdown files to pdf files in Sublime Text Sublime Text has a very convenient build system which I use to convert markdown files to pdf files. Click Tools on the toolbar and then to Build System and New Build System to create a new system. Put the following commands in the file and save it as Pandoc.sublime-build.\n{ \u0026quot;working_dir\u0026quot;: \u0026quot;~/Documents/notes/pdf\u0026quot;, \u0026quot;shell_cmd\u0026quot;: \u0026quot;pandoc -F pandoc-crossref --pdf-engine=xelatex --metadata-file='~/Documents/notes/template/metadata.yaml' -H \\\u0026quot;~/Documents/notes/template/head.tex\\\u0026quot; \\\u0026quot;$file\\\u0026quot; -o \\\u0026quot;$file_base_name.pdf\\\u0026quot; \u0026amp;\u0026amp; open -a Preview \\\u0026quot;$file_base_name.pdf\\\u0026quot;\u0026quot;, \u0026quot;selector\u0026quot;: \u0026quot;text.html.markdown\u0026quot;, \u0026quot;path\u0026quot;: \u0026quot;/usr/texbin:$PATH\u0026quot; } References and related posts Learn to Create a Vim Compiler Plugin From Pandoc to Batch Convert Markdown Files to HTML Compiling LaTeX Documents in a Vim-Based Workflow 用pandoc生成大型中文文档的痛点与解决方案 Customizing pdf output of Pandoc Writing academic papers using Sublime Text 3 + Pandoc ","permalink":"https://ge-chunyu.github.io/posts/2024-08-pandoc-vim/","series":[],"tags":[],"title":"Convert markdown files to pdf files using pandoc in vim"},{"authors":[],"categories":[],"content":"Preliminaries: The challenge of dynamic data Phonetics used to concern mostly with static data, such as VOT, formant values at vowel midpoint, or F0 at vowel onset. But as computers are getting more and more powerful, it is common (almost a necessity) to analyze dynamic data. For example, instead of F0 at vowel onset, pitch contour during the voiced parts needs to be analyzed, and similarly, formant trajectories are analyzed instead of formant values at vowel midpoints.\nThere are in general two main approaches to analyze dynamic data. The first approach is to decompose dynamic data into simpler parameters. For example, Discrete Cosine Transform (DCT) can decompose functions into multiple coefficients, among which $k_0$ is related to mean/intercept, $k_1$ to slope, and $k_2$ to (parabolic) curve. Another approach is to model the dynamics itself either using polynomials (linear models) or the addition of multiple base functions (additive models). Linear regression uses polynomials to model dynamic data, while generalized additive models employs the addition of multiple base functions.\nDifferent kinds of dynamic data Dynamic data can be divided into different types, according to its complexity. The following lists several common functions.\n$$\\text{Linear: }y = ax + b$$ $$\\text{Quadratic: }y = ax^2+bx+c$$ $$\\text{Cubic: }y = ax^3+bx^2+cx+d$$ $$\\text{Quartic: }y = ax^4+bx^3+cx^2+dx+e$$ $$\\text{Exponential: }y = e^x$$ $$\\text{Sine: }y = sin(x)$$\nLinear functions are the easiest to analyze, because only an intercept and a slope are needed to capture a linear function. Linear mixed-effects models can be used to analyze linear functions.\nQuadratic, cubic an quartic functions are more challenging, but an extension of linear mixed-effects models, Growth Curve Analysis (GCA, Mirman 2014) can be used to analyze such functions.\nExponential and sine functions, however, cannot be handled by GCA, because it cannot be decomposed into a linear component and non-linear components. However, some other statistical methods are able to model such non-linear data, including Generalized Additive Models (GAM) and Functional Data Analysis (FDA). In essence, GAM and FDA are the same in that they use the addition of basis functions to model complex curves.\nWorkflow of GAMM Fitting GAMM in R is achieved using the mgcv package and data visualization is usually achieved using the itsadug 1 package. GAMM can be fitted using the gam function, but more often it is fitted using bam for very large datasets.\nlibrary(mgcv) library(itsadug) The basic workflow of GAMM is as follows:\nCreate an ordered factor for the factors of interest Fit the model with gam() or bam() Handling autocorrelation errors Model criticism Visualization of results Significance testing The reason to change the factor into an ordered factor is that the constant difference (the parametric coefficients) and the non-linear difference can be distinguished (Wieling 2018:94). To do that, using the following code. Also, the factor needs to be changed into treatment coding.\ndata$factor \u0026lt;- as.ordered(data$factor) contrasts(data$factor) \u0026lt;- \u0026quot;contr.treatment\u0026quot; Another thing to note is that if several factors of interest are involved, it is not recommended to fit separate models for separate factors. A more informed solution is to construct a new variable based on the factors of interest (Wieling 2018:106). For example, if there are two factors of interest, tone and generation, the two factors can be combined to create a new factor toneGeneration using the following code. The function interaction() enables the order in the original factors to be preserved in the combined factor.\ndata$factor \u0026lt;- interaction(factor1, factor2) GAMMs can be fitted with formulae structures similar to those used in lme4. For parametric coefficients, simply include the factor, but for smooth factors, you need to surround the factors with s() (means the smooths) and some additional parameters need to be specified. Within each smooth, there are several things you can change. The parameter bs= specifies the types of basis spline functions, and it can take values such as tp (the default thin plate regression spline), cr (cubic regression spline). Another parameter k can be specifed and it stands for how many basis functions are needed. The default value of k is 10 and for pitch values within one syllable, there are usually only ten values, and k can be set to $9=10-1$.\nmodel \u0026lt;- bam(f0 ~ tone + # the parametric coefficient s(time) + # the smooth term s(time, by = factor) + # the smooth term by tone s(time, speaker, bs = \u0026quot;fs\u0026quot;, m = 1), # random smooth data = data, rho = rho1, # specify the autocorrelation error factor AR.start = data$start.event, discrete = TRUE) # use this to speed up model fitting GAMM, as the second M stands for mixed-effects, is also able to model random effects 2. Three types of random effects can be included, random intercept, random slope and random smooth. The formulae below shows the formalization in mgcv. As in fixed effects, bs stands for basis spline functions. re stands for random effects, and fs stands for factor smooth, in which a separate smooth is fitted for each level in the random factor. The nonlinear penalty is specified using the parameter m, and when it equals 1, it means that the first derivative is penalized.\ns(speaker, bs = \u0026quot;re\u0026quot;) # random intercept by speaker s(speaker, factor, bs = \u0026quot;re\u0026quot;) # random slope of tone by speaker s(time, speaker, bs = \u0026quot;fs\u0026quot;, m = 1) # random smooth of tone by speaker Of course, it is possible to fit smooth on two dimensions, and this is achieved by te() (a full tensor product) or ti() (a tensor product interaction) in the formulae. The third case study in Chuang et al. (2021) is a friendly hands-on tutorial on this kind of analysis.\nHandling autocorrelation One kind of error in time series data which is usually ignored is the autocorrelated error (Baayen et al. 2018). It refers to the correlation between the measuring points. Autocorrelated error can be visualized as a function of lag, i.e., the correlation between the present point with the previous n points. When lag is 0, it refers to the correlation of the point with itself and therefore is 1. When lag is 1, it refers to the correlation of the point with the immediately preceding point, and it is also called AR(1), the autocorrelated residual at lag 1. This is the value usually used in fitting GAMMs with autocorrelated errors taken into consideration, and it is called the AR1 error model.\nBefore specifying AR(1), the data should be revised to specify the starting point of each time series, using the start_event() function in itsadug.\ndata \u0026lt;- start_event(data, event= \u0026quot;factor\u0026quot;) After that, GAMM can be fitted on the data first without autocorrelated errors. This model can be used to get the AR(1) value and this value can be used to fit an AR1 error model with the same model structure as the previous one. AR1 error can be get using two functions, as shown in the following code. The value can then be fed into the gam() or bam() function by specifying the rho parameter.\nr1 \u0026lt;- start_value_rho(model) r1 \u0026lt;- acf_resid(model)[2] Model criticism Like linear models, GAMMs also need to check their residual values. The gam.check() function provides important dignosis information on the model. It generates four plots. The first plot is a normal quantile plot. This plot can be used to diagnose whether the model residuals follow a normal distribution. If the points all fall on the red line, it shows that the residuals follow a normal distribution. Sometimes, the residuals can have two heavy tails, suggesting a t-distribution. In this scenario, the data should be fitted instead with a scaled-t distribution, by specifying family=\u0026quot;scat\u0026quot; (Chuang et al. 2021:18). The histogram of residuals can also be used to help diagnose residual distribution.\nThe two scatter plots can be used to assess heteroscedasticity, which refers to the unequal variance depending on the values of the predictors or the ﬁtted values. If the variability is correlated with the predictors or fitted values, the homoscedasticity assumption is said to be violated.\nVisualization with GAMM The most popular way to visualize the data using GAMM is to plot the fit and the difference curve of the data. For the interaction of two numerical variable, heat map is also usually used. Visualization with GAMM is usually achieved using the itsadug package. It is also possible to extract the data and visualize it in ggplot2, which enables finer control over aesthetics and layout 3.\nGAMM results are usually visualized with smooth plots and difference curves. Smooth curves plot the model predicted smooths, while difference curves plot the difference between the curve of one level and the one of the reference level within a specific factor.\nThe plot_smooth() function in itsadug can be used to plot smooth curves, and the basic usage is exemplified as below. To plot the smooth curves, a GAMM object is needed and then you need to choose on which factor the smooth curves are on. The plot_allparameter specifies the factor you want to plot. Model summary can be printed with print.summary equals TRUE, and otherwise with FALSE. The random effects can be included by setting rm.ranef to FALSE, and removed by setting it to TRUE.\nplot_smooth(model, view = \u0026quot;time\u0026quot;, plot_all = \u0026quot;factor\u0026quot;, print.summary = FALSE, rm.ranef = FALSE) Apart from smooth curves, difference curves can also be plotted using the plot_diff() function. As plot_smooth(), a model and a smooth factor need to be specified, and it also requires a comparison factor. The comp parameter specifies which factor levels you want to coompare. The resultant figure is a curve with a horizontal zero line. If the shaded area (the 95% confidence interval) contains the zero line, then the difference can be said to be not significant, and otherwise, it is said to be significant.\nplot_diff(model, view = \u0026quot;time\u0026quot;, comp = list(factor = c(\u0026quot;level1\u0026quot;, \u0026quot;level2\u0026quot;)), print.summary = FALSE) These functions can also be used to get the data and to plot it in ggplot2 (of course, get model prediction is a better approach). The model fit data can be accessed using the following codes. Another alternative is to use functions in tidymv and a more recent tidygam package.\n# get model fit data fitData \u0026lt;- plot_smooth(model, view = \u0026quot;time\u0026quot;, plot_all = \u0026quot;factor\u0026quot;, print.summary = FALSE, rug = FALSE, rm.ranef = TRUE)$fv Significance testing with GAMM Factors can influence various aspects of dynamic data. Dynamic data can differ in intercept only, slope only, and also in the overall shape. Also, it is possible that curves can be different in some part but not in others. Although visualization provides a more straightforward way to interpret the results, significance testing is a necessity for confirmatory studies in particular. Significance testing with GAMM can be achieved by summary statistics, model comparison and visual methods.\nSóskuthy (2021) evaluated the random effect structures and significance testing in GAMM. Like all other models, GAMM results can be summarized with summary statistics. The summary of GAMM can be divided into two parts, the parametric coefficients showing the difference in intercept (overall height of the curve) and the smooth terms showing the difference in smooth. t-tests are used to get p-values for parametric coefficients, while F-tests are used for smooth terms. If there is a significant effect in parametric coefficients, it indicates that the curves are different in overall height due to predictors. On the other hand, if there is a significant effect in smooth terms, it is said that the curves have difference shapes due to predictors.\nApart from testing significance using model summaries, it is also possible to achieve it using model comparison. This can be done using the compareML() function in itsadug, which is the same in essence with the anova() function used to compare linear mixed-effects models.\nFurther reading Baayen, R. H., van Rij, J., de Cat, C., \u0026amp; Wood, S. (2018). Autocorrelated Errors in Experimental Data in the Language Sciences: Some Solutions Offered by Generalized Additive Mixed Models. In D. Speelman, K. Heylen, \u0026amp; D. Geeraerts (Eds.), Mixed-Effects Regression Models in Linguistics (pp. 49\u0026ndash;69). Springer International Publishing. https://doi.org/10.1007/978-3-319-69830-4_4\nIntroduces the problem of autocorrelated error in dynamic data analysis and provides a solution by including an autoregressive AR(1) process for the errors. The solution is to first fit a model without autocorrelation and get the autoregressive proportionality. It is specified using the rho parameter and another model is fitted with this parameter.\nChuang, Y.-Y., Fon, J., Papakyritsis, I., \u0026amp; Baayen, H. (2021). Analyzing Phonetic Data with Generalized Additive Mixed Models. In M. J. Ball (Ed.), Manual of Clinical Phonetics (1st ed., pp. 108\u0026ndash;138). Routledge. https://doi.org/10.4324/9780429320903-10\nProvides three case studies, which demonstrates the full capacity of GAMM in analyzing linguistic data.\nSóskuthy, M. (2021). Evaluating generalised additive mixed modelling strategies for dynamic speech analysis. Journal of Phonetics, 84, 101017. https://doi.org/10.1016/j.wocn.2020.101017\nA critical paper on random effect structure and significance testing using GAMM.\nWieling, M. (2018). Analyzing dynamic phonetic data using generalized additive mixed modeling: A tutorial focusing on articulatory differences between L1 and L2 speakers of English. Journal of Phonetics, 70, 86\u0026ndash;116. https://doi.org/10.1016/j.wocn.2018.03.002\nA step-by-step hands-on tutorial of GAMM using phonetic data.\nWood, S. N. (2017). Generalized additive models: An introduction with R (Second edition). CRC Press Taylor \u0026amp; Francis Group.\nA comprehensive book on Generalized additive models, with many mathematical and implementation details.\nvan Rij, J. (2015). Overview GAMM analysis of time series data. https://jacolienvanrij.com/Tutorials/GAMM.html\nAn online tutorial by van Rij.\nSóskuthy, M. (2017). Generalised additive mixed models for dynamic analysis in linguistics: A practical introduction (arXiv:1703.05339). arXiv. https://doi.org/10.48550/arXiv.1703.05339\nA preprint with more detailed guide on GAMM.\nvan Rij, J., Wieling, M., Baayen, R. H., \u0026amp; van Rijn, H. (2020). itsadug: Interpreting time series and autocorrelated data using GAMMs.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nSee the following paper for random effects in linear mixed-effects models: Barr, D. J., Levy, R., Scheepers, C., \u0026amp; Tily, H. J. (2013). Random effects structure for confirmatory hypothesis testing: Keep it maximal. Journal of Memory and Language, 68(3), 255\u0026ndash;278. https://doi.org/10.1016/j.jml.2012.11.001\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nSee also the following link on using tidymv to plot GAMM results: https://cran.r-project.org/web/packages/tidymv/vignettes/plot-smooths.html.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2024-04-gamm/","series":[],"tags":[],"title":"A tutorial on generalized additive mixed-effects model (GAMM)"},{"authors":[],"categories":[],"content":"Digital data is easy to copy and also easy to lose, due to (usually sudden) failure of electronic devices. A good habit is to backup regularly and in different locations. This post is about my solution to data backup.\nClassification of digital data Digital data can be classified according to their importance and sizes, and the following lists some of the categories based on their importance.\nData that can be downloaded online Papers and e-books collected from various sources Personal photos and videos Experimental data and code Personal documents and writings Data that can be downloaded online is the lease important, since they can be easily accessed online and even it\u0026rsquo;s lost, it can be easily found online. Papers and e-books (or other resources) that are collected from various sources and clearly organized are more important. Some resources are hard to find, and once it is found, it\u0026rsquo;s better to keep it safe and have multiple copies. Personal photos and videos are even more important, to keep a record of ones\u0026rsquo;s life and happy memories.\nThe most important data are experimental data and code (related to work), and personal documents and writings (personal life). Experimental data can sometimes be very large, but code and personal documents and writings (and notes) are usually in plain text format and are far smaller in size. My solution to data backup is based on the importance of data and their sizes.\nMy solution to data backup Some say that it\u0026rsquo;s best to have two local backups, one online backup and one backup in another place. Of course, it\u0026rsquo;s not always possible to have them all. My Macbook Pro is the centre of all my data and the data are usually backup using Time Machine to a hard drive. I also have a SSD drive, which keeps a backup of large files, including paper and documents collected online, and personal photos and videos. Therefore, I have three local backups in total.\nFor experimental data and code, in addition to local backups, I also upload the data to Onedrive, with the service provided by my organization. It\u0026rsquo;s good for large data and very handy for sharing data with colleagues. I also use online backup for my notes. I previous use Nutstore to backup the writings and notes, but now it simply keeps another online copy for my notes and writings. I use rsync to sync these data to online locations. For example, my notes are synchronized to Onedrive using the following command.\nrsync -av --exclude-from '~/Documents/notes/ignore.txt' ~/Documents/notes/ ~/Documents/OneDrive/notes Some of my code are in github, and some data and scripts for my papers are uploaded to OSF. But these are used for sharing instead of backup.\nI use Syncthing to backup my personal documents and writings. Syncthing is a private and secure tool which synchronizes data among multiple devices. It is cross-platform and perfect for personal documents, writings and notes, which are usually small in size. I use Syncthing to synchronize these data across my MBP, my phone and the Raspberry Pi in my office. Syncthing can also backup the photos I take with my phone to my MBP.\nMy backup can be summarized as below,\nlocal MBP hard drive SSD drive phone (personal documents, writings and notes) using Syncthing Raspberry using Syncthing online Onedrive Nutstore github OSF ","permalink":"https://ge-chunyu.github.io/posts/2024-03-backup/","series":[],"tags":["Miscellaneous"],"title":"How I backup my data"},{"authors":[],"categories":[],"content":"東晉葛洪有《肘後備急方》，取其卷帙短小，可以繫於肘後，隨時查閱的意思。兩漢魏晉時候的人往往會將隨身攜帶的飾物、印章等繫於肘後。文獻中雖然例子不多，但仔細鉤稽，仍可以推測其彷彿。《世說新語·尤悔第三十三》第六條：\n王大將軍起事，丞相兄弟詣闕謝。周侯深憂諸王，始入，甚有憂色。丞相呼周侯曰：“百口委卿！”周直過不應。既入，苦相存救。既釋，周大說，飲酒。及出，諸王故在門。周曰：“今年殺諸賊奴，當取金印如斗大繫肘後。”大將軍至石頭，問丞相曰：“周侯可爲三公不？”丞相不答。又問：“可爲尚書令不？”又不應。因云：“如此，唯當殺之耳！”復默然。逮周侯被害，丞相後知周侯救己，歎曰：“我不殺周侯，周侯由我而死。幽冥中負此人！”\n這是王導不知道周覬雖然表面沒有好臉色，但其實在皇帝面前救護王氏，最終因循縱容導致周覬被王敦所殺的故事。周覬對王導說的“當取金印如斗大繫肘後”，說明當時的人有將印章繫在胳膊肘後面的習慣。周覬與葛洪是同時人，可見肘後的確是當時繫雜物，方便拿取之地。\n其實將印章等繫在肘後並不始於東晉，至少在西漢時候人們已經這樣做了。《急就篇》相傳是漢元帝時黃門令史游所作，其中第十四章：“係臂琅玕虎魄龍”，顏師古注說：“言以虎魄爲龍，并取琅玕，係著臂肘，取其媚好且珍貴也。”同章又有：“射鬾辟邪除羣凶”，顏師古注說：\n一曰，射鬾謂天剛卯也，以金玉及桃木刻而爲之，一名欬改，其上有銘，而旁穿孔，系以綵絲，用係臂焉，亦所以逐精魅也。\n也就是說“射鬾”也有人說是“天剛卯”，是金玉和桃木刻成的一種裝飾品，上面有銘文，並且穿孔系有彩色絲帶，可以繫在胳膊上，用來驅除妖怪的。這可見西漢時候的人已經有將物品繫在肘後的習慣了，而顏師古對此也不致陌生，足見此風至隋唐時期猶有緒餘。\n其實，將東西繫在胳膊肘後面，既不影響日常活動，又方便拿取，歷代恐怕都有這種風氣。2020 年以來，人人戴口罩。有時將口罩摘下，就會隨手套在胳膊上，正好在胳膊肘的位置。這也是“肘後備急”的當代應用了。\n","permalink":"https://ge-chunyu.github.io/posts/2023-11-zhouhou/","series":[],"tags":["Miscellaneous"],"title":"說“肘後”"},{"authors":[],"categories":[],"content":"It is very common for phoneticians to ask speakers to read aloud word lists, especially in the field. However, to find a word in a long sound file is very painful and a better solution is to split the long sound file into short files with meaningful file names. I wrote a Praat script for that purpose and to save some time, I also use the script to fill in the transcriptions to the TextGrid file. This post is a documentation of the script, which can be found in my github.\nPrerequisites A long sound file A metadata file of the wordlist which contains at least four columns word: the words or gloss, for your own reference label: the transcription of the words, to fill in the TextGrid file ID: the file name of each word, to rename the short sound files number: the number indicating the order of the word in the word list splitLongSound.praat: the Praat script to split the long sound file Procedures Open the Praat script (splitLongSound.praat) Input the required information and run the script. The required information include the directory of the long sound file the filename of the long sound file, and the extension (i.e., .wav) is not needed the directory to store the short sound files the directory of the matedata file ID of the speaker: it will be prefixed to the short file names vowel pattern: a regular expression of the pattern of vowel parts of the words Listen to the recording and add the number of the word for example, when you hear the first word, add the number 1 (because it's the first word in the list) after \u0026ldquo;sound\u0026rdquo; in the TextGrid The number column in the metadata file can be used here Note that \u0026ldquo;sound\u0026rdquo; cannot be deleted No need to modify any other texts and intervals in the TextGrid file But when the interval before or after the sound is too long and you want to trim it a little bit shorter, you can add a boundary before or after the sound Proceed to all the words and complete the sound file Click done and now all short sound files are saved You can also listen to some of the words and come back next time. The textgrid file is saved and can be read and revised in the future. You can click next time (no short sound file is saved) or done (only those with a number in the TextGrid will be saved)\nThere are two tiers in the short TextGrid files, \u0026ldquo;syllable\u0026rdquo; and \u0026ldquo;segment\u0026rdquo;. This script is especially useful for Chinese and other monosyllabic languages, with simple phonotactics. On the \u0026ldquo;syllable\u0026rdquo; tier, the transcriptions of the syllable will be automatically filled in, and on the \u0026ldquo;segment\u0026rdquo; tier, the onsets and vowels will be automatically segmented with corresponding transcriptions identified using the vowelPattern regular expression.\nAlso note that, if the long sound file has two channels (e.g., audio and EGG recordings), the second channel is also extracted separately and named with a suffix (-EGG) in the file. You can change this on line 123.\n","permalink":"https://ge-chunyu.github.io/posts/2023-09-pseudo-forced-alignment/","series":[],"tags":["Praat"],"title":"Pseudo forced alignment using a Praat script"},{"authors":[],"categories":[],"content":"Making a linguistic handout needs some tricks. Using MS word is not ideal because the output is not that beautiful and linguistic contents are not . In this post I explain how I make a linguistic handout with markdown and of course LaTeX.\nThe workflow I usually write documents using markdown and convert it to pdf using pandoc, as explained in my previous posts. I have a same head/template for all handouts, so that the style remains the same for a course. I use different LaTeX packages to format various linguistic contents.\nTools and LaTeX packages The following lists some of the packages I use to typeset linguistic contents.\ntikz-qtree: Draw syntactic trees and feature geometry linguex: Manage linguistic examples vowel: Draw vowel charts phonrule: Typeset phonological rules tipa: Input IPA TikZ: Draw various figures These packages are very convenient and easy to use, but some more explanation maybe better for more efficient use of them. tikz-qtree can easily draw syntax trees and feature geometry, but it does not provide a functionality for the delinking of linking lines. For such a case, I use some the tikz library positioning to add a equal symbol to the line.\n\\begin{tikzpicture} \\Tree[.+consonant [.\\node(l2){laryngeal}; \\node(a2){aspiration}; ] [.supralaryngeal ] ] \\draw[dashed] (a1) to[bend right=80] (a2); # add the equal symbol \\node[below= 0.012cm of l2] {=}; \\end{tikzpicture} Preparing exam papers Finally, I write pure LaTeX when preparing exam papers, to get more control over the layout. In addition to the packages mentioned above, I use the package exam to format T/F questions, multiple choices, and fill-in the blanks, etc.\n","permalink":"https://ge-chunyu.github.io/posts/2023-05-handout/","series":[],"tags":["Latex","Linguistics"],"title":"How I make a linguistic handout"},{"authors":[],"categories":[],"content":"It is sometimes useful to export and import the bookmarks of an existing pdf file to a new pdf file with smaller size. This can be easily done using pdftk. pdftk is available as GUI and commandline tools. In MacOS, it is better to use it in the terminal. After installation of pdftk, the bookmarks of one pdf file can be extracted from an existing pdf file and imported to a new pdf file using the following lines.\n# export dump_data from the original file pdftk originalFile.pdf dump_data output bookmark.txt # import dump_data to the new file pdftk newFile.pdf update_info bookmark.txt output newFileWithBookmark.pdf Of course, it is also possible to export the bookmark information as a text file:\npdftk originalFile.pdf dump_data_utf8 | grep '^Bookmark' \u0026gt; bookmark.txt After that, the bookmark can be added to the new file alternatively by the LaTeX package bookmark. The following shows a minimal example (see more explanations in Michael H. Goerz\u0026rsquo;s post.\n\\documentclass{article} \\usepackage[utf8]{inputenc} \\usepackage{pdfpages} \\usepackage[ pdfpagelabels=true, pdftitle={A test pdf file}, pdfauthor={Chunyu Ge}, ]{hyperref} \\usepackage{bookmark} \\begin{document} \\pagenumbering{arabic} \\setcounter{page}{1} \\includepdf[pages=1-2]{originalFile.pdf} \\pagenumbering{roman} \\setcounter{page}{1} \\includepdf[pages=3-8]{originalFile.pdf} \\pagenumbering{arabic} \\setcounter{page}{1} \\includepdf[pages=9-]{originalFile.pdf} \\bookmark[page=1,level=0]{Title Page} \\bookmark[page=17,level=1]{Contents} \\bookmark[page=31,level=1]{Chapter 1} \\bookmark[page=31,level=2]{Section 1} \\end{document} ","permalink":"https://ge-chunyu.github.io/posts/2023-04-pdf-bookmark/","series":[],"tags":["Latex"],"title":"Export and import pdf bookmarks"},{"authors":[],"categories":[],"content":"Use RIME RIME is an input method engine. It can run different input method schemas, and of course, IPA. There are two schemas which are available in RIME, yunlong and xsampa. To use these schemas, you need to install RIME. It can be installed on Windows, MacOS and Linux. After installation, there are two files you need to modify to complete the configuration. The first is default.custom.yaml. My configurations of this file are as below.\n# default.custom.yaml patch: menu/page_size: 8 schema_list: - schema: luna_pinyin # 朙月拼音 - schema: luna_pinyin_simp # 朙月拼音 简化字模式 - schema: zyenpheng # 中古漢語全拼 - schema: ipa_yunlong # 云龙国际音标输入法 - schema: ipa_xsampa # 云龙国际音标输入法 - schema: japanese # 日语输入法 - schema: terra_pinyin # 地球输入法 switcher/hotkeys: - \u0026quot;F4\u0026quot; \u0026quot;ascii_composer/switch_key/Shift_L\u0026quot;: commit_code key_binder: bindings: # commonly used paging keys - { when: paging, accept: Shift+Tab, send: Page_Up } - { when: has_menu, accept: Tab, send: Page_Down } - { when: paging, accept: period, send: Page_Up } - { when: has_menu, accept: comma, send: Page_Down } - { when: has_menu, accept: comma, send: Page_Down } To install the IPA schemas, type the following code in terminal of MacOS, or use the GUI provided by RIME in Windows. A more detailed tutorial of installing Yunlong on Windows can be found here\n# install the package manager of RIME curl -fsSL https://git.io/rime-install | bash # change directory to plum and install ipa schemas cd plum bash rime-install ipa # add Yunlong and xsampa to the default configurations. bash rime-install custom:add:schema=ipa_xsampa bash rime-install custom:add:schema=ipa_yunlong After that, deploy RIME, and when it says Squirrel/Weasel is ready. You can use F4 (or other hotkey you defined, e.g., `Ctrl+``) to change the input method.\nTo input IPA using Xsampa, you can have a look at a guide to Xsampa: https://chromium.googlesource.com/chromiumos/third_party/espeak-ng/+/HEAD/docs/phonemes/xsampa.md\nAnother file you may want to modify is squirrel.custom.yaml or (weasel.custom.yaml on Windows). Basically, this file can configrue how Squirrel or Weasel look like. My configurations are as below.\n#squirrel.custom.yaml patch: style/color_scheme: \u0026quot;simplest\u0026quot; # Use the scheme defined below preset_color_schemes/simplest: name: \u0026quot;simplest\u0026quot; author: \u0026quot;Chunyu Ge \u0026lt;gechunyu92@hotmail.com\u0026gt;\u0026quot; horizontal: false inline_preedit: true alpha: 0.9 back_color: 0x000000 # background text_color: 0xffffff candidate_text_color: 0xffffff # non-first candidate hilited_candidate_back_color: 0xffffff # background of the first candidate hilited_candidate_text_color: 0x000000 # first candidate comment_text_color: 0xffffff label_format: '%s' hanb_font: \u0026quot;HanaMinB\u0026quot; # font of uncommon words Use Yunlong Alternatively, you can simply use Yunlong, which can be installed separately in Windows. Yunlong can be accessed here\nYunlong is quite straightforward. For example, schwa ə is ed, which means e dao (e 倒). Diacritics can be input with the key f. For example, the nasalized vowel ã is af~.\nA main advantage of Yunlong over Xsampa is that it can input apical vowels (ɿ ʅ ʮ ʯ) and other symbols which are used specifically in Chinese.\nType IPA in LaTeX To input IPA in LaTeX, you can use the tipa package, which can input IPA symbols with ASCII code only. A cheatsheet of the symbols can be found in https://ptmartins.info/tex/tipacheatsheet.pdf\nIf you have installed Yunlong or Xsampa, you can also simply type IPA in a LaTeX document, but tipa is also very useful. Some conference or journal templates can only be generated with pdflatex, rather than xelatex, and only the latter can handle non-standard symbols, such as IPA. Therefore, if you want to type IPA in your LaTeX document and run it with the pdflatex engine, you can only use tipa.\nOnline IPA keyboard Yet another alternative is to use online IPA keyboard, if you do not want all that tinkering. The following are some online IPA keyboards. But if you need to input a lot of IPA, better install one of the input schemas.\nhttps://keyman.com/keyboards/sil_ipa (SIL keyboard) https://ipa.typeit.org/full/ http://westonruter.github.io/ipa-chart/keyboard/ ","permalink":"https://ge-chunyu.github.io/posts/2022-12-ipa/","series":[],"tags":["Latex"],"title":"How to setup an IPA input method"},{"authors":[],"categories":[],"content":"在 LaTeX 里显示生僻字是一个棘手的问题。用xeCJK包可以解决这个问题，而且不用在文件中遇见生僻字就改字体。\nxeCJK包的使用手册中有FallBack的选项（8 页），可以用以下两种办法指定生僻字的字体\n\\setCJKmainfont[FallBack=SimSun-ExtB]{SimSun} \\setCJKmainfont{SimSun} \\setCJKfallbackfamilyfont{\\CJKrmdefault}{SimSun-ExtB} 第一种办法是在指定字体时用FallBack参数指定备用字体，第二种办法是在指定字体之后再用\\setCJKfallbackfamilyfont指定备用字体。二者是等价的。但是要注意的是，在用FallBack时，必须在导入xeCJK宏包时设置AutoFallBack=true。\n\\usepackage[AutoFallBack=true]{xeCJK} ","permalink":"https://ge-chunyu.github.io/posts/2022-11-01-shengpizi/","series":[],"tags":["Linguistics","Latex"],"title":"在 LaTeX 中显示生僻字"},{"authors":[],"categories":[],"content":" 已刊于《语言文字周报》。\n酿菜是很多人都很爱吃的菜，比如酿豆腐、酿苦瓜、煎酿三宝等等。所谓酿菜，根据《现代汉语词典》：“烹调方法，将肉、鱼、虾等剁碎做成的馅儿填或塞入掏空的柿子椒、冬瓜等里面，然后蒸或用油煎。”(第六版，949 页)酿菜在各地都广受喜爱，那么“酿”这个词到底是怎么来的呢？\n客家酿豆腐是很有名的菜，酿豆腐的“酿”在客家话里念成 /ŋioŋ52 梅县 ioŋ31 长汀 ȵiɔŋ35 连城/（梅县据谢永昌《梅县客家方言志》，长汀和连城据罗美珍、邓晓华《客家方言》）。 根据客家话，“酿”既可能是娘母字，也可能是日母字。在客家话里，“酿”跟“娘”除了声调不同之外，声母、韵母都一样；但是，“酿”又跟日母的“让”同音。在北京话里，酿菜的“酿”一般读成“让”。这么看来，“酿”应该是一个日母字，写作“酿”只是日母和娘母同音造成的混淆。另外，从调值来看，不论是客家话还是北京话，“酿”都是一个去声字。\n中国人做酿菜由来已久，《易牙遗意》《调鼎集》等烹饪古籍中都有酿菜的记录。这些记录里酿菜有的写成“酿”，有的写成“瓤”。最早用“酿”字的似乎是北魏贾思勰的《齐民要术·炙法第八十》的“酿炙白鱼法”：“白鱼长二尺，净治，勿破腹。洗之竟，破背，以盐之。取肥子鸭一头，洗治，去骨，细剉；酢一升，瓜菹五合，鱼酱汁三合，姜、橘各一合，葱二合，豉汁一合，和，炙之令熟。合取，從背入著腹中，丳之如常炙鱼法，微火炙半熟，复以少苦酒、杂鱼酱、豉汁，更刷鱼上，便成。”说的是把白鱼从背部破开，腌制之后，将肥子鸭肉与酢（即醋）、瓜菹（腌过的瓜）、鱼酱汁、姜、橘等和成馅，从背部填入白鱼中，再把鱼用签子串起来，用小火炙烤，最后刷上苦酒、杂鱼酱、豉汁即可。其他烹饪古籍中也不乏写成酿的，比如宋浦江吴氏的《吴氏中馈录》，有酿瓜（15 页），就是将青瓜去瓤，而将生姜、陈皮、薄荷、紫苏、茴香、砂仁、砂糖等酿入青瓜中。元代的《居家必用事类全集》中有酿烧鱼、酿烧兔等；元代大画家倪瓒的《云林堂饮食制度集》中也有酿黄雀；明代韩奕的《易牙遗意》里也有酿肚子等。而这种做法在清人的《调鼎集》里则一般写作“瓤”，例如夹瓤肚（187 页）、瓤鸡（274 页）、瓤野鸡（305 页）、瓤野鸭（335 页）、瓤虾圆（443 页）、烧瓤虾绒（444 页）、瓤毛笋、瓤羊尾笋、瓤天目笋（519 页）、瓤芽笋（520 页）、瓤萝卜（532 页）、瓤板桥萝卜（543 页）、瓤芋子、瓤芋头（607 页）等等。举凡蔬菜（萝卜、笋等）、鸡鸭，乃至虾圆、肚子，几乎无物不可以瓤。\n在汉语里，从襄声的字往往有里面、内部的意思。大家最熟悉的例子就是瓜瓤的瓤。其他的比如穰，《说文解字·禾部》：“穰，黍𥟜已治者，从禾襄声”。段玉裁的注说：“已治、谓已治去其𥬡皮也。謂之穰者、莖在皮中如瓜瓤在瓜皮中也。”穰就是指谷物除去外壳的部分，跟瓜瓤指去除瓜的外皮的部分一样。又比如欀，也有里的意思。《洛阳伽蓝记·城南》菩提寺条下记载了一个故事。说的是北魏明帝的时候，有人挖开古冢发现了一个活人。似乎因为这个人死过一回，所以对阴间的事情颇有了解。他告诉当时的人说：“作柏木棺，勿以桑木为欀。”周祖谟注说：“欀，里也。”这也就是说让人用柏木作棺材，而不要用桑木作里子的意思。\n明白了从襄声的字有里面、内部的意思，再来考虑“酿”字的来源就豁然开朗了。“酿”同样有里面、内部的意思，只不过是指将馅料填入内部。很明显，“酿”是从襄声的名词派生出来的动词，而相应地，从襄声的穰、瓤等都是平声，而“酿”则是去声。这是汉语中常见的四声别义的现象。在汉语里，有些词读平声是名词，而读作去声则是动词。例如衣读平声指衣服，是名词，而读去声则是穿衣服，是动词；王读平声是君王的意思，是名词，读成去声则是作君王，是动词（所举的例子见周祖谟《四声别义释例》，《问学集》81-119页）。按照平声为名词、去声为动词的字一般都用平声的字来记录的习惯，“酿”字似乎写成“瓤”更合适，只不过读的时候还是应当读成去声。当然，“酿”字行用已久，也没有必要大费周章，换用另一个字。而且，按照“酿”字的本音来读似乎也没有什么问题。只不过读成“瓤”去声是北京话的本音，而读成“酿”就是源于其他方言的旁读音了。\n汉语由于用汉字来记录，大家在说一个字的本义的时候往往根据字形，这样对很多字的理解就会与最开始的造字本义发生偏离。“肏”就是一个典型的例子。“肏”本来读成“入”（或者日），是一个从肉入声的形声字；现在大家则把它当成了一个会意字，读音也变成了操去声（见李荣《论“入”字的音》，《方言》1982年第4期241-244页）。这些例子都启示我们，考察汉语词义，不能为汉字字形所惑，还要从语音上着手。这也就是清儒“因声求义”的办法。只不过，我们现在不仅要着眼于语音，还要发现语音中反映出的形态手段等其他语言规则，而不能倒退到“一声之转”的老路上去。\n","permalink":"https://ge-chunyu.github.io/posts/2022-08-niangcai/","series":[],"tags":["Linguistics"],"title":"说“酿菜”的“酿”"},{"authors":[],"categories":[],"content":"天空中除了位置比较稳定的恒星之外，还有位置时常发生变动的行星。与恒星不同，行星自身并不发光，而是和月亮一样，靠反射太阳光来发光。因此，行星与太阳、地球之间的相对位置不同会导致地球上所能看到行星反射太阳光面积大小不同的情况。同样的原因造成了月圆月缺，行星也有类似的现象，比如金星就有相位变化。但是由于金星离地球较远，又有致密的大气层，所以直到伽利略才通过望远镜发现金星也有相位变化。\n太阳系有九颗行星，离太阳由近到远分别是水星、金星、地球、火星、木星、土星、天王星、海王星。天王星和海王星直到十九世纪才被发现，天王星是 William Herschel 通过望远镜发现的，而海王星最早则是英法两国的学者通过计算发现的（这还引起了英法两国争夺海王星命名的争论）。除了我们赖以生存的地球之外，不借助望远镜，人类只能看到水星、金星、火星、木星、土星五颗行星。古人认为这五颗行星代表了五行。襄公二十八年《正义》：“五星者，五行之精也。历书称木精曰岁星，火精曰荧惑，土精曰镇星，金精曰太白，水精曰辰星。此五者皆右行于天。”木星最初叫岁星、火星叫荧惑、土星叫镇星、金星叫太白、水星叫辰星。火星之所以叫荧惑，是因为火星的轨道运动导致它在地球上的视运动极其复杂，足以令人迷惑。土星叫镇星，镇和填是一样的，即指土星为土精。金星叫太白是以金星的颜色来命名的。金星又叫启明和长庚。《诗经·谷风之什·大东》：“东有启明，西有长庚。”金星是内行星，与太阳的距离不会太远，因此一般在日出之前或日落之后最便于观测。金星在日出之前出现就叫启明，在日落之后出现就叫长庚，取赓续日光之义。水星叫辰星。《星象》中认为“辰”可以指任何鲜明的天体，因而又可以指水星。问题在于，水星作为离太阳最近的行星，常常为日光所掩，不便观测，实在称不上鲜明。木星叫岁星的原因就是本篇的主题。\n襄公九年晋悼公问季武子鲁襄公的年纪，季武子说：“会于沙随之岁，寡君以生。”晋悼公说：“十二年矣。是谓一终，一星终也。”杜预注：“岁星十二年而一周天。”《正义》：“知是岁星者，以古今历书推步五星，金、水日行一度；土三百七十七日，行星十二度；火七百八十日，行星四百一十五度，四者皆不得十二年而一终。唯木三百九十八日，行星三十三度，十二年而强一周。”木星的公转周期是 11.86 年，因此说十二年而走一周多。因为知道木星的周期大约为十二年，古人将黄道分为十二部分。这样就可以根据木星的位置来纪年。在春秋时期，各国都以国君来纪年，这对于国际交流极其不便。以木星的位置来纪年就迎合了这种需求。这就是木星被称作岁星的原因。\n黄道是太阳与行星视运动轨迹扫过的一片天区。黄道分为的十二个部分就称之为十二次。古人不仅将黄道划分为十二次，还把地理区域与十二次对应起来。地理区域与黄道天区的对应就称之为分野。十二次主要记载在《周礼·春官·保章氏》郑玄注中；《尔雅·释天》中也记载了其中几个星次；《汉书·律历志》也记载了十二次，并把十二次与二十八宿对应起来。二十八宿与十二次一样，都是黄道天区，二十八宿各有距星，古人以天体离距星的距离和离北天极的距离来作为天体的坐标。天体离北天极的距离称为去极度，为赤纬的余角；而天体的赤经与现代通用的以春分点来作为标准不同，是以二十八宿的距星为标准的，这称之为入宿度。二十八宿并不是等分的，而为了配合岁星大约十二年一周的运行周期，古人将黄道大致平均分为十二次。因此，十二次可以与二十八宿对应，又可以与地理区域对应；另外，由于岁星可以用来纪年，岁星还可以与十二地支对应；古人又假想了与岁星对应的在地上运行的太岁，它与岁星对应，经过的十二个区域称为岁阴。下面这张表就说明了十二次与二十八宿、十二地支、列国分野、岁阴的对应关系。\n十二次 析木 大火 寿星 鹑尾 鹑火 鹑首 实沈 大梁 降娄 娵訾 玄枵 星纪 二十八宿 尾箕斗 氐房心尾 轸角亢氐 张翼轸 柳星张 井龟柳 毕觜参井 胃昴毕 奎娄胃 危室壁奎 女虚危 斗牛女 分野 燕 宋 郑 楚 周 秦 晋 赵 鲁 卫 齐 吴越 十二地支 寅 卯 辰 巳 午 未 申 酉 戌 亥 子 丑 岁阴 赤奮若 困敦 大渊献 阉茂 作鄂 涒滩 协洽 敦牂 大荒骆 执徐 单阏 摄提格 但事实上木星的周期为 11.86 年，并不是准确的十二年。《史记·天官书》：“岁行三十度十六分度之七，率日行十二分度之一，十二岁而周天。”《淮南子·天文训》中的说法一模一样。与西方人将一周划分为 360 度不同，中国古人将一周分为 365.25 度。古人已经发现一个回归年的长度大约为 365.25 天1，将一周分为 365.25 度，则太阳一天走一度，一年之后重新回到原处。根据《天官书》和《天文训》的说法，木星十二年正好走一周，也就是 365.25 度。\n$$12 \\times 30 \\frac{7}{16} = 12 \\times 365.25 \\times \\frac{1}{12} = 365.25$$\n这说明《天官书》和《天文训》是以十二年的周期算出木星的平均运行速度，并不是实测。由于木星的周期比十二年略差一点，所以每隔大约七个周期，木星就要比预计的多走一次。也就是 $1 / (12 - 11.86) = 7.14$。春秋时候的人把这种现象叫做“淫行失次”，就是木星走快了，多走了一次。为了解决这种矛盾，刘歆提出了“超辰法”，也就是每过七个周期，把十二次往后挪一个，这就跟木星实际的位置一致了。\n十二次与分野的起源应该相当早。在十二次和分野的对应关系中，可以发现晋国对应实沈，这是上一篇《星象》中讨论过的，实沈是很早的传说，到晋悼公的时候连晋国都没人知道了。另外，大火对应宋，宋是商人的后裔，商人主火也是上一篇就提到了的。襄公九年《左传》也说：“心为大火，陶唐氏之火正阏伯，居商丘，祀大火，而火纪时焉，相土因之，故商主大火，商人阅其祸败之衅，必始于火。”商人是用大火星来纪时的，所以将大火与商人的后裔宋人对应。在上古时期，不同地区的人往往通过观测不同的天体来确定时间，预测气候。古埃及人就用天狼星（Sirius）来预测尼罗河的泛滥。十二次可能就是在此基础上发展而来的2。\n《保章氏》说：“以星土辨九州之地，所封封域，皆有分星，以观妖祥。”可见岁星所在与对应地区的吉凶有关。《日食》篇中已经提到日食所在十二次的位置会引起相应地区的灾异。《天官书》：“（岁星）所在国不可伐，可以罚人。”与岁星所在对应的地区有福。昭公三十二年《左传》：“夏，吴伐越，始用师于越也。史墨曰：‘不及四十年，越其有吴乎？越得岁，而吴伐之，必受其凶。’”杜预注：“存亡之数，不过三纪。岁星三周三十六岁……此年岁在星纪，星纪，吴越之分也。岁星所在，其国有福。吴先用兵，故反受其殃。”昭公三十二年吴国侵略越国，这一年岁星在星纪。星纪是吴越的分野。那为什么同为岁星所在之国，吴国用兵就凶呢？因为尽管岁星所在之国，可以罚人；但是吴国所伐的是同在星纪的越国，所以吴国反而会倒霉。\n岁星所在的吉凶又与岁星的运行有关。襄公二十八年，根据十二年一周的周期，岁星应当在星纪，但实际却在玄枵，多预计的多走了一次。这当然是由于木星周期短于十二年所致。但是当时的人认为这是灾异的征兆。鲁国大夫梓慎说：“今兹，宋、郑其饥乎？岁在星纪，而淫于玄枵，以有时菑。阴不堪阳，蛇乘龙。龙，宋、郑之星也。宋、郑必饥。玄枵，虚中也；枵，秏名也。土虚而民秏，不饥何为？”蛇是虚危之星，玄枵正好对应着虚危，龙对应东方七宿，东方七宿对应的十二次是大火和寿星，分野为宋、郑。因而宋、郑会出现灾异。玄枵是虚中、消耗的意思，所以宋、郑会出现饥荒。但是郑国大夫裨灶说：“今兹周王及楚子皆将死，岁弃其次，而旅于明年之次，以害鸟帑，周楚恶之。”裨灶认为岁星失次，是鹑火、鹑尾受灾，与之对应周和楚要倒霉。杜预注说：“俱论岁星失次，梓慎则曰宋郑饥，裨灶则曰周楚王死。传故备举，以示卜占惟人所在。”这就是说面对同样的天文现象，梓慎和裨灶两个人说法不一，占卜是因人而异的。由此也就可见用十二次与分野来占卜吉凶是多么荒谬了。\n古人计算时多用分数，365.25 的分数部分就是四分之一，所以以 365.25 天为一年长度的历法就称之为“四分历”。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n三代以上，不同部落的习俗制度可能相差很大。例如昭公十七年：“昔者黄帝氏以云纪，故为云师而云名；炎帝氏以火纪，故为火师而火名；共工氏以水纪，故为水师而水名；大皞氏以龙纪，故为龙师而龙名。我高祖少皞挚之立也，凤鸟适至，故纪于鸟，为鸟师而鸟名。”\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2020-08-cq-fenye/","series":[],"tags":["Astronomy"],"title":"春秋时期的天文：十二次与分野"},{"authors":[],"categories":[],"content":"太阳下山，夜空中就会布满繁星。在浩瀚宇宙中传递了亿万年的星光，由于位置相近或偶然的投影，在夜空中形成了各种形状。人类看到这些形状就会联想到生活中的事物，或是想出新奇的故事。现代 88 个星座的命名有的历史悠久，有的则比较年轻。南天星座大多是大航海时代命名的，因此大多取象于航海仪器，比如六分仪座（Sextans）、望远镜座（Telescopim）。北半球的星座的命名则由来已久，往往是以神话命名的，比如武仙座（Hercules，宙斯的儿子大力士海格立斯）、仙后座（Cassiopeia，古代埃塞俄比亚的王后）。在中国，也有星座是用神话来命名的。《左传·昭公元年》子产给叔向讲了这么一个故事：\n昔高辛氏有二子，伯曰阏伯，季曰实沈，居于旷林，不相能也。日寻干戈，以相征讨。后帝不臧，迁阏伯于商丘，主辰，商人是因，故辰为商星；迁实沈于大夏，主参，唐人是因，以服事夏商，其季世曰唐叔虞。当武王邑姜，方震大叔，梦帝谓己：“余命而子为虞，将与之唐，属诸参，而蕃育其子孙。”及生，有文在其手，曰虞，遂以命之。及成王灭唐，而封大叔焉。故参为晋星，由是观之，则实沈，参神也……\n这一年，晋平公得了病，郑伯派公孙侨，也就是子产去晋国看望晋平公。晋国的卜人说晋平公的疾病是“实沈、台骀为祟”，但是晋国的太史都不知道“实沈”、“台骀”是什么神。叔向就向子产请教。子产是“博物君子”，就给叔向讲了这么一段故事。高辛氏生了两个二子，大儿子叫阏伯，小儿子叫实沈，两个人住在大森林里，但是关系不好，天天打仗。高辛氏看不下去了，就把大儿子阏伯迁到商丘，主辰；又把小儿子实沈迁到大夏，主参星。商人居于阏伯故地，所以商人祀辰星，而唐人住在实沈故地，祀参。周武王的王后邑姜（齐大公姜子牙的女儿）怀孕的时候梦到上帝对她说：“你怀的这个孩子，我给他起名叫虞，要把唐地给他，把参给他掌管。”大叔生下来之后，手上的掌纹像虞字，于是就叫他虞。等到周成王灭了唐，就把唐作为大叔虞的封邑。大叔分封在唐，就是晋侯。因此，晋国祀参星，实沈就是参神。辰就是天蝎座（Scorpius）；参星又叫伐，是猎户座（Orion）。天蝎座在夏季出现在北半球南部的天空，猎户座则是冬季出现。这两个星座从来不同时出现在夜空中，所以古人认为这两个星座是关系不好的两兄弟。在希腊神话中，天蝎座是毒死猎户座的蝎子，所以它们也互不相见。春秋时候，一般都知道参是晋星。昭公十五年周景王说：“唐叔受之，以处参虚。”但是为什么参是晋星就很少有人知道了，就是世处参虚的晋国人也都不知道。可见星座的命名来源在春秋时期就已经鲜为人知，流传到今天的就更少了。\n辰是天蝎座，一般指大火，就是心宿二（Antares，$\\alpha$ Scorpii，天蝎座的最亮星）。但是辰并不仅仅指大火。晋侯就觉得很迷惑，昭公六年晋侯问伯瑕：“多语寡人辰，而莫同，何谓辰？”伯瑕说：“日月之交是谓辰。”辰是指日月的交汇。事实上，辰的含义远不止这么几种。辰大概有这么几种含义：\n大火。昭公元年杜预注：“辰，大火也”；昭公十七年《公羊传》：“辰，大火也”； 日月之交。昭公六年：“日月之交是谓辰”； 房心尾。昭公十七年杜预注：“大辰，房心尾也”； 日月星。昭公十七年：“三辰有灾”，杜预注：“三辰，日月星也”；又“辰不集于房”； 伐。昭公十七年《公羊传》：“伐为大辰”； 北辰。昭公十七年《公羊传》：“北辰亦为大辰”。 辰除了日月星之外，还可以指北斗七星（北辰）、猎户座（伐）、天蝎座（房心尾），甚至日月的交会。北斗七星、天蝎座、猎户座都是天空中最明亮、最引人注目的天体，可见辰可以指天空中任何显著的天体。推而广之，则可以笼统地指日月星；引而申之，又可以指日月交会。《说文》：“辰，震也。”是声训的例子。汉人训诂，多用声训。《淮南子·天文训》解释十二干完全用声训的办法1。这种解释明显是后起的。\n这些引人注目的天体随着地球的公转不断变换位置，但是又年复一年地回到原先的位置。这些天体的位置事实上标志了地球在绕太阳公转轨道上的位置。地球上的一年四季是由于地轴与黄道面并非垂直，而存在一定的倾角（23.44度）引起的。地球运行到太阳公转轨道的不同位置与地球上不同的季节相对应。因此，季节又与天体的位置相对应。古代的历法不够发达，要知道季节变换就靠观察天体的位置。《尚书·尧典》：“日中星鸟，以殷仲春；日短星火，以正仲夏；宵中星虚，以殷仲秋；日永星火，以正仲冬。”春夏秋冬四个季节，各有运行到天空正中的星2。在这些星中，古人尤其注意大火的位置。\n大火星就是心宿二（Antares），是天蝎座的最亮星（$\\alpha$ Scorpii）。心宿二的光谱类型 M1，是一颗表面温度较低的超巨星，呈红色。正是由于心宿二为红色，所以古人称之为大火。《诗经·豳风·七月》：“七月流火”，就是说七月的时候大火往西行，即将隐入地平线以下了。昭公三年《左传》：“火中，寒暑乃退。”杜预注：“火，心星也。心以季夏昏中而暑退，季冬旦中而寒退。”大火的位置标志了一年中气候的寒暑。当大火在太阳落山后出现在南方天空的中部时，暑气就会消退，秋天就快到了；当大火在太阳升起之前出现在南方天空的中部时，寒气就会消退，春天就快到了。\n天体在天空中出现的时间和位置也为人们进行生产、社会活动提供了重要的参考。桓公五年《左传》：“凡祀，启蛰而郊，龙见而雩，始杀而尝，闭蛰而烝。”早春，东方苍龙七宿在黄昏时候出现在东方天空时，就要举行雩，也就是祭天的典礼。东方苍龙七宿包括角、亢、氐、房、心、尾、箕。角大概相当于牧夫座（Bootes）、亢则相当于室女座（Virgo）、氐相当于天秤座（Libra）、房心尾相当于天蝎座、箕大概相当于人马座（Sagittarius）。在东方七宿中，最明亮的是大角星（Arcturus），是天空中第四亮星（仅次于天狼星、老人星、南门二）。大角星相当于苍龙七宿的龙角，昏见东方大概是农历二月初的时候，所以民间把这个时候称作“龙抬头”。当大角星在日出之前出现在东方的时候，则是夏历九月，农活基本都结束了，就可以开始准备修备守御了。所以庄公二十九年《左传》说：“凡土功，龙见而毕务，戒事也；火见而致用，水昏正而栽，日至而毕。”等到大火晨见东方，就要准备修筑城墙的木材板干了。到水星昏正的时候，就开始修筑城墙了。这里的水星并不是行星水星，而是指北方七宿，因为北方七宿属水，所以称为水星，其中又特指定星。《诗经·卫风·定之方中》：“定之方中，作于楚宫。揆之以日，作于楚室。”这是说定星昏正的时候，开始营建宗庙（楚室），通过测定日影，来考知东西南北，以定宫室的朝向。定星又叫营室，由定星昏中开始营建宫室而得名。营室二星与东壁二星合起来近似一个正方形，也就是现代所说的飞马座大正方形（The Great Square of Pegasus）。《小序》中说：“定之方中，美卫文公也。卫为狄所灭，东徙渡河，野处漕邑，齐桓公攘夷狄而封之，文公徙居楚丘，始建城市而营宫室，得其时制，百姓说之，国家殷富焉。”卫懿公好鹤，卫国人对卫懿公非常不满，所以狄人趁虚而入，攻打卫国。卫国公主许穆夫人对父母之邦感情深厚，对只会空谈的公卿大夫深为痛切，作了《载驰》这首诗。齐桓公作为霸主，将卫国遗民迁徙到楚丘。卫文公根据星象及时兴作，锐意进取，所以卫国国势重振（闵公二年）。\n《淮南子·天文训》： ……（斗）指寅，則萬物螾螾也……指卯，卯則茂茂然……指辰，辰則振之也……指巳，巳則生已定也……指午，午者，忤也……指未，未，昧也……指申，申者，呻之也……指酉，酉者……指戌，戌者，滅也……指亥，亥者，閡也……指子，子者，茲也……指丑，丑者，紐也……\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n由于地球的地轴并不是固定的，而是不断运动的，这就造成了岁差（precession）。岁差的结果就是北极星不是终古不变的，而星星的位置也不断发生着细微的改变。竺可桢运用这种原理来考证《尧典》“四仲中星”的年代（《论以岁差定尚书尧典四仲中星之年代》）。但是《尧典》中并没有说具体是在一年中的哪天观测到中星的现象，也没有说这些中星是昏中（太阳落山时中天）还是旦中（太阳升起之前中天），所以对四仲中星的年代仍有争议。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2020-08-cq-astrology/","series":[],"tags":["Astronomy"],"title":"春秋时期的天文：星象"},{"authors":[],"categories":[],"content":"日升月落，星移斗转，是最鲜明的天体运动。先民在长期观察中，发现气候寒温、草木荣枯与天象之间存在紧密的关系。上古时期，历法还不够成熟，而且也不够普及；又没有准确的计时系统。天象在先民的日常生活中起着极其重要的作用。这就是为什么“三代以上，人人皆知天文”的缘故。到了后世，历法发达，计时系统逐渐准确，而大部分人又不必从事与气候紧密相关的农业劳动，因此，“有问之文人学士而懵然不知者”。\n春秋时期对天象的观察和记录已经相当准确而频繁。太阳是天空中最明亮的天体，它为地上的一切提供光和热。当日食发生时，人民难免会感到恐惧，认为这是上天给人类的警告，并且将要降下责罚。在春秋之前不久，周王朝尚未东迁的时候，周人就见到了一场日食。在这场日食之前一个月不到，还发生了月食。不仅如此，在国都附近还发生了地震，连高山都崩塌了。日升月恒、南山的稳固、松柏的长茂，在古人心中都是最理所当然的自然现象。一时之间，月食、日食、地震。这么多灾异接连而至，不能不令周人感到恐惧。这场日食记录在《诗经·小雅·十月之交》中，《诗序》说是“刺幽王”。到了春秋时期，古人非常重视观察记录日食。在 242 年间，《春秋》总共记录了 37 次日食。\n日食是由于太阳、地球、月亮三者处在特定位置造成的。当月亮出现在太阳和地球之间时，太阳光被月球挡住，于是就发生了日食。但是，月亮比太阳小，即便发生日食，太阳往往也不能完全被月亮遮住。当太阳完全被月亮遮住时，就会发生日全食；而当太阳的一部分被月亮遮住时，就会发生日环食或是日偏食。春秋时候将日全食叫做“既”。鲁隐公三年就发生了一场日全食。《春秋》中记载：“秋七月壬辰朔，日有食之，既”。《正义》中说：“食既者，谓日光尽也”。古人早就知道日食是由于太阳被月亮挡住造成的。这对于春秋时代的人来说不可谓不是一个大发现。知道了日食发生的原因，就可以知道日食必定发生在朔日，也就是每个月（朔望月）的初一。同样地，月食也必定发生在每个月的十五，即望日。\n《春秋》中记载日食，一般会记载日食发生的日期，并标上“朔”，即当月初一。有时不书日期或朔日，是日官记载失误。例如桓公十七年：“冬十月朔，日有食之。”《左传》说：“不书日，官失之也。”但是春秋时期历法尚不成熟，对于朔望月的推算偶尔会出现差错，因此有日食而发生在朔前一日的情况。文公八年：“秋七月甲子，日有食之，既。”在文公八年七月甲子这一天发生了日全食，杜预注说：“月三十日而食。”七月甲子是七月三十日，不是朔日（初一），因此不书朔。另外一方面，我国历法以朔望月（阴历）与回归年（公历）相配，而一个朔望月的长度过短（29.530588），一年十二月与回归年的长度（365.25）相比还差好几天（365.25 - (29.530588 × 12) = 10.882944）。因此，每隔几年就要将多出来的日子作为闰月。春秋时期，置闰还不是很准确，常常会有失闰的情况出现，也就是本应置闰而没有置。这样，月份就会出现误差。襄公二十三年：“冬十有二月，乙亥，朔，日有食之。”《左传》说：“十一月乙亥，朔，日有食之，辰在申，司历过也。再失闰矣。”\n日食是有一定周期的。巴比伦天文学家发现了沙罗周期（Saros），认为只要知道发生了一次日食，则经过 223 个朔望月（或 18 年 11 天 8 小时）就会发生一次同样的日食。但是，《春秋》中记载了好几次频年日食、甚至频月日食的现象，也就是连续两年或连续两个月都发生日食。例如，襄公十四年二月日食，而十五年八月又日食；襄公二十四年七月日食，八月又日食。《正义》说：“今七月日食既，而八月又食，于推步之术，必无此理。盖古书磨灭，置有错误。”古人将天体的运行比作行走，日月运行就称作“日躔月离”。《说文》：“躔，践也。”而“践，履也。”躔、践、履都有行走的意思。所以就把推算天体运行的学说称作“推步之学”。\n日食在古人看来是一件大事。日食发生时要举行特别的仪式。在传说中的夏朝就有日食时举行的特殊仪式。昭公十七年鲁国太史引用《夏书》说：“辰不集于房，瞽奏鼓，啬夫驰，庶人走。”所谓“辰不集于房”就是天体不在它应该在的位置。辰在早期可以用来指任何重要的天体，在这里就是指太阳。到了周朝，“封建亲戚，以藩屏周”，天子、诸侯各有不同的仪式。同样是昭公十七年日食，叔孙昭子说：“日有食之，天子不举，伐鼓于社，诸侯用币于社，伐鼓于朝。”天子不举乐，在社击鼓，而诸侯则是在社献上牺牲，在朝击鼓。所以，庄公二十五年：“六月，辛未，朔，日有食之，鼓，用牲于社。”但是并不是每次日食发生都会举行这样的仪式，只有在特定的月份发生日食才会举行。《左传》说：“唯正月之朔，慝未作，日有食之，于是乎用币于社，伐鼓于朝。”只有当正月发生日食，才会举行这一套仪式；但是这里的正月并不是现在的农历正月。杜预注说：“正月，夏之四月，周之六月，谓正阳之月。”指的是周朝的六月。因此，昭公十七年六月初一日食，理应用牲于社，伐鼓于朝，但是季平子却百般阻挠，所以叔孙昭子说：“夫子将有异志，不君君矣。”季平子对昭公不满，所以到了昭公二十五年，昭公就被季氏赶出了鲁国，“孙于齐”了。\n日食是非常罕见的天文现象，古人将天文现象与人事吉凶相互联系起来。但是何者为吉，何者为凶往往各执一词。昭公二十一年七月初一（壬午）日食，鲁昭公问梓慎这场日食到底是吉是凶。梓慎说，：“二至二分，日有食之，不为灾。日月之行也，分，同道也；至，相过也。其他月则为灾。阳不克也，故常为水。”梓慎认为日食是阳气不敌阴气，所以日食发生的年份大多发生水灾。二十四年五月又发生了日食，梓慎还是说会有水灾，叔孙昭子不同意，说：“旱也。日过分而阳犹不克，克必甚，能无旱乎？”叔孙昭子认为太阳已经经过了春分点而阳气仍然不敌阴气，因此阳气积聚，将会导致旱灾。然而日食发生，并不是所有地区都会出现同样的灾异；古人认为灾异的发生与太阳所在位置有关。昭公七年四月初一（甲辰）日食，晋昭公问士文伯谁将当日食，士文伯回答说鲁国和魏国将要遭受日食的灾异，原因在于“去卫地，如鲁地”。如何知道这次日食是“去卫如鲁”呢？古人将黄道分为十二个天区，即十二次，并将这十二个天区与十二诸侯相配，说明天空中的区域与地理上的对应关系，这就是分野。鲁国对应于降娄，卫国对应于娵訾，娵訾又名豕韦。日食的时候太阳在豕韦之末，到降娄之始才结束。因此鲁卫会发生灾祸。那么十二次到底是如何来的呢？《十二次与分野》就会讨论这些问题。\n","permalink":"https://ge-chunyu.github.io/posts/2020-08-cq-eclipse/","series":[],"tags":["Astronomy"],"title":"春秋时期的天文：日食"},{"authors":[],"categories":[],"content":"ggplot2 is great for visualization, but sometimes we need to include ggplot2 functions within another function. ggplot() uses aes() to define aesthetic mappings of different variables. The question is: how to define aesthetic mappings when writing functions using ggplot()? In this post I will present several approaches.\nFirst of all, let\u0026rsquo;s load the required packages and some test data.\nlibrary(ggplot2) library(dplyr) data(\u0026quot;mtcars\u0026quot;) Using aes_string() There are two standard ways to define aesthetic mappings in ggplot2, aes_string() and aes_(). Writing a function using aes_string() is the same as using aes(), but calling the function requires passing the variable names as strings to the function.\nplot_point_aes_string \u0026lt;- function(data, x, y, c) { ggplot(data, aes_string(x, y, color = c)) + geom_point() + theme_light() } plot_point_aes_string(mtcars, \u0026quot;mpg\u0026quot;, \u0026quot;wt\u0026quot;, \u0026quot;cyl\u0026quot;) Use aes_() Alternatively, we can use aes_(), which is slightly different from aes_string(). Wrapping aes_() into a function is the same as aes() and aes_string().\nplot_point_aes \u0026lt;- function(data, x, y, c) { ggplot(data, aes_(x, y, color = c)) + geom_point() + theme_light() } The difference is the way to pass variable names. We can either pass the variable names as one-sided equations (~variable names) or as quotes (quote(variable name)).\nplot_point_aes(mtcars, ~mpg, ~wt, ~cyl) plot_point_aes(mtcars, quote(mpg), quote(wt), quote(cyl)) Another alternative I happened to work out another method which circumvent both aes_string() and aes_(). Simply define the aesthetic mappings in the function, and later rename the variable names in the data.\nplot_point \u0026lt;- function(data, x, y, c) { ggplot(data, aes(x, y, color = c)) + geom_point() + theme_light() } Applying the tidy approach and using mutate to rename the variable names, which does not cause any side effect to the original data. But one thing to note is that the labels of the axes are what defined in the function.\nmtcars %\u0026gt;% mutate(x = mpg) %\u0026gt;% mutate(y = wt) %\u0026gt;% mutate(c = cyl) %\u0026gt;% plot_point(mtcars) References Creare ggplot2 function and specify arguments as variables in data as per ggolot Use of ggplot within another function ","permalink":"https://ge-chunyu.github.io/posts/2020-03-ggplot-function/","series":[],"tags":["R","Ggplot2"],"title":"How to define aesthetic mappings of ggplot2 within another function"},{"authors":[],"categories":[],"content":"Praat is widely used in phonetic research. Working with Praat involves inevitably the Praat scripting. There are plenty of resources of Praat scripts as well as great tutorials to Praat scripting (see below). Why bother writing Praat scripts oneself?\nPraat scripts written by others can be helpful, but even an script is available which offer the functionality one needs, it is seldom exactly what one wants. It is normal to do some tailoring to the scripts. Users of Praat may be great phoneticians, but rarely are they professional programmers. When I write my own Praat scripts, I try to explicitly adopt some principles and conventions to facilitate the reusability of code. This post is about these principles and conventions.\nDrawbacks of existing Praat scripts In working with various Praat scripts, I find two drawbacks of some scripts:\nFunctions of some scripts are too specific Some scripts are designed to perform two or more tasks simultaneously These two features have some negative effects. Using scripts with specific functions can lead to tailoring when customizing them to one\u0026rsquo;s own needs. Sometimes, the tinkering even takes more time than if one decides to write his own scripts right away. To perform several tasks at the same time may save some time, but doing research is never an once for all affair. It is usual for one to go back to revise some of the steps he has taken before. Now the scripts with too many functions get on his way. Undesirable functions distract him, and if he wants to get rid of it, once again he falls into the trap of tailoring.\nThe Unix pholosophy and modular programming Professional programmers offer their wisdom. The Unix Philosophy and the modular programming[^1] are priceless in this scenario. The Unix philosophy says that Small is beatiful and requires programs to do one thing well. This inspired me to reflect on the workflow of phonetic research using Praat. Phonetic research starts with annotation and segmentation in Praat, and steps to acoustic analysis. Annotation and segmentation are two separate tasks. It is better to do these tasks using separate scripts.\nAnother useful idea is modular programming. Modular programming is the practice of splitting a large programme into separate modes. It improves the reusability of codes. Modular programming requires you to pay attention to orthogonality. I will illustrate this idea in the next section.\nUse procedure We can abstract common tasks into functions. Praat provide a mechanism called procedure, which can accept parameters and do certain commands. It differs from a function command in other programming languages in that procedure can not return values or objects.\nMaking illustrations with Praat is tedious manually. Using procedure, it is much easier to make illustrations, and minor revisions are needed to customize the pictures. Suppose I want to draw the waveform of a sound file together with the annotation file. It is OK to select both obeject and draw them together, as follows.\nselectObject: \u0026quot;Sound test\u0026quot;\rplusObject: \u0026quot;TextGrid test\u0026quot;\rDraw: 0, 0, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;\rHowever, this approach is not modular. Suppose later I want to draw the spectrogram of the sound file together with its annotation, there is no available function as to \u0026ldquo;draw TextGrid together with a spectrogram\u0026rdquo;. This leads me to abstract the drawing of TextGrid as a procedure, which can be used together with other procedures.\nprocedure draw_TextGrid: .baseName$, .start, .end\rselectObject: \u0026quot;TextGrid \u0026quot; + .baseName$\rSelect inner viewport: 1, 4, 1, 3\rDraw: .start, .end, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;, \u0026quot;no\u0026quot;\rDraw inner box\rAxes: 0, .end - .start, 0, 5000\rMarks bottom: 5, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;, \u0026quot;no\u0026quot;\rText bottom: \u0026quot;yes\u0026quot;, \u0026quot;Time (s)\u0026quot;\rendproc\rAt first glance, this procedure contains more lines than the previous block. The advantage of this procedure is that you can use it independently in any occassion you want, together with other procedures you define. To illustrate, I wrote another procedure which draws the waveform of a sound.\nprocedure draw_waveform: .baseName$, .start, .end\rselectObject: \u0026quot;Sound \u0026quot; + baseName$\rSelect inner viewport: 1, 4, 1, 2.15\rDraw: .start, .end, 0, 0, \u0026quot;no\u0026quot;, \u0026quot;Curve\u0026quot;\rendproc\rAnd another procedure which draws the spectrogram:\nprocedure draw_spectrogram: .baseName$, .start, .end\rselectObject: \u0026quot;Sound \u0026quot; + .baseName$\rTo Spectrogram: 0.005, 5000, 0.002, 20, \u0026quot;Gaussian\u0026quot;\rselectObject: \u0026quot;Spectrogram \u0026quot; + .baseName$\rSelect inner viewport: 1, 4, 1, 2.15\rPaint: .start, .end, 0, 5000, 100, \u0026quot;yes\u0026quot;, 50, 6, 0, \u0026quot;no\u0026quot;\rAxes: .start, .end, 0, 5000\rMarks left: 6, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;, \u0026quot;no\u0026quot;\rText left: \u0026quot;yes\u0026quot;, \u0026quot;Frequency (Hz)\u0026quot;\rendproc\rThe draw_TextGrid function can be used together with draw_sound or draw_spectrogram to draw the waveform or spectrogram together with the annotation. To change the size of the window, I only need to modify two parameters (.start and .end). I can even write another procedure which draws the pitch of the sound:\nprocedure draw_pitch: .baseName$, .floor, .ceiling, .start, .end\r@smooth_pitch: .baseName$, .floor, .ceiling\rselectObject: \u0026quot;Pitch smooth\u0026quot;\rSelect inner viewport: 1, 4, 1, 2.15\rAxes: 0, .end - .start, 0, .ceiling\rLine width: 3\r#Font size: 14\rColour: \u0026quot;Blue\u0026quot;\rDraw: .start, .end, 0, .ceiling, \u0026quot;no\u0026quot;\rLine width: 1\rColour: \u0026quot;Black\u0026quot;\rMarks right: 4, \u0026quot;yes\u0026quot;, \u0026quot;yes\u0026quot;, \u0026quot;no\u0026quot;\rText right: \u0026quot;yes\u0026quot;, \u0026quot;Pitch (Hz)\u0026quot;\rendproc\rThe procedure even calls another procedure within it. It is this modular design that enables me to do complex things with Praat. The main structure remains highly readable. For example, to draw the waveform, spectrogram, pitch and annotation together, I only need to call these precedures in turn.\n@draw_spectrogram: baseName$, start, end\r@draw_tg: baseName$, start, end\r@draw_pitch: baseName$, floor, ceiling, start, end\rIt is like lego, that we can put simple pieces into amazing things.\nThe structure of a script Most of the Praat scripts are written to do batch tasks. Therefore, a general structure of script can be abstracted.\nTo do a batch job, a script can be decomposed into the following parts:\nan I/O interface to the user: a form in Praat terms; a series of files/directories to be processed: a String in Praat terms; some thing to do to the files/directories: a procedure in Praat terms. People usually write a for loop and put all the things to do within it. This approach is not modular and reproducible. As illustrated in the previous section, to decompose the things to do into clearly-defined steps and wrap them using procedure can be useful. The functionality of a procedure can be easily used by other scripts, and it increases the reusability of codes.\nI included a script_strcture.praat script in this repo. It serves as a template for scripting. Simply add procedures at the end of the script and put them into the for loop. This saves a lot of typing.\nConventions of writing Praat scripts To keep code clean easy to understand, it is good to maintain a consistent style. For R, there is the famous style guide by Hadley Wickham, and for Python, there is PEP 8. I apply some simple conventions to Praat scripting.\nWhen scripting in Praat, I keep some these conventions:\ncamel case for variable names: baseName$; snake case for procedure names: draw_waveform. To keep procedures modular, I use consistent and meaningful variable names across all scripts. Some frequent variables are listed below:\nbaseName$: the name of sound files or TextGrid files without extensions. It\u0026rsquo;s used to refer to objects in Praat editors; extension$: the file extension. It can also be fileList$: the name of the String of file in Praat. Of course you can have your own conventions, but make sure to keep them consistent. For other style options, I always refer to the style guides of R and Python.\nI put some of the scripts I wrote in this repository, and I will keep updating.\nResources of praat scripts Praat Scripting Tutorial; Praat Script Resources; Praat scripts in the NCSU phonetics lab; Using Praat for Linguistic Research. ","permalink":"https://ge-chunyu.github.io/posts/2019-12-praat/","series":[],"tags":["Praat"],"title":"Writing Praat scripts in a modular way"},{"authors":[],"categories":[],"content":"Pandoc是转换文本格式的利器。在用 Pandoc 转换中文文档和生成大型文档时，例如用中文写作毕业论文等时，会遇到一些很麻烦的问题。我在前面的博客里说过我在用 Markdown 写博士毕业论文，这篇博客就我自己的经验讲一下在用 Pandoc 生成大型中文文档的痛点与解决方案。\nPandoc 将 Markdown 生成 pdf 的逻辑 用 Pandoc 将 Markdown 文件生成 pdf，其实是先把 Markdown 格式转换成 LaTeX 格式，再通过 LaTeX 把转换后的 LaTeX 文件生成最终的 pdf 文件。在用 LaTeX 生成 pdf 时，可以指定不同的--pdf-engine，可选的选项有pdflatex、xelatex、lualatex等。\n因为 Pandoc 是通过 LaTeX 来生成 pdf 文件的，所以可以通过修改或添加 LaTeX 源文件来修改最终的 pdf 格式。如果不怕麻烦，可以先用 Pandoc 把 Markdown 文件转换成 LaTeX，再在上面自己改格式。\npandoc --standalone test.md -o test.tex\r但是，一般的做法是通过给 Pandoc 传递 LaTeX 命令和 Pandoc 自带的参数来修改 pdf 格式的。当然，也可以直接在 Pandoc 的 pdf template 上进行修改。不过 Pandoc 自带的 template 很复杂，一般用--header-includes给自带的 template 加上需要的 LaTeX 命令就可以了。\n另外，Pandoc 自身也提供来一些可以自定义的参数，这些参数一般是在文件开头用 yaml 写的，Pandoc 将这些参数称作“metadata”。所以在用 Pandoc 生成一个自定义格式的大型 pdf 文档时，除了文本文档外，还需要准备preable.tex与metadata.yaml两个文件，分别用来自定义 LaTeX 与 Pandoc 自带的参数。\n用 Pandoc 生成中文 pdf 要在 Pandoc 生成的 pdf 里显示中文，跟在 LaTeX 里显示中文的逻辑一样，一般用ctex包或xeCJK包就可以了。不过不建议用ctex包，因为它除了显示中文外还定义了太多其他格式。不如直接用xeCJK来显示中文，再直接用 LaTeX 提供的其他包来指定其他格式。\n用pandoc来生成中文 pdf 时，需要将默认的--pdf-engine改成xelatex：\npandoc --pdf-engine=xelatex test.md -o test.pdf\r用pandoc生成大型文档 在用 LaTeX 写作大型文档时，可以用\\include{}来包含单个文件。在用Markdown写大型文档时，用Pandoc将多个Markdown文件转换成一整个文件时，可以将文件名按顺序放在pandoc命令中进行转换。必须注意的是，要保证生成的文件是按需要的顺序出现的，需要把Markdown文件按照顺序命名，例如第一章的文件名是1.md，第二章为2.md等。\npandoc --pdf-engine=xelatex 1.md 2.md 3.md -o main.pdf\r在用这个命令生成大型文档的时候，可能会出现后一个文件变成前一个文件一部分的情况。要避免出现这种情况，必须在每个文档文本后加一个空行。\n另外一个问题是，在Markdown中的标题用pandoc生成默认是不编号的。要给标题编号，需要在yaml文件中加上以下这行。\nnumbersections: true\r在用单个Markdown文件写作文章时，可以把yaml参数加在文本上方；但在用多个Markdown文件写作时，最好将yaml参数单独保存成一个文件，在pandoc命令中以--metadata-file来指定该文件就可以了。\npandoc --pdf-engine=xelatex --metadata-file=metadata.yaml 1.md 2.md 3.md -o main.pdf\r交叉引用 写作大型文档时，尤其是技术或学术文档时，难免要对图表、公式、章节等进行交叉引用。Pandoc 本身提供了对不同部分进行交叉引用的功能。\nPandoc 本身并没有提供对图表进行交叉引用的功能。要实现这种功能，可以用过滤器--filter来实现。在MacOS上，可以用pandoc-crossref来处理图表、公式的编号与交叉引用；在Windows平台上，对图片、表格、公式的交叉引用可以分别用pandoc-tablenos、pandoc-fignos、pandoc-eqnos来实现。这几个过滤器可以用以下表格中的命令来安装1。\nfilter OS installation pandoc-crossref MacOS brew install pandoc-crossref pandoc-tablenos Windows pip install pandoc-tablenos pandoc-fignos Windows pip install pandoc-fignos pandoc-eqnos Windows pip install pandoc-eqnos 在 Pandoc 中使用过滤器只要用--filter参数指定所要用的过滤器即可。这几个过滤器的使用逻辑都是一致的，可以设置的参数包括图表标题前缀（tableTitle或figureTitle等）、文中引用前缀(tabPrefix或figPrefix)等。其他具体参数可以参考各自的说明文档。\n至此，Pandoc 命令就变成了以下这样（以 MacOS 为例）：\npandoc --pdf-engine=xelatex --filter pandoc-crossref --metadata-file=metadata.yaml 1.md 2.md 3.md -o main.pdf\r章节目录 在 LaTeX 中要对特定的标题不编号，可以用\\chapter{}等命令中加*来实现。Pandoc 也提供了这种功能。对于不想编号的标题，标题后面加上{-}或者{.unnumbered}就可以。\n要在生成的文件中自动生成目录，只需要将toc这一参数指定为true就可以。文档中包含的表格与图片等也可以自动生成目录，分别将lot和lof指定为true就可以了。但是，在 Pandoc 里可以指定目录的标题，例如toc-title: 目录，但是表格目录与图片目录的标题没法指定。这个问题可以用 LaTeX 来解决，只要在 LaTeX head 里指定表格目录与图片目录标题就行了：\n\\renewcommand\\listtablename{表\\ 格\\ 目\\ 录}\r\\renewcommand\\listfigurename{图\\ 片\\ 目\\ 录}\r在用 LaTeX 定义章节等标题格式时，经常会用到titlesec这一 LaTeX 包。但是，在head里指定了这个包之后，运行 Pandoc 会出现这样的错误信息：\nError producing PDF.\r! Argument of \\paragraph has an extra }.\r\u0026lt;inserted text\u0026gt; \\par l.1628 \\ttl@extract\\paragraph\r要解决这个问题，必须在yaml文件里加上subparagraph: yes这一行。\nyaml文件参数与含义 前面涉及到了很多yaml文件里的参数。这里将常见的yaml参数条列如下，并简单说明各自的作用。\ntitle: 标题 # 指定标题\rauthor: 作者 # 指定作者\rnumbersections: true # true 表示给文中的部分编号，默认值为 false\rsubparagraph: yes # 要在 LaTeX head 里用 titlesec 这个包，必须加这一行\rfontsize: 12pt # 指定字号大小，默认接受10pt、11pt、12pt\rtoc: true # 生成目录\rtoc-title: \u0026quot;目录\u0026quot; # 指定目录标题\rlot: true # 生成表格目录\rlof: true # 生成图片目录\rtableTitle: \u0026quot;表\u0026quot; # 表格标题的前缀，pandoc-crossref 与 pandoc-tablenos 中可用\rfigureTitle: \u0026quot;图\u0026quot; # 图片标题的前缀，pandoc-crossref 与 pandoc-fignos 中可用\rtabPrefix: \u0026quot;表\u0026quot; # 文中对表格引用的前缀，pandoc-crossref 可用\rfigPrefix: \u0026quot;表\u0026quot; # 文中对图片引用的前缀，pandoc-crossref 可用\rheader-includes: # 要加进 LaTeX文件的命令，建议放在一个单独的 preamble 文件里\r其他 Pandoc 资料 网上有很多其他非常好的 Pandoc 资料，例如：\nCustomizing pandoc to generate beautiful pdfs from markdown Generating Beautiful PDF from Markdown with Pandoc and Sublime Text 在Windows里的两个过滤器都是用Python的包管理器pip来装的。所以要装这两个过滤器，要先装Python。除了这里给的命令之外，还可以用python -m pip install packageName来装python第三方包。关于pip install与python -m install的差别，参见https://snarky.ca/why-you-should-use-python-m-pip/。\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://ge-chunyu.github.io/posts/2019-11-pandoc-large-document/","series":[],"tags":["Pandoc"],"title":"用pandoc生成大型中文文档的痛点与解决方案"},{"authors":[],"categories":[],"content":"I am writing my PhD thesis and instead of using LaTeX, I want to write it in markdown together with Pandoc. This has several merits. I can easily transform the markdown file to docx for my supervisor to revise. It can also easily be transformed to pdf files through LaTeX. However, the default pdf output doesn\u0026rsquo;t conform to the format my school requires. What I am going to do is to customize the pdf format to meet the standard of my school.\nThere is another problem in customizing the pdf output. Since I write the thesis in Chinese, how to modify the fonts and other character-related features does not seem to be obvious. To customize the format of the bibliography is an even greater problem.\nAs a matter of fact, there are two ways to customize the pdf output of Pandoc. The first is using a LaTeX template. Another is to use the --header option in the Pandoc command. I will concentrate on the latter approach and maybe a later post will deal with the first.\nThe format My graduate school does not specify strictly every detail of the format. The main requirements are :\nThe font size of the main matter is 10.5 point, or in No.5 (五号字); The margin for the paper is 2.54 cm for top and bottom, and 3.17 cm for left and right; The space of the main matter is 20 pound; The font of the Chapter and Section header is in Heiti（黑体） and the number in Chinese character; The font of the Subsection and below is in Kaishu (楷书) and the number in arabic number; The footnote is in the format of ①, ②, and is numbered by page. The font size of footnote is 9 point; The font size of the captions of figures and tables is 9 point. The requirements are not too detailed, so I think a preamble file will suffice.\nGeneral format The setting of the general format is straightforward. I will use geometry to set the page margin and setspace for line spacing.\nPage margin To set the page margin, simply use the package geometry and add the corresponding command in the preamble part.\n\\usepackage{geometry}\r\\geometry{top=2.54cm, bottom=2.54cm, left=3.17cm, right=3.17cm}\rThis sets the margin for top and bottom to 2.54cm, and 3.17cm for left and right.\nLine spacing Set line spacing is also straightforward using the setspace package.\n\\usepackage{setspace}\r\\linespread{1.5}\rThe format of chapters and sections The general format of chapters and sections can be customized using the titlesec package.\n\\titleformat{\\chapter}{\\centering\\Large\\heiti}{第\\zhnum{chapter}章}{1em}{}\r\\titleformat*{\\section}{\\centering\\Large\\heiti}\r\\titleformat*{\\subsubsection}{\\kaiti}\rThe above commands set the font of chapters and sections to \\heiti(黑体) and that of subsubsections to \\kaiti.\n\\renewcommand\\thesection{第\\zhnum{section}节}\r\\renewcommand\\thesubsection{\\zhnum{subsection}、}\r\\renewcommand\\thesubsubsection{（\\zhnum{subsubsection}）}\rFont The xeCJK package provides the support of font for Chinese characters. The fonts I need are Heiti and Kaiti, while SimSun is chosen as the main font. To achieve these, I first set the main font for CJK characters to SimSun.\n\\usepackage{xeCJK}\r\\setmainfont{Times New Roman}\r\\setCJKmainfont{SimSun}\rI also set the font for Roman alphabets to Times New Roman using the function \\setmainfont provided by the fontspec package. Note that I didn\u0026rsquo;t import the package explicitly, since it is refered in the xeCJK package.\nA more serious problem is to specify font for some of the text while not affecting the main font. In this case, xeCJK has a function \\setCJKfamilyfont, and I use it to define a command that specify the text included in the braces.\n\\newcommand{\\kaiti}{\\setCJKfamilyfont{kaiti}{KaiTi} \\CJKfamily{kaiti}}\r\\newcommand{\\heiti}{\\setCJKfamilyfont{heiti}{SimHei} \\CJKfamily{heiti}}\rI defined \\kaiti and \\heiti based on the built-in font of xeCJK. To specify the font of any text, simply put it in the brace as a plain LaTeX command: \\kaiti{楷体} or \\heiti{黑体}.\nFootnote To number footnote by page, I use the option perpage in the footmisc package.\n\\usepackage[perpage]{footmisc}\rTo mark footnotes with circled numbers, I searched online and found the pifont package provides such symbols. What I have to do is to redefine the \\footnote command such that it uses the circled numbers.\n\\usepackage{pifont}\r\\renewcommand{\\thefootnote}{\\ding{\\numexpr171+\\value{footnote}}\rThe pifont package provides a lot of symbols, which can be viewed on its quick reference. To use other symbols, simply change the number corresponding to the symbol.\nThe font size Since the requirement of the format is mixed (It uses Number for body and headings, but points for footnotes and captions), I will use 11pt to approximate No.5 font size in Chinese. Using this specification, 9pt can be defined using the \\footnotesize command, and No.2 size (21pt) can be defined using the \\huge command. As for the size of captions, I use the caption package.\n\\usepackage{caption}\r\\captionsetup{font=footnotesize}\rOutput to pdf using pandoc To put it all together and store the settings in a file named preable.tex, the markdown file can be output to pdf files in the desired form using pandoc.\npandoc --pdf-engine=xelatex -H preamble.tex thesis.md -o thesis.pdf\rWhen running the command, an error occured:\nError producing PDF.\r! Argument of \\paragraph has an extra }.\r\u0026lt;inserted text\u0026gt;\r\\par\rl.1628 \\ttl@extract\\paragraph\rI searched and this post in Stack Overflow solves the problem. Simply add subparagraph: yes to the header of the markdown file, and the pdf file can be generated. Another tip is to add numbersections: true to the header to automatically generate numbered sections.\nTo do Despite all these effort, another serious problem remain untouched. Citation and bibiliography. To simply cite and generate bibliography in LaTeX is effortless through BibTex. But to generate bibliography in desired Chinese format is a hard problem. I will explore this question later on.\nIn fact, I do have a good idea on how to solve this problem. Pandoc provides a powerful tool called csl. To generate bibliography in Chinese format, there are three files to choose from:\nchinese-gb7714-1987-numeric.csl; chinese-gb7714-2005-numeric.csl; chinese-gb7714-2005-author-date.csl. I can follow this line, but the output is not so satisfying, and I decided to do some research in native LaTeX on how people solve this problem.\n","permalink":"https://ge-chunyu.github.io/posts/2019-10-customizing-pdf/","series":[],"tags":["Latex","Pandoc"],"title":"Customizing pdf output of Pandoc"},{"authors":[],"categories":[],"content":"I want to do some text mining practices on the texts of Luxun(鲁迅), a great Chinese writer. The first step is to get all the texts by Luxun, and I have no time typing all the texts word by word. So I decided to srape the texts from an online source.\nSource of the texts The texts of Luxun are scraped from 子夜星网. As it claimed, it contains all the texts in the Complete works of Luxun(鲁迅全集). I checked it, and so it did.\nGet the urls and titles of all the articles The process starts at getting the contents and the urls of the text of Luxun from the parent url http://www.ziyexing.com/luxun/. To access all the urls, I constructed a regular expression and selected all a nodes that share the pattern.\nhomepage_res = requests.get(\u0026quot;www.ziyexing.com/luxun/\u0026quot;)\rhomepage_soup = BeautifulSoup(res.text, \u0026quot;html.parser\u0026quot;)\rhref_re = re.compile(r\u0026quot;luxun_\\w+_\\w+_\\d+.htm\u0026quot;)\rhrefs = homepage_soup.find_all(\u0026quot;a\u0026quot;, {\u0026quot;href\u0026quot;:href_re})\rIt is found that although the regular expression covers most of the patterns, some urls are idiosyncratic and do not conform to the regex. I constructed another regex.\nothers_re = re.compile(r\u0026quot;(zhunfengyuetan)|(gushixinbian)|(gujixubaji)|(zgxssl)|(luxun_shici)\\w+\u0026quot;)\rother_hrefs = homepage_soup.find_all(\u0026quot;a\u0026quot;, {\u0026quot;href\u0026quot;:others_re})\rIt is, of course, idiosyncratic, but effective. To use two regexes, I have got all the urls.\nlinks = [href.attrs[\u0026quot;href\u0026quot;] for href in hrefs]\rother_links = [line.attrs[\u0026quot;href\u0026quot;] for line in other_hrefs]\rThe title of each url can also be accessed in the a nodes. It can easily accessed using a.text, yet another problem appeared. The most notorious problem in dealing with non-Latin alphabet languages, especially Chinese, is the problem of encoding. When applying a.text, the characters did not show normally. I am fortunately enough to have recently learnt that the encoding of an html page can be seen from the header of the page. I checked it and found that the page is encoded using gb2312. To make the texts return to normal requires encoding in Latin1 and subsequently decoding in gb2312. gbk, as a superset of gb2312, works better in decoding.\ntitles = [href.text.encode(\u0026quot;latin1\u0026quot;).decode(\u0026quot;gbk\u0026quot;) for href in hrefs]\rother_titles = [line.text.encode(\u0026quot;latin1\u0026quot;).decode(\u0026quot;gbk\u0026quot;) for line in other_hrefs]\rHave got all the urls and corresponding titles, I can proceed to the next step, to scrape all the articles. A brief inspection of the article page show that all the contents of the article are embedded in the p node with property line-height: 150%. A further inspection of other pages show that the line-height can also be 130%. So another regex is needed here.\nps_re = re.compile(r\u0026quot;line-height: 1\\d0%\u0026quot;)\rGet the texts Put all the pieces together, I wrote several functions to make the process modular and easy to understand.\nThe get_soup function accesses the given url and returns the BeautifulSoup object.\ndef get_soup(base_url, url):\rres = requests.get(base_url + url)\rsoup = BeautifulSoup(res.text, \u0026quot;html.parser\u0026quot;)\rreturn soup\rThe get_ps function accepts the soup object and outputs the p nodes, which contain the texts.\ndef get_ps(soup):\rps_re = re.compile(r\u0026quot;line-height: 1\\d0%\u0026quot;)\rps = soup.find_all(\u0026quot;p\u0026quot;, {\u0026quot;style\u0026quot;:ps_re})\rreturn ps\rThe clean_text function accepts the p nodes and outputs the cleaned text.\ndef clean_text(texts):\rtexts_decoded = [text.encode(\u0026quot;latin1\u0026quot;, \u0026quot;ignore\u0026quot;).decode(\u0026quot;gbk\u0026quot;, \u0026quot;ignore\u0026quot;) for text in texts]\rtexts_decoded = [text.strip() for text in texts_decoded]\rcleaned_texts = [text for text in texts_decoded if text != \u0026quot;\u0026quot;]\rreturn cleaned_texts\rThe write_text function writes the text data in txt fromat in a file named after the title of the article.\ndef write_text(clean_text, titles, n):\rwith open(\u0026quot;luxun/\u0026quot; + titles[n].strip() + \u0026quot;.txt\u0026quot;, \u0026quot;w\u0026quot;, encoding=\u0026quot;utf8\u0026quot;) as file:\rfile.write(\u0026quot;\\n\u0026quot;.join(clean_text))\rTo wrap all these function together, I wrote a main function which do all these stuff at once.\ndef main(links, titles):\rfor i in range(len(links)):\rsoup = get_soup(base_url, links[i])\rps = get_ps(soup)\rtexts = ps[0].text.split(\u0026quot;\\n\u0026quot;)\rcleaned_texts = clean_text(texts)\rwrite_text(cleaned_texts, titles, i)\rtime.sleep(3)\rTo avoid too much traffic for the site, I used the time.sleep function to pause for three seconds between urls.\nRunning the main() function, and I got all the articles posted on 子夜星网 by Luxun in one folder.\nKey points There are some traps in this toy project, some of which are interesting. I list some key points below.\nUse a regex to capture the pattern of the desired urls; If a regex can not exhaust the pattern, write another one; Look for encoding schemes in the header of html files; Latin-1 works great for Chinese characters! Use text.encode('latin1').decode('gbk'). ","permalink":"https://ge-chunyu.github.io/posts/2019-10-12-scraping-luxun/","series":[],"tags":["Python","Web-Scraping"],"title":"Scraping all the texts of Luxun(鲁迅) from the Internet using Python (用Python爬取《鲁迅全集》)"},{"authors":[],"categories":[],"content":"This post explains how to write academic papers using Sublime Text 3 in markdown format and transform the .md file into .docx and pdf files using pandoc.\nPrerequisites To write academic papers in markdown format requires a markdown editor, a format trnasformer, maybe also a literature manager. I use Sublime Text 3 as the markdown edit, Pandoc as the format transformer, and Zotero as the literature manager. This section lists the things we need.\nSublime Text 3 and plugins Sublime Text 3 is a text editor that can be used for code, markup and prose. It is lightweight and is suitable for long texts. The followings are several plugins (or packages) we need:\nMarkdownEditing: writing markdown in Sublime Text 3; MarkdownPreview: previewing markdown in the browser; SmartMarkdown: folding and unfolding Headings; Citer: citing from a bibtex file; AcademicMarkDown: highlighting citations and CriticMarkup; WordCount: counting words and characters; CriticMarkup: highlighting revisions (e.g. add, delete, substitute, and comment). To install packages in Sublime Text 3, first install Package Control (go to Preferences -\u0026gt; Install Package Control). Use Ctrl+Shift+P to activate the package control palatte, type Install Packages, select and then enter the names of whatever packages you want to install.\nPandoc Pandoc is a powerful tool for transforming file formats. Installing it on windows by downloading the .exe file or installing it in MacOS by simply typing brew install pandoc and brew install pandoc-cite-proc in the Terminal (given that you have installed HomeBrew).\nUsage This section explains how 1) to use Sublime Text 3 to complete tasks like adding citations, 2) to tranform .md files to .docx and pdf files.\nSublime Text 3 and plugins It is common tasks to add citations, insert tables, and insert figures when writing academic papers. Sublime Text 3, along with various packages, provides us with powerful tools to compelete such tasks.\nAdding citations use Citer Once we have installed Citer via Package Control, we can modify the settings of Citer. Add the following lines into the user settings (Preferences -\u0026gt; Package Settings -\u0026gt; Citer -\u0026gt; Citer Setting-User), and change the \u0026ldquo;bibtex_file_path\u0026rdquo; parameter according to the path of your bibtex files. Multiple bibtex files can be add to the bibtex_file_path separated by a comma and surrounded with brackets ([]).\n{\r//REQUIRED:\r\u0026quot;bibtex_file_path\u0026quot;: \u0026quot;your bibtex path\u0026quot;,\r//OPTIONAL:\r//By default Citer Search looks for your keyword in the //author, title, year, and Citekey (id) fields\r\u0026quot;search_fields\u0026quot;: [\u0026quot;author\u0026quot;, \u0026quot;title\u0026quot;, \u0026quot;year\u0026quot;, \u0026quot;id\u0026quot;] ,\r//Default format is @Citekey\r\u0026quot;citation_format\u0026quot;: \u0026quot;@%s\u0026quot;,\r//list of scopes. Could be top level \u0026quot;text\u0026quot; or \u0026quot;source\u0026quot;, or limit to\r// e.g \u0026quot;text.html.markdown\u0026quot;\r\u0026quot;completions_scopes\u0026quot;: [\u0026quot;text\u0026quot;],\r\u0026quot;enable_completions\u0026quot;: true\r}\rSave the setting file. Type Ctrl-Shift-P and the Package Control palette pops up. Type show all, and select the command Citer: Show all, all the entries in the bibtex files should pop up. Select the entry you would like to cite, and press Enter. The entry appears in the file in this form @author1990 (@authorYear).\nPandoc Use Pandoc is easy and to modify the templates is rather challenging, especially if you wish to modify the LaTeX template. It implies that you know fairly well about LaTeX. To make Pandoc compatible with Chinese characters is another challenging task. Pandoc is a command line tool, so make sure you enter all the commands in the terminal (or cmd in Windows)\nTransformation between .md, .docx, and pdf files Transforming .md files into .docx and .pdf files is straightforward. Go to the path where your .md files are, and type in the following commands:\ncd path # change directory to where your md files are pandoc file.md -o file.pdf # md -\u0026gt; pdf\rpandoc file.md -o file.docx # md -\u0026gt; docx\rAdding references Adding references to a markdown file is also straightforward, simply use the pandoc-citeproc program, and specify the path of the bibtex file:\n# md -\u0026gt; pdf\rpandoc --filter pandoc-citeproc --bibliography=file.bib file.md -o file.pdf\r# md -\u0026gt; docx\rpandoc --filter pandoc-citeproc --bibliography=file.bib file.md -o file.docx\rUsing templates You can output .md files to .docx and pdf files with various formats by modifying the default templates (Please also refer to the Pandoc User\u0026rsquo;s Guide).\nModify the default docx template To modify the default docx template, first print the default dicx template used by Pandoc with the following command:\npandoc --print-default-data-file reference.docx \u0026gt; custom-reference.docx To modify the default docx reference file, it does not work to simply change the style of the contents. Rather, define the styles you would love to use in the Style options provided by MS Word.\nTo use the sepcifies reference file:\npandoc file.md -o file.docx --reference-doc=custom-reference.docx\rModify the default LaTeX template Make pandoc compatible with Chinese (Pandoc的中文输出) To make pandoc compatible with Chinese, we have to specify the pdf engine and the font (this is not required when transforming to .docx):\npandoc --pdf-engine=xelatex -V mainfont=\u0026quot;SimSun\u0026quot; file.md -o file.pdf To use whatever font you like, type in the font name after mainfont=. To know what fonts you have in your laptop, type fc-list :lang=zh in Windows cmd, or look up in Font Book in MacOS.\nThere is another serious problem with Chinese pdf files created with pandoc. It cannot automatically change line. So a Chinese pdf file simply spans beyond the range of the current file. To overcome this problem, we need to modify the default LaTeX template.\n","permalink":"https://ge-chunyu.github.io/posts/2019-10-11-sublime-pandoc/","series":[],"tags":["Pandoc","Sublime Text"],"title":"Writing academic papers using Sublime Text 3 + Pandoc"},{"authors":[],"categories":[],"content":"希腊的盲诗人荷马写下了《伊利亚特》，以阿喀琉斯的愤怒为线索，讲述了特洛伊战争最后一年的战况；而这场战争是由美女海伦引起的。在同一时期的中国，著名的盲人史学家左丘明也记录了数场由美女夏姬引发的战役，而以申公巫臣的愤怒为线索。在此之前，还有详细的背景交代，充满戏剧色彩，称得上是《左传》中最惊心动魄的故事之一。\n《左传》中最早说到夏姬，是在宣公九年：\n陈灵公与孔宁、仪行父通于夏姬，皆衷其衵服，以戏于朝。\n三个人都露出夏姬做的内衣，还相互打趣。泄冶看不下去，勇敢进谏，献出了宝贵的生命。\n到了宣公十年：\n陈灵公与孔宁、仪行父饮酒于夏氏。公谓行父曰：“征舒似女。”对曰：“亦似君。”征舒病之。公出，自其厩射而杀之。二子奔楚。\n这三位与夏姬通奸，不以为耻，反以为荣，还拿夏姬的二子夏征舒开玩笑。夏征舒受不了，就只好弑君了。剩下那两位居然就吓得逃到了楚国。不过，弑君也不是小事，孔宁、仪行父跑到楚国，楚王也不能没有表示，到了宣公十一年：\n楚子为陈夏氏乱故，伐陈……杀夏征舒……纳公孙宁、仪行父于陈。\n后面还有史臣的评价：“书，有礼也。”\n到了成公二年，左丘明开始回忆这一场战役产生的后果：\n庄王欲纳夏姬，申公巫臣曰：“不可……今纳夏姬，贪其色也。贪色为淫，淫为大罚……”王乃止。\n楚庄王也想纳夏姬。这时，申公巫臣跳出来说不行，还讲了一通大道理。楚王就作罢了。一般人肯定以为这个申公巫臣是个好人，但事实并非如此。古人说：“周公恐惧流言日，王莽谦恭未篡时。”且看下文：\n子反欲取之，巫臣曰：“是不祥人也。……人生实难，其有不获死乎？天下多美妇人，何必是？”子反乃止。\n巫臣既阻止了楚王纳夏姬，又不让子反娶夏姬，而且用的都是极其冠冕堂皇的理由。然而，这样就结束了吗？并不：\n王以予连尹襄老，襄老死于邲。其子黑要烝焉。\n楚王把她给了连尹襄老，而连尹襄老也果然在邲之战中战死了，连尸体都找不到。而与此同时，襄老的儿子也跟夏姬通奸了（下淫于上谓之烝）。\n此时巫臣又出场了。他自告奋勇为夏姬找她丈夫的尸体：\n……使自郑召之曰：“尸可得也，必来逆之。”\n尸体找得到，但是得夏姬亲自来才行：“（夏姬）将行，谓送者曰：“不得尸，吾不反矣。”与此同时，巫臣也有了进一步动作：“（共王）使巫臣聘于齐，巫臣尽室以行。”\n不过是聘于齐，为什么要举家前往呢？于是巫臣的儿子申叔就跪在地上，请求跟从，道出了其中玄机：“夫子有三军之惧，而又有桑中之喜，宜将窃妻以逃者也。”\n知父莫若子啊！申叔一下就说出来关键：桑中之喜。桑中是《诗经·卫风》中的篇名，“期我乎桑中，要我乎上宫，送我乎淇之上矣！”郑卫之声淫，明明是一首淫奔之曲。于是巫臣就带着夏姬走了。\n夏姬的故事基本上就结束了。与夏姬有染的男人有：陈灵公、孔宁、仪行父、襄老、襄老的儿子黑要、巫臣；而想要和她有染的有：楚王，子反。这只是《左传》中记载了的，没有记载的更不知凡几，真可称得上是“人尽可夫”了（这又是《左传》里的典故）！在这里面，巫臣为了和夏姬在一起，真可谓是费尽了心思。先是用冠冕堂皇的理由阻止了楚王和子反，再又是等到襄老死了（这件事巫臣或许也与有力焉？）之后又极其高尚地主动为夏姬找寻丈夫的尸骨。末了，还申请聘于齐，终于与夏姬比翼双飞。通过巫臣的所作所为，不难发现：这才是真爱啊！！\n可以想象一下楚王、子反知道这件事的反应，恐怕是再怎么震惊都不为过的。可惜楚王早就死了，子反却活到了这会儿。知道这件事后，子反开始谋划报复巫臣。正巧子重与巫臣也有郤。邲之战的时候，子重请求楚王封赐申、吕，被巫臣坏了好事，自然怨恨巫臣。二人一拍即合。于是杀了巫臣在楚国的同族子阎、子荡，顺带把黑要也杀了。随即就“而分其室”，把他们的老婆给分了。\n巫臣得知这件事后，当然非常愤怒。不过，他终究不是阿喀琉斯，即便在这时，还有清醒的意识，写了封信给他们：“尔以谗慝，贪婪事君，而多杀不辜，余必使尔罢于奔命而死！”\n巫臣的复仇计划异常完美，但也引发了严重的后果，甚至影响到了自此之后春秋时期的历史。他的计划是使吴国强大，征伐楚国（这和伍子胥的复仇计划多么相像！就连复仇对象和复仇所依托的国家都一样！）。后果是：“吴始伐楚、伐巢、伐徐，子重奔命，马陵之会，吴入州来，子重自郑奔命。子反、子重于是一岁七奔命。”\n巫臣的确使他们罢于奔命了。但还有另外的、更大的影响：“蛮夷属于楚者，吴尽取之，是以始大，通吴于上国。”正是吴的崛起，影响了之后春秋的历史。\n而子反、子重二人的结局呢？子反死于成公十六年楚国与晋国的鄢陵之战，而子重更是因与吴国作战失利：“楚人以是咎子重，遂遇心疾而卒。”\n由夏姬一个女人，竟然最后影响了整个春秋的历史，将其比为海伦毫不为过；而巫臣的愤怒引起了吴国的崛起，比为阿喀琉斯也毫不逊色。\n","permalink":"https://ge-chunyu.github.io/posts/2013-08-04-illiad-of-china/","series":[],"tags":["History"],"title":"中国的《伊利亚特》"}]